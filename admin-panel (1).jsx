import { useState, useRef } from "react";

const LOGO_ICON_BASE64 = "data:image/jpeg;base64,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";
const LOGO_BASE64 = "data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADaBbcDASIAAhEBAxEB/8QAHAABAAIDAQEBAAAAAAAAAAAAAAYHAwQFAgEI/8QAUhAAAQMDAQQDCgoGBwcFAAMAAQACAwQFEQYSITFBE1FxBxQiNWGBkaGxshYyUlRyc3SSwdEVI0Ji4fAIMzQ2U5PCJCVDRIOi8RdVgpTSVmNk/8QAGwEBAAMBAQEBAAAAAAAAAAAAAAMEBQECBgf/xAA4EQACAgIAAwUGBQMDBQEAAAAAAQIDBBESITEFEzNBUSIyYXGBsQYUkaHRI8HwFjThFUJSU2Lx/9oADAMBAAIRAxEAPwD8ZIiIAiIgCIiAIiIAiIgCIstPBNUSBkET5HHk0ZRLZxvXUxIpFbtL1Ejg6tkELObW73LrT6atr6cRsa+J4Hx9rJPaFYji2SW9FWebVF63sg6Ls3LTtdS5fEBUR9bOI8y47muY4tc0tI4ghRThKD1JFiFkbFuL2fERF4PYREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAERdS32OvrMOERijP7b925eowlJ6SPM5xgtyejlrcoLbW1p/2eBzm5xtHcPSpZbtOUFMA6YGeQb8u+L6F12NZGwMYNloG4AYCuV4bfObM+3tBLlBEdt+l4WFr6yXpSN5YzcPSu/TQwU8exTwsibjg0Yysp49aK7CqEPdRn2XTs95nzgvvAL4UPHG9eyI+k+latfbqKtae+IGOPyxuPpWyi40mtM6pOL2iKXHS0rCX0MnSD5D9x9Kj9TTT0z9ieJ8bv3grM4Z6l4nhhqIzHPEyRp5OCq2YcX7vIvVZ848p8ysUUvuOl6eTL6KUxO+S7e1RyvttbROIngcGj9ob2+lUrKJw6o0asmuzozTREUJOEREAREQBdTTNugude+Cd0jWtiLwWEA5yBzB61y1IdB+OJfs595qmx4qVsUyO1tQbRpamt0Fsr2QQOkc10QeS8gnOSOQHUuWpDrzxxF9nHvOUeTIio2ySFTbgmwiIoSQIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiIAiIgCIiAIiI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IiK+ZwREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREAREQBERAEREB/9k=";


// ═══════════════════════════════════════════
// THEME — Admin uses same palette as student app
// ═══════════════════════════════════════════
const C = {
  bg: "#f0f2f5", white: "#ffffff", card: "#ffffff",
  primary: "#2563eb", primaryDark: "#1d4ed8", blue50: "#eff6ff", blue100: "#dbeafe",
  green: "#16a34a", greenBg: "#dcfce7", red: "#dc2626", redBg: "#fee2e2",
  orange: "#ea580c", orangeBg: "#fff7ed", purple: "#7c3aed", purpleBg: "#f3e8ff",
  teal: "#0d9488", tealBg: "#ccfbf1",
  gray50: "#f9fafb", gray100: "#f3f4f6", gray200: "#e5e7eb", gray300: "#d1d5db",
  gray400: "#9ca3af", gray500: "#6b7280", gray600: "#4b5563", gray700: "#374151",
  gray800: "#1f2937", gray900: "#111827",
  sidebarBg: "#111827", sidebarHover: "#1f2937", sidebarActive: "#2563eb",
};

// ═══════════════════════════════════════════
// SAMPLE DATA — simulates Supabase responses
// ═══════════════════════════════════════════
const SUBJECTS = [
  { id: 1, name: "Physics", code: "PHY" },
  { id: 2, name: "Chemistry", code: "CHE" },
  { id: 3, name: "Mathematics", code: "MAT" },
  { id: 4, name: "Biology", code: "BIO" },
];

const CHAPTERS = {
  1: ["Kinematics", "Laws of Motion", "Work Energy Power", "Gravitation", "Optics", "Current Electricity", "Electrostatics", "Magnetism", "Modern Physics", "Thermodynamics", "Waves"],
  2: ["Chemical Reactions", "Chemical Bonding", "Ionic Equilibrium", "Mole Concept", "Periodic Table", "Organic Chemistry", "Electrochemistry", "Solid State"],
  3: ["Differentiation", "Integration", "Matrices", "Conic Sections", "Limits", "Probability", "Trigonometry", "Algebra", "Vectors & 3D"],
  4: ["Cell Biology", "Genetics", "Ecology", "Human Physiology", "Plant Physiology", "Biotechnology", "Evolution"],
};

const INITIAL_QUESTIONS = [
  { id: 1, subject_id: 1, chapter: "Kinematics", difficulty: "medium", question_text: "A ball is thrown vertically upward with velocity 20 m/s. Find the maximum height.", option_a: "10m", option_b: "20m", option_c: "30m", option_d: "40m", correct_option: 1, solution: "h = u²/2g = 400/20 = 20m", status: "active" },
  { id: 2, subject_id: 1, chapter: "Optics", difficulty: "easy", question_text: "The phenomenon of splitting of white light into seven colours is called?", option_a: "Reflection", option_b: "Refraction", option_c: "Dispersion", option_d: "Diffraction", correct_option: 2, solution: "Dispersion is the splitting of light.", status: "active" },
  { id: 3, subject_id: 2, chapter: "Chemical Reactions", difficulty: "easy", question_text: "Which gas is evolved when zinc reacts with dilute HCl?", option_a: "Oxygen", option_b: "Chlorine", option_c: "Hydrogen", option_d: "Nitrogen", correct_option: 2, solution: "Zn + 2HCl → ZnCl₂ + H₂↑", status: "active" },
  { id: 4, subject_id: 2, chapter: "Periodic Table", difficulty: "medium", question_text: "Which of the following is an alkaline earth metal?", option_a: "Sodium", option_b: "Potassium", option_c: "Calcium", option_d: "Aluminium", correct_option: 2, solution: "Calcium belongs to Group 2.", status: "active" },
  { id: 5, subject_id: 3, chapter: "Differentiation", difficulty: "medium", question_text: "Derivative of sin(2x) is?", option_a: "cos(2x)", option_b: "2cos(2x)", option_c: "-2cos(2x)", option_d: "2sin(2x)", correct_option: 1, solution: "d/dx sin(2x) = 2cos(2x)", status: "active" },
  { id: 6, subject_id: 3, chapter: "Limits", difficulty: "hard", question_text: "lim(x→0) sin(x)/x equals?", option_a: "0", option_b: "1", option_c: "∞", option_d: "Does not exist", correct_option: 1, solution: "Standard limit = 1", status: "active" },
  { id: 7, subject_id: 1, chapter: "Laws of Motion", difficulty: "hard", question_text: "A 5kg block on a frictionless surface is pulled by 10N force. Acceleration?", option_a: "1 m/s²", option_b: "2 m/s²", option_c: "5 m/s²", option_d: "10 m/s²", correct_option: 1, solution: "F=ma → a=10/5=2 m/s²", status: "active" },
  { id: 8, subject_id: 2, chapter: "Organic Chemistry", difficulty: "hard", question_text: "IUPAC name of CH₃CHO is?", option_a: "Methanal", option_b: "Ethanal", option_c: "Propanal", option_d: "Methanol", correct_option: 1, solution: "CH₃CHO = Ethanal (acetaldehyde)", status: "active" },
];

const INITIAL_TESTS = [
  { id: 1, name: "Mock Test 1 — Full Syllabus", mode: "combined", status: "active", duration_minutes: 30, total_questions: 15, subjects: [1,2,3], is_free: true, price: 0, stream: "PCM", created_at: "2026-01-15", assignType: "all", assignedCourses: [], assignedStreams: [], assignedStudentIds: [], accessLevel: "free", createdBy: { role: "admin", id: 0, name: "Super Admin" }, approvalStatus: "approved", approvalNote: "" },
  { id: 2, name: "Mock Test 2 — Physics Focus", mode: "subject_wise", status: "active", duration_minutes: 60, total_questions: 50, subjects: [1], is_free: false, price: 49, stream: "PCM", created_at: "2026-01-20", assignType: "course", assignedCourses: ["CET PCM", "JEE"], assignedStreams: [], assignedStudentIds: [], accessLevel: "prime", createdBy: { role: "admin", id: 0, name: "Super Admin" }, approvalStatus: "approved", approvalNote: "" },
  { id: 3, name: "Mock Test 3 — Grand Test", mode: "combined", status: "draft", duration_minutes: 180, total_questions: 150, subjects: [1,2,3], is_free: false, price: 99, stream: "PCM", created_at: "2026-02-01", assignType: "students", assignedCourses: [], assignedStreams: [], assignedStudentIds: [1, 5, 13], accessLevel: "prime", createdBy: { role: "admin", id: 0, name: "Super Admin" }, approvalStatus: "approved", approvalNote: "" },
  { id: 4, name: "Physics — Kinematics Practice", mode: "chapter_wise", status: "pending_approval", duration_minutes: 45, total_questions: 30, subjects: [1], is_free: true, price: 0, stream: "PCM", created_at: "2026-02-10", assignType: "all", assignedCourses: [], assignedStreams: [], assignedStudentIds: [], accessLevel: "free", createdBy: { role: "teacher", id: 1, name: "Prof. Rajesh Kulkarni" }, approvalStatus: "pending", approvalNote: "" },
  { id: 5, name: "Chemistry — Organic Reactions", mode: "subject_wise", status: "pending_approval", duration_minutes: 60, total_questions: 40, subjects: [2], is_free: false, price: 29, stream: "PCB", created_at: "2026-02-12", assignType: "all", assignedCourses: [], assignedStreams: [], assignedStudentIds: [], accessLevel: "free", createdBy: { role: "teacher", id: 2, name: "Dr. Meena Sharma" }, approvalStatus: "pending", approvalNote: "" },
  { id: 6, name: "Maths — Integration Mastery", mode: "chapter_wise", status: "rejected", duration_minutes: 30, total_questions: 20, subjects: [3], is_free: true, price: 0, stream: "PCM", created_at: "2026-02-08", assignType: "all", assignedCourses: [], assignedStreams: [], assignedStudentIds: [], accessLevel: "free", createdBy: { role: "teacher", id: 3, name: "Prof. Suresh Patil" }, approvalStatus: "rejected", approvalNote: "Questions need more variety in difficulty. Please add more Hard-level questions and resubmit." },
];

// ═══════════════════════════════════════════
// INITIAL TEACHERS
// ═══════════════════════════════════════════
// ═══════════════════════════════════════════
// INITIAL COLLEGES
// ═══════════════════════════════════════════
const INITIAL_COLLEGES = [
  { id: 1, name: "Fergusson College", shortName: "FC", city: "Pune", color: "#1e40af", logo: null },
  { id: 2, name: "St. Xavier's College", shortName: "SXC", city: "Mumbai", color: "#991b1b", logo: null },
  { id: 3, name: "Symbiosis Institute", shortName: "SI", city: "Pune", color: "#065f46", logo: null },
  { id: 4, name: "COEP Technological University", shortName: "COEP", city: "Pune", color: "#6d28d9", logo: null },
];

const LOGO_WHITE_STRIP_BASE64 = "data:image/jpeg;base64,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";

// All possible teacher permissions — admin controls which each teacher gets
const TEACHER_PERMISSIONS = [
  { id: "question_bank", label: "Question Bank", icon: "📚", desc: "View & browse questions", pageId: "questions" },
  { id: "add_question", label: "Add Question", icon: "➕", desc: "Add questions manually", pageId: "add-question" },
  { id: "csv_upload", label: "CSV Upload", icon: "📄", desc: "Bulk upload via CSV", pageId: "csv-upload" },
  { id: "create_test", label: "Create Test", icon: "🧪", desc: "Create & submit tests", pageId: "generator" },
  { id: "my_tests", label: "My Tests", icon: "📋", desc: "Track test submissions", pageId: "my-tests" },
  { id: "view_results", label: "Student Results", icon: "📊", desc: "View student performance", pageId: "results" },
];

const ALL_TEACHER_PERM_IDS = TEACHER_PERMISSIONS.map(p => p.id);

const INITIAL_TEACHERS = [
  { id: 1, name: "Prof. Rajesh Kulkarni", email: "rajesh.k@greducational.com", phone: "9811111111", username: "rajesh.k", password: "Teacher@123", subjects: [1], status: "active", assignedTests: [1, 2], questionsAdded: 45, lastLogin: "2026-02-07 10:30", joinDate: "2025-10-01", collegeId: 1, permissions: ["question_bank", "add_question", "csv_upload", "create_test", "my_tests", "view_results"] },
  { id: 2, name: "Dr. Meena Sharma", email: "meena.s@greducational.com", phone: "9822222222", username: "meena.s", password: "Teacher@123", subjects: [2], status: "active", assignedTests: [1, 3], questionsAdded: 62, lastLogin: "2026-02-06 15:20", joinDate: "2025-10-15", collegeId: 2, permissions: ["question_bank", "add_question", "csv_upload", "create_test", "my_tests"] },
  { id: 3, name: "Prof. Suresh Patil", email: "suresh.p@greducational.com", phone: "9833333333", username: "suresh.p", password: "Teacher@123", subjects: [3], status: "active", assignedTests: [1], questionsAdded: 38, lastLogin: "2026-02-07 09:00", joinDate: "2025-11-01", collegeId: 1, permissions: ["question_bank", "add_question"] },
  { id: 4, name: "Dr. Anjali Deshpande", email: "anjali.d@greducational.com", phone: "9844444444", username: "anjali.d", password: "Teacher@123", subjects: [1, 3], status: "active", assignedTests: [2, 3], questionsAdded: 51, lastLogin: "2026-02-05 14:00", joinDate: "2025-11-20", collegeId: 3, permissions: ["question_bank", "add_question", "csv_upload", "view_results"] },
  { id: 5, name: "Prof. Vikas Joshi", email: "vikas.j@greducational.com", phone: "9855555555", username: "vikas.j", password: "Teacher@123", subjects: [2, 3], status: "inactive", assignedTests: [], questionsAdded: 12, lastLogin: "2026-01-10 11:45", joinDate: "2025-12-01", collegeId: 4, permissions: ["question_bank"] },
];

// Admin login credentials
const ADMIN_USER = { username: "admin", password: "Admin@123", name: "Super Admin", email: "admin@greducational.com" };

// ═══════════════════════════════════════════
// REUSABLE UI COMPONENTS
// ═══════════════════════════════════════════
function Card({ children, style = {}, ...props }) {
  return <div style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.gray200}`, padding: 24, ...style }} {...props}>{children}</div>;
}

function Btn({ children, variant = "primary", icon, style = {}, ...props }) {
  const base = { display: "inline-flex", alignItems: "center", gap: 6, padding: "10px 18px", borderRadius: 8, fontSize: 14, fontWeight: 600, cursor: "pointer", border: "none", transition: "all 0.15s" };
  const vars = {
    primary: { background: C.primary, color: "#fff" },
    success: { background: C.green, color: "#fff" },
    danger: { background: C.red, color: "#fff" },
    outline: { background: "transparent", border: `1.5px solid ${C.gray300}`, color: C.gray700 },
    ghost: { background: "transparent", color: C.gray600 },
    orange: { background: C.orange, color: "#fff" },
    purple: { background: C.purple, color: "#fff" },
  };
  return <button style={{ ...base, ...vars[variant], ...style, opacity: props.disabled ? 0.5 : 1 }} {...props}>{icon}{children}</button>;
}

function Input({ label, value, onChange, type = "text", placeholder = "", style = {}, ...props }) {
  return (
    <div style={{ marginBottom: 14, ...style }}>
      {label && <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>{label}</label>}
      <input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder}
        style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${C.gray200}`, fontSize: 14, color: C.gray800, outline: "none", background: C.white }} {...props} />
    </div>
  );
}

function Select({ label, value, onChange, options = [], style = {} }) {
  return (
    <div style={{ marginBottom: 14, ...style }}>
      {label && <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>{label}</label>}
      <select value={value} onChange={e => onChange(e.target.value)}
        style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${C.gray200}`, fontSize: 14, color: C.gray800, outline: "none", background: C.white, cursor: "pointer" }}>
        <option value="">Select...</option>
        {options.map(o => typeof o === "object" ? <option key={o.value} value={o.value}>{o.label}</option> : <option key={o} value={o}>{o}</option>)}
      </select>
    </div>
  );
}

function Textarea({ label, value, onChange, rows = 3, placeholder = "" }) {
  return (
    <div style={{ marginBottom: 14 }}>
      {label && <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>{label}</label>}
      <textarea value={value} onChange={e => onChange(e.target.value)} rows={rows} placeholder={placeholder}
        style={{ width: "100%", padding: "10px 12px", borderRadius: 8, border: `1.5px solid ${C.gray200}`, fontSize: 14, color: C.gray800, outline: "none", background: C.white, resize: "vertical", fontFamily: "inherit" }} />
    </div>
  );
}

function Badge({ label, color, bg }) {
  return <span style={{ fontSize: 11, fontWeight: 700, padding: "3px 8px", borderRadius: 4, textTransform: "uppercase", background: bg, color }}>{label}</span>;
}

function StatCard({ label, value, color, icon }) {
  return (
    <Card style={{ padding: "18px 20px", display: "flex", alignItems: "center", gap: 14 }}>
      <div style={{ width: 44, height: 44, borderRadius: 10, background: color + "15", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>{icon}</div>
      <div>
        <div style={{ fontSize: 24, fontWeight: 800, color: C.gray900 }}>{value}</div>
        <div style={{ fontSize: 12, color: C.gray500 }}>{label}</div>
      </div>
    </Card>
  );
}

// ═══════════════════════════════════════════
// SIDEBAR ICONS (inline SVGs)
// ═══════════════════════════════════════════
const SideIcons = {
  dashboard: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>,
  questions: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/></svg>,
  tests: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
  generate: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>,
  results: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="5" width="4" height="16" rx="1"/><rect x="17" y="8" width="4" height="13" rx="1"/></svg>,
  upload: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
  settings: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>,
  students: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>,
  teachers: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>,
  logout: <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
};

// ═══════════════════════════════════════════
// PAGE: Dashboard Overview
// ═══════════════════════════════════════════
function DashboardPage({ questions, tests, students, streams, courses, setPage }) {
  const activeStudents = students.filter(s => s.status === "active").length;
  const blockedStudents = students.filter(s => s.status === "blocked").length;
  const inactiveStudents = students.filter(s => s.status === "inactive").length;
  const avgAllScore = students.length > 0 ? Math.round(students.reduce((a, s) => a + s.avgScore, 0) / students.length) : 0;
  const totalTests = students.reduce((a, s) => a + s.testsAttempted, 0);
  const recentStudents = [...students].sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate)).slice(0, 5);
  const topPerformers = [...students].filter(s => s.testsAttempted >= 2).sort((a, b) => b.avgScore - a.avgScore).slice(0, 5);
  const lowPerformers = [...students].filter(s => s.testsAttempted >= 2).sort((a, b) => a.avgScore - b.avgScore).slice(0, 5);

  // Course counts
  const courseCounts = courses.map(c => ({
    ...c, count: students.filter(s => s.course === c.value).length,
    active: students.filter(s => s.course === c.value && s.status === "active").length,
    avg: (() => { const cs = students.filter(s => s.course === c.value); return cs.length ? Math.round(cs.reduce((a, s) => a + s.avgScore, 0) / cs.length) : 0; })(),
  })).filter(c => c.count > 0).sort((a, b) => b.count - a.count);

  // Stream counts
  const streamCounts = streams.map(st => ({
    stream: st.value, label: st.label,
    count: students.filter(s => s.stream === st.value).length,
  })).filter(s => s.count > 0).sort((a, b) => b.count - a.count);

  // City distribution
  const cityCounts = {};
  students.forEach(s => { cityCounts[s.city] = (cityCounts[s.city] || 0) + 1; });
  const topCities = Object.entries(cityCounts).sort((a, b) => b[1] - a[1]).slice(0, 6);

  // Monthly join trend (last 4 months)
  const monthLabels = [];
  const monthCounts = [];
  for (let i = 3; i >= 0; i--) {
    const d = new Date(); d.setMonth(d.getMonth() - i);
    const m = d.getMonth(); const y = d.getFullYear();
    monthLabels.push(d.toLocaleString("en-IN", { month: "short", year: "2-digit" }));
    monthCounts.push(students.filter(s => { const j = new Date(s.joinDate); return j.getMonth() === m && j.getFullYear() === y; }).length);
  }
  const maxMonth = Math.max(...monthCounts, 1);

  // Gender split
  const maleCount = students.filter(s => s.gender === "Male").length;
  const femaleCount = students.filter(s => s.gender === "Female").length;
  const otherGender = students.length - maleCount - femaleCount;

  // Login provider split
  const emailLogin = students.filter(s => s.loginProvider === "email").length;
  const googleLogin = students.filter(s => s.loginProvider === "google").length;

  // Plan breakdown
  const dashPrimeCount = students.filter(s => s.plan === "prime").length;
  const dashFreeCount = students.filter(s => s.plan === "free" || !s.plan).length;
  const dashTotalRevenue = students.reduce((a, s) => a + (s.amountPaid || 0), 0);

  const MiniBar = ({ value, max, color }) => (
    <div style={{ flex: 1, height: 6, background: C.gray100, borderRadius: 3, overflow: "hidden" }}>
      <div style={{ width: `${Math.min(100, (value / Math.max(max, 1)) * 100)}%`, height: "100%", background: color, borderRadius: 3 }} />
    </div>
  );

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Admin Dashboard</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 24 }}>Complete overview of questions, tests, and students</p>

      {/* ROW 1: Top-level stats */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: 14, marginBottom: 22 }}>
        <StatCard label="Total Questions" value={questions.length} color={C.primary} icon="📚" />
        <StatCard label="Active Tests" value={tests.filter(t => t.status === "active").length} color={C.green} icon="✅" />
        <div onClick={() => setPage("tests")} style={{ cursor: "pointer" }}>
          <Card style={{ padding: "14px 16px", border: tests.filter(t => t.status === "pending_approval").length > 0 ? `2px solid #d97706` : undefined, position: "relative" }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: "#d97706", textTransform: "uppercase", marginBottom: 4 }}>⏳ Pending Approval</div>
            <div style={{ fontSize: 28, fontWeight: 800, color: "#d97706" }}>{tests.filter(t => t.status === "pending_approval").length}</div>
            {tests.filter(t => t.status === "pending_approval").length > 0 && (
              <span style={{ position: "absolute", top: -6, right: -6, padding: "2px 8px", borderRadius: 10, fontSize: 10, fontWeight: 800, background: C.red, color: "#fff" }}>NEW</span>
            )}
          </Card>
        </div>
        <StatCard label="Total Students" value={students.length} color={C.purple} icon="👥" />
        <StatCard label="Active Students" value={activeStudents} color={C.green} icon="🟢" />
        <StatCard label="Avg Score" value={`${avgAllScore}%`} color={avgAllScore >= 70 ? C.green : avgAllScore >= 50 ? C.orange : C.red} icon="📊" />
      </div>

      {/* ROW 2: Student status + gender + plan + login */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 14, marginBottom: 22 }}>
        {/* Status breakdown */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>Student Status</h3>
          {[
            { label: "Active", count: activeStudents, color: C.green, bg: C.greenBg },
            { label: "Blocked", count: blockedStudents, color: C.red, bg: C.redBg },
            { label: "Inactive", count: inactiveStudents, color: C.gray400, bg: C.gray100 },
          ].map(s => (
            <div key={s.label} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
              <span style={{ fontSize: 11, fontWeight: 600, color: s.color, minWidth: 50 }}>{s.label}</span>
              <MiniBar value={s.count} max={students.length} color={s.color} />
              <span style={{ fontSize: 14, fontWeight: 800, color: s.color, minWidth: 24, textAlign: "right" }}>{s.count}</span>
            </div>
          ))}
        </Card>

        {/* Gender split */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>Gender Split</h3>
          {[
            { label: "Male", count: maleCount, color: C.primary, icon: "♂" },
            { label: "Female", count: femaleCount, color: C.purple, icon: "♀" },
          ].map(g => (
            <div key={g.label} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
              <span style={{ fontSize: 14 }}>{g.icon}</span>
              <span style={{ fontSize: 11, fontWeight: 600, color: g.color, minWidth: 42 }}>{g.label}</span>
              <MiniBar value={g.count} max={students.length} color={g.color} />
              <span style={{ fontSize: 14, fontWeight: 800, color: g.color, minWidth: 24, textAlign: "right" }}>{g.count}</span>
            </div>
          ))}
        </Card>

        {/* Plan breakdown */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>⭐ Plan Breakdown</h3>
          {[
            { label: "Prime", count: dashPrimeCount, color: "#d97706", icon: "⭐" },
            { label: "Free", count: dashFreeCount, color: C.gray500, icon: "🆓" },
          ].map(p => (
            <div key={p.label} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
              <span style={{ fontSize: 14 }}>{p.icon}</span>
              <span style={{ fontSize: 11, fontWeight: 600, color: p.color, minWidth: 40 }}>{p.label}</span>
              <MiniBar value={p.count} max={students.length} color={p.color} />
              <span style={{ fontSize: 14, fontWeight: 800, color: p.color, minWidth: 24, textAlign: "right" }}>{p.count}</span>
            </div>
          ))}
          <div style={{ fontSize: 11, color: C.green, fontWeight: 700, marginTop: 6, padding: "6px 10px", background: C.greenBg, borderRadius: 6, textAlign: "center" }}>
            💰 Revenue: ₹{dashTotalRevenue.toLocaleString("en-IN")}
          </div>
        </Card>

        {/* Login providers */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>Login Method</h3>
          {[
            { label: "Email", count: emailLogin, color: C.primary, icon: "📧" },
            { label: "Google", count: googleLogin, color: "#ea4335", icon: "🔵" },
          ].map(l => (
            <div key={l.label} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 10 }}>
              <span style={{ fontSize: 14 }}>{l.icon}</span>
              <span style={{ fontSize: 11, fontWeight: 600, color: C.gray700, minWidth: 42 }}>{l.label}</span>
              <MiniBar value={l.count} max={students.length} color={l.color} />
              <span style={{ fontSize: 14, fontWeight: 800, color: l.color, minWidth: 24, textAlign: "right" }}>{l.count}</span>
            </div>
          ))}
          <div style={{ fontSize: 11, color: C.gray400, marginTop: 4, textAlign: "right" }}>{totalTests} tests attempted</div>
        </Card>
      </div>

      {/* ROW 3: Course-wise student count */}
      <Card style={{ marginBottom: 22, padding: 18 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
          <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, margin: 0 }}>📊 Students by Course</h3>
          <button onClick={() => setPage("students")} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600 }}>View All →</button>
        </div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(155px, 1fr))", gap: 10 }}>
          {courseCounts.map(c => (
            <div key={c.value} style={{ padding: "12px 14px", borderRadius: 10, background: C.gray50, border: `1px solid ${C.gray200}`, position: "relative", overflow: "hidden" }}>
              <div style={{ position: "absolute", bottom: 0, left: 0, width: `${Math.min(100, (c.count / Math.max(courseCounts[0]?.count || 1, 1)) * 100)}%`, height: 3, background: C.primary, borderRadius: "0 3px 0 0" }} />
              <div style={{ fontSize: 26, fontWeight: 900, color: C.primary }}>{c.count}</div>
              <div style={{ fontSize: 12, fontWeight: 700, color: C.gray700, marginTop: 2 }}>{c.value}</div>
              <div style={{ display: "flex", justifyContent: "space-between", marginTop: 4 }}>
                <span style={{ fontSize: 10, color: C.green, fontWeight: 600 }}>{c.active} active</span>
                <span style={{ fontSize: 10, color: c.avg >= 70 ? C.green : c.avg >= 50 ? C.orange : C.red, fontWeight: 700 }}>Avg: {c.avg}%</span>
              </div>
            </div>
          ))}
          {courseCounts.length === 0 && <div style={{ fontSize: 13, color: C.gray400, padding: 10 }}>No students enrolled yet</div>}
        </div>
      </Card>

      {/* ROW 4: Stream chips + City + Monthly trend */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1.2fr", gap: 14, marginBottom: 22 }}>
        {/* Stream chips */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>🎓 By Stream</h3>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
            {streamCounts.map(s => (
              <span key={s.stream} style={{ display: "inline-flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 20, background: C.purpleBg, border: `1px solid ${C.purple}30`, fontSize: 12, fontWeight: 600, color: C.purple }}>
                <strong>{s.count}</strong> {s.stream}
              </span>
            ))}
            {streamCounts.length === 0 && <span style={{ fontSize: 12, color: C.gray400 }}>No data</span>}
          </div>
        </Card>

        {/* City distribution */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>🏙 Top Cities</h3>
          {topCities.map(([city, count], i) => (
            <div key={city} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
              <span style={{ fontSize: 11, fontWeight: 800, color: C.gray400, minWidth: 16 }}>{i + 1}</span>
              <span style={{ fontSize: 12, fontWeight: 600, color: C.gray700, flex: 1 }}>{city}</span>
              <MiniBar value={count} max={topCities[0]?.[1] || 1} color={C.primary} />
              <span style={{ fontSize: 13, fontWeight: 800, color: C.primary, minWidth: 22, textAlign: "right" }}>{count}</span>
            </div>
          ))}
        </Card>

        {/* Monthly join trend */}
        <Card style={{ padding: 16 }}>
          <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>📈 Monthly Registrations</h3>
          <div style={{ display: "flex", alignItems: "flex-end", gap: 8, height: 100 }}>
            {monthLabels.map((m, i) => (
              <div key={m} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 4 }}>
                <span style={{ fontSize: 12, fontWeight: 800, color: C.primary }}>{monthCounts[i]}</span>
                <div style={{ width: "100%", background: monthCounts[i] > 0 ? `linear-gradient(to top, ${C.primary}, ${C.blue50})` : C.gray100, borderRadius: "6px 6px 0 0", height: `${Math.max(8, (monthCounts[i] / maxMonth) * 70)}px`, transition: "height 0.3s" }} />
                <span style={{ fontSize: 10, fontWeight: 600, color: C.gray500 }}>{m}</span>
              </div>
            ))}
          </div>
        </Card>
      </div>

      {/* ROW 5: Top Performers + Low Performers + Recent Joins */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 14, marginBottom: 22 }}>
        {/* Top Performers */}
        <Card style={{ padding: 0, overflow: "hidden" }}>
          <div style={{ padding: "12px 16px", background: C.greenBg, borderBottom: `1px solid ${C.green}30` }}>
            <h3 style={{ fontSize: 14, fontWeight: 700, color: C.green, margin: 0 }}>🏆 Top Performers</h3>
          </div>
          {topPerformers.map((s, i) => (
            <div key={s.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 16px", borderBottom: `1px solid ${C.gray100}` }}>
              <span style={{ fontSize: 16, fontWeight: 900, color: i === 0 ? "#FFD700" : i === 1 ? "#C0C0C0" : i === 2 ? "#CD7F32" : C.gray300, minWidth: 22 }}>
                {i < 3 ? ["🥇", "🥈", "🥉"][i] : `${i + 1}.`}
              </span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 600, color: C.gray800 }}>{s.name}</div>
                <div style={{ fontSize: 10, color: C.gray400 }}>{s.course} · {s.testsAttempted} tests</div>
              </div>
              <span style={{ fontSize: 16, fontWeight: 800, color: C.green }}>{s.avgScore}%</span>
            </div>
          ))}
          {topPerformers.length === 0 && <div style={{ padding: 20, textAlign: "center", fontSize: 12, color: C.gray400 }}>Need at least 2 test attempts</div>}
        </Card>

        {/* Needs Attention (low performers) */}
        <Card style={{ padding: 0, overflow: "hidden" }}>
          <div style={{ padding: "12px 16px", background: C.redBg, borderBottom: `1px solid ${C.red}30` }}>
            <h3 style={{ fontSize: 14, fontWeight: 700, color: C.red, margin: 0 }}>⚠ Needs Attention</h3>
          </div>
          {lowPerformers.map((s, i) => (
            <div key={s.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 16px", borderBottom: `1px solid ${C.gray100}` }}>
              <span style={{ fontSize: 13, fontWeight: 800, color: C.gray300, minWidth: 22 }}>{i + 1}.</span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, fontWeight: 600, color: C.gray800 }}>{s.name}</div>
                <div style={{ fontSize: 10, color: C.gray400 }}>{s.course} · {s.testsAttempted} tests</div>
              </div>
              <span style={{ fontSize: 16, fontWeight: 800, color: s.avgScore < 40 ? C.red : C.orange }}>{s.avgScore}%</span>
            </div>
          ))}
          {lowPerformers.length === 0 && <div style={{ padding: 20, textAlign: "center", fontSize: 12, color: C.gray400 }}>No data yet</div>}
        </Card>

        {/* Recently Joined */}
        <Card style={{ padding: 0, overflow: "hidden" }}>
          <div style={{ padding: "12px 16px", background: C.blue50, borderBottom: `1px solid ${C.primary}30` }}>
            <h3 style={{ fontSize: 14, fontWeight: 700, color: C.primary, margin: 0 }}>🆕 Recently Joined</h3>
          </div>
          {recentStudents.map(s => {
            const st = { active: { color: C.green, icon: "●" }, blocked: { color: C.red, icon: "⛔" }, inactive: { color: C.gray400, icon: "○" } }[s.status] || { color: C.gray400, icon: "?" };
            return (
              <div key={s.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 16px", borderBottom: `1px solid ${C.gray100}` }}>
                <div style={{ width: 32, height: 32, borderRadius: "50%", background: C.gray100, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 700, color: C.gray500 }}>
                  {s.name.charAt(0)}
                </div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, fontWeight: 600, color: C.gray800 }}>{s.name}</div>
                  <div style={{ fontSize: 10, color: C.gray400 }}>{s.course} · {s.stream}</div>
                </div>
                <div style={{ textAlign: "right" }}>
                  <div style={{ fontSize: 11, fontWeight: 600, color: C.gray500 }}>{new Date(s.joinDate).toLocaleDateString("en-IN", { day: "numeric", month: "short" })}</div>
                  <span style={{ fontSize: 10, color: st.color }}>{st.icon} {s.status}</span>
                </div>
              </div>
            );
          })}
        </Card>
      </div>

      {/* ROW 6: Questions by Subject (existing) */}
      <Card style={{ marginBottom: 20 }}>
        <h3 style={{ fontSize: 16, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 18 }}>Questions by Subject</h3>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 14 }}>
          {SUBJECTS.map(s => {
            const count = questions.filter(q => q.subject_id === s.id).length;
            const easy = questions.filter(q => q.subject_id === s.id && q.difficulty === "easy").length;
            const med = questions.filter(q => q.subject_id === s.id && q.difficulty === "medium").length;
            const hard = questions.filter(q => q.subject_id === s.id && q.difficulty === "hard").length;
            return (
              <div key={s.id} style={{ background: C.gray50, borderRadius: 10, padding: 16 }}>
                <div style={{ fontSize: 15, fontWeight: 700, color: C.gray800, marginBottom: 8 }}>{s.name}</div>
                <div style={{ fontSize: 28, fontWeight: 900, color: C.primary, marginBottom: 10 }}>{count}</div>
                <div style={{ display: "flex", gap: 6 }}>
                  <Badge label={`E:${easy}`} color={C.green} bg={C.greenBg} />
                  <Badge label={`M:${med}`} color={C.orange} bg={C.orangeBg} />
                  <Badge label={`H:${hard}`} color={C.red} bg={C.redBg} />
                </div>
              </div>
            );
          })}
        </div>
      </Card>

      {/* ROW 7: Chapter distribution (existing) */}
      <Card>
        <h3 style={{ fontSize: 16, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 18 }}>Chapter-wise Distribution</h3>
        {SUBJECTS.map(s => {
          const subQs = questions.filter(q => q.subject_id === s.id);
          if (subQs.length === 0) return null;
          const chapters = {};
          subQs.forEach(q => { chapters[q.chapter] = (chapters[q.chapter] || 0) + 1; });
          return (
            <div key={s.id} style={{ marginBottom: 18 }}>
              <div style={{ fontSize: 13, fontWeight: 700, color: C.gray500, marginBottom: 8, textTransform: "uppercase", letterSpacing: 0.5 }}>{s.name}</div>
              <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                {Object.entries(chapters).map(([ch, ct]) => (
                  <span key={ch} style={{ fontSize: 12, padding: "5px 12px", background: C.blue50, color: C.primary, borderRadius: 20, fontWeight: 600 }}>{ch}: {ct}</span>
                ))}
              </div>
            </div>
          );
        })}
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Question Bank
// ═══════════════════════════════════════════
function QuestionBankPage({ questions, setQuestions }) {
  const [filterSubject, setFilterSubject] = useState("");
  const [filterChapter, setFilterChapter] = useState("");
  const [filterDifficulty, setFilterDifficulty] = useState("");
  const [search, setSearch] = useState("");
  const [expandedId, setExpandedId] = useState(null);

  const filtered = questions.filter(q => {
    if (filterSubject && q.subject_id !== Number(filterSubject)) return false;
    if (filterChapter && q.chapter !== filterChapter) return false;
    if (filterDifficulty && q.difficulty !== filterDifficulty) return false;
    if (search && !q.question_text.toLowerCase().includes(search.toLowerCase())) return false;
    return true;
  });

  const deleteQuestion = (id) => setQuestions(prev => prev.filter(q => q.id !== id));
  const toggleStatus = (id) => setQuestions(prev => prev.map(q => q.id === id ? { ...q, status: q.status === "active" ? "inactive" : "active" } : q));

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 20 }}>
        <div>
          <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Question Bank</h1>
          <p style={{ color: C.gray500, fontSize: 14 }}>{questions.length} total questions · {filtered.length} shown</p>
        </div>
      </div>

      {/* Filters */}
      <Card style={{ padding: 16, marginBottom: 16 }}>
        <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr 1fr", gap: 12, alignItems: "end" }}>
          <Input label="Search" value={search} onChange={setSearch} placeholder="Search questions..." style={{ marginBottom: 0 }} />
          <Select label="Subject" value={filterSubject} onChange={v => { setFilterSubject(v); setFilterChapter(""); }}
            options={SUBJECTS.map(s => ({ value: s.id, label: s.name }))} style={{ marginBottom: 0 }} />
          <Select label="Chapter" value={filterChapter} onChange={setFilterChapter}
            options={filterSubject ? (CHAPTERS[Number(filterSubject)] || []) : []} style={{ marginBottom: 0 }} />
          <Select label="Difficulty" value={filterDifficulty} onChange={setFilterDifficulty}
            options={["easy", "medium", "hard"]} style={{ marginBottom: 0 }} />
        </div>
      </Card>

      {/* Question List */}
      <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
        {filtered.length === 0 && (
          <Card style={{ textAlign: "center", padding: 48, color: C.gray400 }}>
            <div style={{ fontSize: 36, marginBottom: 12 }}>🔍</div>
            No questions match your filters
          </Card>
        )}
        {filtered.map(q => {
          const sub = SUBJECTS.find(s => s.id === q.subject_id);
          const expanded = expandedId === q.id;
          const optLabels = ["A", "B", "C", "D"];
          return (
            <Card key={q.id} style={{ padding: 0, overflow: "hidden", cursor: "pointer", borderLeft: `4px solid ${q.status === "active" ? C.green : C.gray300}` }}
              onClick={() => setExpandedId(expanded ? null : q.id)}>
              <div style={{ padding: "16px 20px", display: "flex", alignItems: "center", gap: 14 }}>
                <span style={{ fontSize: 13, fontWeight: 800, color: C.gray400, width: 36 }}>#{q.id}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.gray800, lineHeight: 1.5, marginBottom: 6 }}>{q.question_text}</div>
                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                    <Badge label={sub?.name} color={C.primary} bg={C.blue50} />
                    <Badge label={q.chapter} color={C.purple} bg={C.purpleBg} />
                    <Badge label={q.difficulty} color={q.difficulty === "easy" ? C.green : q.difficulty === "hard" ? C.red : C.orange}
                      bg={q.difficulty === "easy" ? C.greenBg : q.difficulty === "hard" ? C.redBg : C.orangeBg} />
                    <Badge label={q.status} color={q.status === "active" ? C.green : C.gray500} bg={q.status === "active" ? C.greenBg : C.gray100} />
                  </div>
                </div>
                <span style={{ fontSize: 12, color: C.gray400, transform: expanded ? "rotate(180deg)" : "rotate(0deg)", transition: "transform 0.2s" }}>▼</span>
              </div>
              {expanded && (
                <div style={{ padding: "0 20px 16px", borderTop: `1px solid ${C.gray100}` }} onClick={e => e.stopPropagation()}>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8, margin: "14px 0" }}>
                    {[q.option_a, q.option_b, q.option_c, q.option_d].map((opt, oi) => (
                      <div key={oi} style={{ padding: "10px 14px", borderRadius: 8, fontSize: 13,
                        background: oi === q.correct_option ? C.greenBg : C.gray50,
                        border: `1.5px solid ${oi === q.correct_option ? C.green : C.gray200}`,
                        color: oi === q.correct_option ? C.green : C.gray700, fontWeight: oi === q.correct_option ? 700 : 400 }}>
                        <strong>{optLabels[oi]}.</strong> {opt} {oi === q.correct_option && " ✓"}
                      </div>
                    ))}
                  </div>
                  {q.image_url && (
                    <div style={{ marginBottom: 12, borderRadius: 8, overflow: "hidden", border: `1px solid ${C.gray200}` }}>
                      <img src={q.image_url} alt="Question" style={{ width: "100%", maxHeight: 180, objectFit: "contain", background: "#fff", padding: 6 }} />
                      <div style={{ padding: "6px 10px", background: C.gray50, fontSize: 11, color: C.gray400, borderTop: `1px solid ${C.gray200}` }}>📷 Question Image</div>
                    </div>
                  )}
                  {q.solution && (
                    <div style={{ background: C.blue50, borderRadius: 8, padding: "10px 14px", fontSize: 13, color: C.primary, borderLeft: `3px solid ${C.primary}`, marginBottom: 12 }}>
                      <strong>Solution:</strong> {q.solution}
                    </div>
                  )}
                  {q.solution_image_url && (
                    <div style={{ marginBottom: 12, borderRadius: 8, overflow: "hidden", border: `1px solid ${C.gray200}` }}>
                      <img src={q.solution_image_url} alt="Solution" style={{ width: "100%", maxHeight: 180, objectFit: "contain", background: "#fff", padding: 6 }} />
                      <div style={{ padding: "6px 10px", background: C.blue50, fontSize: 11, color: C.primary, borderTop: `1px solid ${C.blue100}` }}>📷 Solution Image</div>
                    </div>
                  )}
                  <div style={{ display: "flex", gap: 8 }}>
                    <Btn variant="outline" onClick={() => toggleStatus(q.id)} style={{ fontSize: 12, padding: "6px 12px" }}>
                      {q.status === "active" ? "Deactivate" : "Activate"}
                    </Btn>
                    <Btn variant="danger" onClick={() => deleteQuestion(q.id)} style={{ fontSize: 12, padding: "6px 12px" }}>Delete</Btn>
                  </div>
                </div>
              )}
            </Card>
          );
        })}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// IMAGE UPLOAD COMPONENT
// ═══════════════════════════════════════════
function ImageUpload({ label, image, onImageChange, onRemove }) {
  const ref = useRef(null);
  const handleFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith("image/")) return alert("Please select an image file");
    if (file.size > 5 * 1024 * 1024) return alert("Image must be under 5MB");
    const reader = new FileReader();
    reader.onload = (ev) => onImageChange({ url: ev.target.result, name: file.name, size: (file.size / 1024).toFixed(1) + " KB" });
    reader.readAsDataURL(file);
  };
  return (
    <div style={{ marginBottom: 14 }}>
      {label && <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>{label}</label>}
      {!image ? (
        <div onClick={() => ref.current?.click()}
          style={{ border: `2px dashed ${C.gray300}`, borderRadius: 10, padding: "20px 16px", textAlign: "center", cursor: "pointer", background: C.gray50, transition: "all 0.2s" }}
          onMouseEnter={e => { e.currentTarget.style.borderColor = C.primary; e.currentTarget.style.background = C.blue50; }}
          onMouseLeave={e => { e.currentTarget.style.borderColor = C.gray300; e.currentTarget.style.background = C.gray50; }}
          onDragOver={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.primary; }}
          onDragLeave={e => { e.currentTarget.style.borderColor = C.gray300; }}
          onDrop={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.gray300; const f = e.dataTransfer.files[0]; if (f) { const inp = { target: { files: [f] } }; handleFile(inp); } }}>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 8 }}>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke={C.gray400} strokeWidth="2" strokeLinecap="round">
              <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/>
            </svg>
            <span style={{ fontSize: 13, color: C.gray500, fontWeight: 500 }}>Drop image or click to upload</span>
          </div>
          <div style={{ fontSize: 11, color: C.gray400, marginTop: 4 }}>PNG, JPG, WEBP · Max 5MB</div>
          <input ref={ref} type="file" accept="image/*" onChange={handleFile} style={{ display: "none" }} />
        </div>
      ) : (
        <div style={{ border: `1.5px solid ${C.gray200}`, borderRadius: 10, overflow: "hidden", background: C.gray50 }}>
          <div style={{ position: "relative" }}>
            <img src={image.url} alt="Upload" style={{ width: "100%", maxHeight: 200, objectFit: "contain", display: "block", background: "#fff", padding: 8 }} />
            <button onClick={onRemove}
              style={{ position: "absolute", top: 8, right: 8, width: 28, height: 28, borderRadius: "50%", background: "rgba(0,0,0,0.6)", border: "none", color: "#fff", fontSize: 14, cursor: "pointer", display: "flex", alignItems: "center", justifyContent: "center" }}>
              ✕
            </button>
          </div>
          <div style={{ padding: "8px 12px", display: "flex", justifyContent: "space-between", alignItems: "center", borderTop: `1px solid ${C.gray200}` }}>
            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke={C.green} strokeWidth="2.5" strokeLinecap="round"><path d="M20 6L9 17l-5-5"/></svg>
              <span style={{ fontSize: 12, color: C.gray600, fontWeight: 500 }}>{image.name}</span>
            </div>
            <span style={{ fontSize: 11, color: C.gray400 }}>{image.size}</span>
          </div>
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Add Single Question
// ═══════════════════════════════════════════
function AddQuestionPage({ questions, setQuestions, setPage }) {
  const [form, setForm] = useState({
    subject_id: "", chapter: "", difficulty: "medium",
    question_text: "", option_a: "", option_b: "", option_c: "", option_d: "",
    correct_option: "", solution: "",
  });
  const [questionImage, setQuestionImage] = useState(null);
  const [solutionImage, setSolutionImage] = useState(null);
  const [success, setSuccess] = useState(false);

  const update = (k, v) => setForm(prev => ({ ...prev, [k]: v }));

  const handleSubmit = () => {
    if (!form.subject_id || !form.chapter || !form.question_text || !form.option_a || !form.option_b || !form.option_c || !form.option_d || form.correct_option === "") return alert("Please fill all required fields");
    const newQ = {
      id: Math.max(0, ...questions.map(q => q.id)) + 1,
      ...form,
      subject_id: Number(form.subject_id),
      correct_option: Number(form.correct_option),
      status: "active",
      image_url: questionImage?.url || null,
      solution_image_url: solutionImage?.url || null,
    };
    setQuestions(prev => [...prev, newQ]);
    setForm({ subject_id: "", chapter: "", difficulty: "medium", question_text: "", option_a: "", option_b: "", option_c: "", option_d: "", correct_option: "", solution: "" });
    setQuestionImage(null);
    setSolutionImage(null);
    setSuccess(true);
    setTimeout(() => setSuccess(false), 3000);
  };

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Add Question</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 20 }}>Add a single question to the bank</p>

      {success && (
        <div style={{ background: C.greenBg, border: `1px solid ${C.green}`, borderRadius: 10, padding: "12px 18px", marginBottom: 16, color: C.green, fontWeight: 600, fontSize: 14 }}>
          ✓ Question added successfully!
        </div>
      )}

      <Card>
        {/* Subject / Chapter / Difficulty */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 14, marginBottom: 8 }}>
          <Select label="Subject *" value={form.subject_id} onChange={v => { update("subject_id", v); update("chapter", ""); }}
            options={SUBJECTS.map(s => ({ value: s.id, label: s.name }))} />
          <Select label="Chapter *" value={form.chapter} onChange={v => update("chapter", v)}
            options={form.subject_id ? (CHAPTERS[Number(form.subject_id)] || []) : []} />
          <Select label="Difficulty" value={form.difficulty} onChange={v => update("difficulty", v)}
            options={["easy", "medium", "hard"]} />
        </div>

        {/* Question Text + Image */}
        <Textarea label="Question Text *" value={form.question_text} onChange={v => update("question_text", v)} rows={3} placeholder="Enter the question..." />
        <ImageUpload label="Question Image (optional)" image={questionImage} onImageChange={setQuestionImage} onRemove={() => setQuestionImage(null)} />

        {/* Options */}
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 14 }}>
          {["A", "B", "C", "D"].map((lbl, i) => (
            <div key={lbl} style={{ position: "relative" }}>
              <Input label={`Option ${lbl} *`} value={form[`option_${lbl.toLowerCase()}`]} onChange={v => update(`option_${lbl.toLowerCase()}`, v)} placeholder={`Option ${lbl}`} />
              <label style={{ position: "absolute", top: 0, right: 0, fontSize: 11, display: "flex", alignItems: "center", gap: 4, cursor: "pointer", color: Number(form.correct_option) === i ? C.green : C.gray400 }}>
                <input type="radio" name="correct" checked={Number(form.correct_option) === i} onChange={() => update("correct_option", String(i))}
                  style={{ accentColor: C.green }} /> Correct
              </label>
            </div>
          ))}
        </div>

        {/* Solution + Image */}
        <Textarea label="Solution / Explanation" value={form.solution} onChange={v => update("solution", v)} rows={2} placeholder="Explain the answer (optional)" />
        <ImageUpload label="Solution Image (optional)" image={solutionImage} onImageChange={setSolutionImage} onRemove={() => setSolutionImage(null)} />

        <div style={{ display: "flex", gap: 10, marginTop: 8 }}>
          <Btn onClick={handleSubmit} variant="success">Save Question</Btn>
          <Btn variant="ghost" onClick={() => setPage("questions")}>Cancel</Btn>
        </div>
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: CSV Upload
// ═══════════════════════════════════════════
function CSVUploadPage({ questions, setQuestions }) {
  const fileRef = useRef(null);
  const [preview, setPreview] = useState([]);
  const [error, setError] = useState("");
  const [imported, setImported] = useState(0);
  const [csvText, setCsvText] = useState("");

  const CSV_TEMPLATE = `subject,chapter,difficulty,question_text,option_a,option_b,option_c,option_d,correct_option,solution
Physics,Kinematics,easy,What is the SI unit of velocity?,m/s,km/h,cm/s,m/s²,0,SI unit of velocity is m/s
Physics,Optics,medium,Which colour has the shortest wavelength?,Red,Green,Blue,Violet,3,Violet has the shortest wavelength in visible spectrum
Chemistry,Mole Concept,easy,What is Avogadro's number?,6.022×10²³,6.022×10²²,6.022×10²⁴,6.022×10²¹,0,Avogadro's number is 6.022×10²³
Mathematics,Trigonometry,medium,What is the value of sin(90°)?,0,1,-1,undefined,1,sin(90°) = 1`;

  const parseCSV = (text) => {
    const lines = text.trim().split("\n");
    if (lines.length < 2) return { error: "CSV must have a header and at least one data row" };
    const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
    const required = ["subject", "chapter", "question_text", "option_a", "option_b", "option_c", "option_d", "correct_option"];
    const missing = required.filter(r => !headers.includes(r));
    if (missing.length > 0) return { error: `Missing columns: ${missing.join(", ")}` };

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const vals = lines[i].split(",").map(v => v.trim());
      const row = {};
      headers.forEach((h, hi) => row[h] = vals[hi] || "");
      const sub = SUBJECTS.find(s => s.name.toLowerCase() === row.subject.toLowerCase());
      if (!sub) { rows.push({ ...row, _error: `Unknown subject: ${row.subject}`, _line: i + 1 }); continue; }
      if (!row.question_text || !row.option_a || !row.option_b) { rows.push({ ...row, _error: "Missing required fields", _line: i + 1 }); continue; }
      rows.push({
        ...row,
        subject_id: sub.id,
        correct_option: Number(row.correct_option) || 0,
        difficulty: row.difficulty || "medium",
        status: "active",
        _line: i + 1,
      });
    }
    return { rows };
  };

  const handleFile = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      setCsvText(ev.target.result);
      processText(ev.target.result);
    };
    reader.readAsText(file);
  };

  const processText = (text) => {
    setError(""); setImported(0);
    const result = parseCSV(text);
    if (result.error) { setError(result.error); setPreview([]); return; }
    setPreview(result.rows);
  };

  const handleImport = () => {
    const valid = preview.filter(r => !r._error);
    if (valid.length === 0) return;
    const baseId = Math.max(0, ...questions.map(q => q.id)) + 1;
    const newQs = valid.map((r, i) => ({
      id: baseId + i,
      subject_id: r.subject_id,
      chapter: r.chapter,
      difficulty: r.difficulty,
      question_text: r.question_text,
      option_a: r.option_a,
      option_b: r.option_b,
      option_c: r.option_c,
      option_d: r.option_d,
      correct_option: r.correct_option,
      solution: r.solution || "",
      status: "active",
    }));
    setQuestions(prev => [...prev, ...newQs]);
    setImported(newQs.length);
    setPreview([]);
    setCsvText("");
  };

  const downloadTemplate = () => {
    const blob = new Blob([CSV_TEMPLATE], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url; a.download = "question_template.csv"; a.click();
    URL.revokeObjectURL(url);
  };

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Upload Questions (CSV)</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 20 }}>Bulk import questions from a CSV file</p>

      {imported > 0 && (
        <div style={{ background: C.greenBg, border: `1px solid ${C.green}`, borderRadius: 10, padding: "12px 18px", marginBottom: 16, color: C.green, fontWeight: 600, fontSize: 14 }}>
          ✓ Successfully imported {imported} questions!
        </div>
      )}

      {/* Template download */}
      <Card style={{ marginBottom: 16, padding: 18, display: "flex", justifyContent: "space-between", alignItems: "center", background: C.blue50, border: `1px solid ${C.blue100}` }}>
        <div>
          <div style={{ fontSize: 14, fontWeight: 700, color: C.primary }}>CSV Template</div>
          <div style={{ fontSize: 12, color: C.gray500, marginTop: 2 }}>Download the template with correct column headers</div>
        </div>
        <Btn variant="outline" onClick={downloadTemplate} style={{ fontSize: 12 }}>⬇ Download Template</Btn>
      </Card>

      {/* Required columns info */}
      <Card style={{ marginBottom: 16, padding: 16 }}>
        <div style={{ fontSize: 13, fontWeight: 700, color: C.gray700, marginBottom: 8 }}>Required CSV Columns:</div>
        <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
          {["subject", "chapter", "question_text", "option_a", "option_b", "option_c", "option_d", "correct_option"].map(col => (
            <span key={col} style={{ fontSize: 12, padding: "3px 10px", background: C.redBg, color: C.red, borderRadius: 4, fontWeight: 600, fontFamily: "monospace" }}>{col}</span>
          ))}
          {["difficulty", "solution"].map(col => (
            <span key={col} style={{ fontSize: 12, padding: "3px 10px", background: C.gray100, color: C.gray500, borderRadius: 4, fontWeight: 600, fontFamily: "monospace" }}>{col} (optional)</span>
          ))}
        </div>
        <div style={{ fontSize: 12, color: C.gray400, marginTop: 8 }}>
          <strong>correct_option:</strong> 0 = A, 1 = B, 2 = C, 3 = D · <strong>difficulty:</strong> easy / medium / hard · <strong>subject:</strong> Physics / Chemistry / Mathematics / Biology
        </div>
      </Card>

      {/* Upload area */}
      <Card style={{ marginBottom: 16 }}>
        <div onClick={() => fileRef.current?.click()}
          style={{ border: `2px dashed ${C.gray300}`, borderRadius: 12, padding: "40px 20px", textAlign: "center", cursor: "pointer", transition: "border-color 0.2s", background: C.gray50 }}
          onDragOver={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.primary; }}
          onDragLeave={e => { e.currentTarget.style.borderColor = C.gray300; }}
          onDrop={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.gray300; const file = e.dataTransfer.files[0]; if (file) { const r = new FileReader(); r.onload = ev => { setCsvText(ev.target.result); processText(ev.target.result); }; r.readAsText(file); } }}>
          <div style={{ fontSize: 36, marginBottom: 8 }}>📄</div>
          <div style={{ fontSize: 15, fontWeight: 600, color: C.gray700 }}>Drop CSV file here or click to browse</div>
          <div style={{ fontSize: 12, color: C.gray400, marginTop: 4 }}>Supports .csv files</div>
          <input ref={fileRef} type="file" accept=".csv" onChange={handleFile} style={{ display: "none" }} />
        </div>

        <div style={{ marginTop: 16, textAlign: "center", fontSize: 13, color: C.gray400 }}>— or paste CSV text directly —</div>
        <Textarea label="" value={csvText} onChange={v => { setCsvText(v); if (v.trim()) processText(v); else { setPreview([]); setError(""); } }} rows={5} placeholder="Paste your CSV content here..." />
      </Card>

      {/* Errors */}
      {error && (
        <div style={{ background: C.redBg, border: `1px solid ${C.red}`, borderRadius: 10, padding: "12px 18px", marginBottom: 16, color: C.red, fontWeight: 600, fontSize: 13 }}>
          ✗ {error}
        </div>
      )}

      {/* Preview */}
      {preview.length > 0 && (
        <Card style={{ padding: 0, overflow: "hidden", marginBottom: 16 }}>
          <div style={{ padding: "14px 20px", borderBottom: `1px solid ${C.gray200}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <span style={{ fontWeight: 700, color: C.gray800, fontSize: 15 }}>Preview </span>
              <Badge label={`${preview.filter(r => !r._error).length} valid`} color={C.green} bg={C.greenBg} />
              {preview.some(r => r._error) && <span style={{ marginLeft: 8 }}><Badge label={`${preview.filter(r => r._error).length} errors`} color={C.red} bg={C.redBg} /></span>}
            </div>
            <Btn variant="success" onClick={handleImport} style={{ fontSize: 13 }}>Import {preview.filter(r => !r._error).length} Questions</Btn>
          </div>
          <div style={{ maxHeight: 340, overflowY: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13 }}>
              <thead>
                <tr style={{ background: C.gray50 }}>
                  {["#", "Subject", "Chapter", "Difficulty", "Question", "Correct", "Status"].map(h => (
                    <th key={h} style={{ padding: "10px 14px", textAlign: "left", fontSize: 11, fontWeight: 700, color: C.gray400, textTransform: "uppercase", position: "sticky", top: 0, background: C.gray50 }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {preview.map((r, i) => (
                  <tr key={i} style={{ borderBottom: `1px solid ${C.gray100}`, background: r._error ? C.redBg : "transparent" }}>
                    <td style={{ padding: "10px 14px", color: C.gray400 }}>{r._line}</td>
                    <td style={{ padding: "10px 14px" }}>{r.subject}</td>
                    <td style={{ padding: "10px 14px" }}>{r.chapter}</td>
                    <td style={{ padding: "10px 14px" }}><Badge label={r.difficulty || "medium"} color={r.difficulty === "easy" ? C.green : r.difficulty === "hard" ? C.red : C.orange} bg={r.difficulty === "easy" ? C.greenBg : r.difficulty === "hard" ? C.redBg : C.orangeBg} /></td>
                    <td style={{ padding: "10px 14px", maxWidth: 280, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.question_text}</td>
                    <td style={{ padding: "10px 14px" }}>{["A", "B", "C", "D"][r.correct_option]}</td>
                    <td style={{ padding: "10px 14px" }}>{r._error ? <span style={{ color: C.red, fontSize: 12 }}>✗ {r._error}</span> : <span style={{ color: C.green }}>✓ Valid</span>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════
// ═══════════════════════════════════════════
// PAGE: Create Test (3 methods: Auto, Upload CSV, Manual Select)
// ═══════════════════════════════════════════
function TestGeneratorPage({ questions, tests, setTests, modes, setModes, streams, setStreams, students, courses, role: userRole, currentUser }) {
  const [createMethod, setCreateMethod] = useState("auto");
  const fileRef = useRef(null);

  // Shared test config
  const [form, setForm] = useState({
    name: "", mode: "combined", duration: "60", stream: "PCM",
    subjects: [1, 2, 3], chapters: [], totalQuestions: "15",
    perSubject: { 1: "5", 2: "5", 3: "5" },
    easyPct: "30", mediumPct: "40", hardPct: "30",
    marks: "1", negative: "0", isFree: true, price: "0",
    assignType: "all", assignedCourses: [], assignedStreams: [], assignedStudentIds: [], accessLevel: "free",
  });
  const [showAddMode, setShowAddMode] = useState(false);
  const [showAddStream, setShowAddStream] = useState(false);
  const [newMode, setNewMode] = useState({ value: "", label: "" });
  const [newStream, setNewStream] = useState({ value: "", label: "" });
  const [studentSearch, setStudentSearch] = useState("");

  // Auto state
  const [generated, setGenerated] = useState(null);
  // CSV state
  const [csvText, setCsvText] = useState("");
  const [csvPreview, setCsvPreview] = useState([]);
  const [csvError, setCsvError] = useState("");
  // Manual state
  const [selectedIds, setSelectedIds] = useState(new Set());
  const [mfSubject, setMfSubject] = useState("");
  const [mfChapter, setMfChapter] = useState("");
  const [mfDiff, setMfDiff] = useState("");
  const [mfSearch, setMfSearch] = useState("");

  const [saved, setSaved] = useState(false);
  const update = (k, v) => setForm(prev => ({ ...prev, [k]: v }));

  // Mode/Stream helpers
  const addMode = () => {
    if (!newMode.value.trim() || !newMode.label.trim()) return;
    const val = newMode.value.trim().toLowerCase().replace(/\s+/g, "_");
    if (modes.find(m => m.value === val)) return alert("Mode already exists");
    setModes(prev => [...prev, { value: val, label: newMode.label.trim() }]);
    setNewMode({ value: "", label: "" }); setShowAddMode(false); update("mode", val);
  };
  const removeMode = (val) => { if (modes.length <= 1) return; setModes(prev => prev.filter(m => m.value !== val)); if (form.mode === val) update("mode", modes[0]?.value || ""); };
  const addStream = () => {
    if (!newStream.value.trim() || !newStream.label.trim()) return;
    if (streams.find(s => s.value === newStream.value.trim())) return alert("Stream already exists");
    setStreams(prev => [...prev, { value: newStream.value.trim(), label: newStream.label.trim() }]);
    setNewStream({ value: "", label: "" }); setShowAddStream(false); update("stream", newStream.value.trim());
  };
  const removeStream = (val) => { if (streams.length <= 1) return; setStreams(prev => prev.filter(s => s.value !== val)); if (form.stream === val) update("stream", streams[0]?.value || ""); };

  const toggleSubject = (id) => {
    setForm(prev => {
      const subs = prev.subjects.includes(id) ? prev.subjects.filter(s => s !== id) : [...prev.subjects, id];
      const ps = { ...prev.perSubject };
      if (!subs.includes(id)) delete ps[id]; else ps[id] = String(Math.floor(Number(prev.totalQuestions) / Math.max(subs.length, 1)));
      return { ...prev, subjects: subs, perSubject: ps };
    });
  };
  const getAvail = (subId) => questions.filter(q => q.subject_id === subId && q.status === "active").length;

  // ─── AUTO GENERATE ───
  const handleGenerate = () => {
    const selected = [];
    form.subjects.forEach(subId => {
      const count = Number(form.perSubject[subId] || Math.floor(Number(form.totalQuestions) / form.subjects.length));
      const pool = questions.filter(q => q.subject_id === subId && q.status === "active");
      const eN = Math.round(count * Number(form.easyPct) / 100);
      const hN = Math.round(count * Number(form.hardPct) / 100);
      const mN = count - eN - hN;
      const pick = (arr, n) => [...arr].sort(() => Math.random() - 0.5).slice(0, n);
      selected.push(...pick(pool.filter(q => q.difficulty === "easy"), eN));
      selected.push(...pick(pool.filter(q => q.difficulty === "medium"), mN));
      selected.push(...pick(pool.filter(q => q.difficulty === "hard"), hN));
    });
    setGenerated({ questions: selected, requested: Number(form.totalQuestions) });
  };

  // ─── CSV PARSE ───
  const parseTestCSV = (text) => {
    const lines = text.trim().split("\n");
    if (lines.length < 2) return { error: "CSV must have header + at least 1 data row" };
    const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
    const required = ["question_text", "option_a", "option_b", "option_c", "option_d", "correct_option"];
    const missing = required.filter(r => !headers.includes(r));
    if (missing.length) return { error: `Missing columns: ${missing.join(", ")}` };
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const vals = lines[i].split(",").map(v => v.trim());
      const row = {}; headers.forEach((h, hi) => row[h] = vals[hi] || "");
      const sub = row.subject ? SUBJECTS.find(s => s.name.toLowerCase() === row.subject.toLowerCase()) : null;
      if (!row.question_text || !row.option_a || !row.option_b) { rows.push({ ...row, _error: "Missing fields", _line: i + 1 }); continue; }
      rows.push({ ...row, subject_id: sub?.id || 1, correct_option: Number(row.correct_option) || 0, difficulty: row.difficulty || "medium", chapter: row.chapter || "", solution: row.solution || "", status: "active", _line: i + 1, id: `csv_${i}` });
    }
    return { rows };
  };
  const handleCSVFile = (e) => {
    const file = e.target?.files?.[0]; if (!file) return;
    const r = new FileReader();
    r.onload = (ev) => { setCsvText(ev.target.result); processCSV(ev.target.result); };
    r.readAsText(file);
  };
  const processCSV = (text) => {
    setCsvError(""); const res = parseTestCSV(text);
    if (res.error) { setCsvError(res.error); setCsvPreview([]); return; }
    setCsvPreview(res.rows);
  };

  // ─── MANUAL SELECT ───
  const toggleSelect = (id) => setSelectedIds(prev => { const n = new Set(prev); n.has(id) ? n.delete(id) : n.add(id); return n; });
  const selectAll = (ids) => setSelectedIds(prev => { const n = new Set(prev); ids.forEach(id => n.add(id)); return n; });
  const deselectAll = (ids) => setSelectedIds(prev => { const n = new Set(prev); ids.forEach(id => n.delete(id)); return n; });

  const filteredManual = questions.filter(q => {
    if (q.status !== "active") return false;
    if (mfSubject && q.subject_id !== Number(mfSubject)) return false;
    if (mfChapter && q.chapter !== mfChapter) return false;
    if (mfDiff && q.difficulty !== mfDiff) return false;
    if (mfSearch && !q.question_text.toLowerCase().includes(mfSearch.toLowerCase())) return false;
    return true;
  });

  // ─── PREVIEW QUESTIONS ───
  const getPreviewQs = () => {
    if (createMethod === "auto") return generated?.questions || [];
    if (createMethod === "upload") return csvPreview.filter(r => !r._error);
    if (createMethod === "manual") return questions.filter(q => selectedIds.has(q.id));
    return [];
  };
  const previewQs = getPreviewQs();

  // ─── SAVE ───
  const handleSave = () => {
    if (previewQs.length === 0) return alert("No questions! Generate, upload, or select questions first.");
    if (!form.name.trim()) return alert("Please enter a test name.");
    const isTeacherCreating = userRole === "teacher";
    const newTest = {
      id: Math.max(0, ...tests.map(t => t.id)) + 1,
      name: form.name, mode: form.mode,
      status: isTeacherCreating ? "pending_approval" : "draft",
      duration_minutes: Number(form.duration), total_questions: previewQs.length,
      subjects: [...new Set(previewQs.map(q => q.subject_id).filter(Boolean))],
      is_free: form.isFree, price: Number(form.price), stream: form.stream,
      created_at: new Date().toISOString().split("T")[0], method: createMethod,
      assignType: isTeacherCreating ? "all" : form.assignType,
      assignedCourses: isTeacherCreating ? [] : [...form.assignedCourses],
      assignedStreams: isTeacherCreating ? [] : [...form.assignedStreams],
      assignedStudentIds: isTeacherCreating ? [] : [...form.assignedStudentIds],
      accessLevel: form.accessLevel,
      createdBy: isTeacherCreating
        ? { role: "teacher", id: currentUser?.id, name: currentUser?.name || "Teacher" }
        : { role: "admin", id: 0, name: "Super Admin" },
      approvalStatus: isTeacherCreating ? "pending" : "approved",
      approvalNote: "",
    };
    setTests(prev => [...prev, newTest]);
    setSaved(true); setTimeout(() => setSaved(false), 3000);
    if (createMethod === "auto") setGenerated(null);
    if (createMethod === "upload") { setCsvPreview([]); setCsvText(""); }
    if (createMethod === "manual") setSelectedIds(new Set());
  };

  // ═══ CONFIG PANEL (shared) ═══
  const ConfigPanel = () => (
    <>
      <Card style={{ marginBottom: 14 }}>
        <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>Test Info</h3>
        <Input label="Test Name *" value={form.name} onChange={v => update("name", v)} placeholder="e.g. Mock Test 4 — Full Syllabus" />
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr 1fr", gap: 10 }}>
          <Input label="Duration (min)" value={form.duration} onChange={v => update("duration", v)} type="number" />
          <Input label="Marks / Q" value={form.marks} onChange={v => update("marks", v)} type="number" />
          <Input label="Negative" value={form.negative} onChange={v => update("negative", v)} type="number" />
          <div style={{ marginBottom: 14 }}>
            <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>Pricing</label>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <label style={{ display: "flex", alignItems: "center", gap: 4, cursor: "pointer", fontSize: 13, color: C.gray700 }}>
                <input type="checkbox" checked={form.isFree} onChange={e => update("isFree", e.target.checked)} style={{ accentColor: C.green }} /> Free
              </label>
              {!form.isFree && <input type="number" value={form.price} onChange={e => update("price", e.target.value)} placeholder="₹" style={{ width: 70, padding: "7px 8px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13 }} />}
            </div>
          </div>
        </div>
      </Card>

      {/* ACCESS LEVEL — Free vs Prime */}
      <Card style={{ marginBottom: 14, padding: 16 }}>
        <div style={{ fontSize: 13, fontWeight: 700, color: C.gray700, marginBottom: 8 }}>🔒 Access Level — Who can take this test?</div>
        <div style={{ display: "flex", gap: 8 }}>
          {[
            { value: "free", label: "🆓 Free", desc: "All students (Free + Prime)", color: C.green, bg: C.greenBg },
            { value: "prime", label: "⭐ Prime Only", desc: "Only Prime/Paid students", color: "#d97706", bg: "#fef3c7" },
          ].map(opt => {
            const active = form.accessLevel === opt.value;
            return (
              <div key={opt.value} onClick={() => update("accessLevel", opt.value)}
                style={{ flex: 1, padding: "12px 14px", borderRadius: 10, cursor: "pointer",
                  background: active ? opt.bg : C.gray50, border: `2px solid ${active ? opt.color : C.gray200}`, transition: "all 0.15s" }}>
                <div style={{ fontSize: 15, fontWeight: 800, color: active ? opt.color : C.gray500 }}>{opt.label}</div>
                <div style={{ fontSize: 11, color: active ? opt.color : C.gray400, marginTop: 2, opacity: 0.8 }}>{opt.desc}</div>
                {active && opt.value === "free" && (
                  <div style={{ fontSize: 10, color: C.green, marginTop: 4, fontWeight: 600 }}>
                    All {students.filter(s => s.status === "active").length} active students can access
                  </div>
                )}
                {active && opt.value === "prime" && (
                  <div style={{ fontSize: 10, color: "#d97706", marginTop: 4, fontWeight: 600 }}>
                    Only {students.filter(s => s.plan === "prime" && s.status === "active").length} Prime students can access • Free students must upgrade
                  </div>
                )}
              </div>
            );
          })}
        </div>
        {!form.isFree && form.accessLevel === "free" && (
          <div style={{ marginTop: 8, padding: "6px 12px", background: C.orangeBg, borderRadius: 6, fontSize: 11, color: C.orange, fontWeight: 600, border: `1px solid ${C.orange}30` }}>
            ⚠ This test has a price (₹{form.price}) but access is Free. Free students will see it but may need to pay. Consider setting to "Prime Only" for paid test packages.
          </div>
        )}
      </Card>

      {/* MODE */}
      <Card style={{ marginBottom: 14, padding: 16 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <span style={{ fontSize: 13, fontWeight: 700, color: C.gray700 }}>Test Mode</span>
          <button onClick={() => setShowAddMode(!showAddMode)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 11, color: C.primary, fontWeight: 600 }}>{showAddMode ? "✕" : "+ Add"}</button>
        </div>
        {showAddMode && (
          <div style={{ display: "flex", gap: 6, marginBottom: 8, padding: 8, background: C.blue50, borderRadius: 6 }}>
            <input value={newMode.value} onChange={e => setNewMode(p => ({ ...p, value: e.target.value }))} placeholder="Code" style={{ flex: 1, padding: "6px 8px", borderRadius: 5, border: `1px solid ${C.gray200}`, fontSize: 12 }} />
            <input value={newMode.label} onChange={e => setNewMode(p => ({ ...p, label: e.target.value }))} placeholder="Label" onKeyDown={e => e.key === "Enter" && addMode()} style={{ flex: 2, padding: "6px 8px", borderRadius: 5, border: `1px solid ${C.gray200}`, fontSize: 12 }} />
            <Btn variant="success" onClick={addMode} style={{ fontSize: 11, padding: "4px 10px" }}>+</Btn>
          </div>
        )}
        <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
          {modes.map(m => {
            const a = form.mode === m.value;
            return (<div key={m.value} onClick={() => update("mode", m.value)} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "5px 11px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: a ? 700 : 500, background: a ? C.primary : C.gray50, color: a ? "#fff" : C.gray600, border: `1.5px solid ${a ? C.primary : C.gray200}`, transition: "all 0.15s" }}>
              {m.label}
              {!a && <span onClick={e => { e.stopPropagation(); removeMode(m.value); }} style={{ fontSize: 9, color: C.gray400, cursor: "pointer" }}>✕</span>}
            </div>);
          })}
        </div>
      </Card>

      {/* STREAM */}
      <Card style={{ marginBottom: 14, padding: 16 }}>
        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
          <span style={{ fontSize: 13, fontWeight: 700, color: C.gray700 }}>Stream / Course</span>
          <button onClick={() => setShowAddStream(!showAddStream)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 11, color: C.primary, fontWeight: 600 }}>{showAddStream ? "✕" : "+ Add"}</button>
        </div>
        {showAddStream && (
          <div style={{ display: "flex", gap: 6, marginBottom: 8, padding: 8, background: C.blue50, borderRadius: 6 }}>
            <input value={newStream.value} onChange={e => setNewStream(p => ({ ...p, value: e.target.value }))} placeholder="Code" style={{ flex: 1, padding: "6px 8px", borderRadius: 5, border: `1px solid ${C.gray200}`, fontSize: 12 }} />
            <input value={newStream.label} onChange={e => setNewStream(p => ({ ...p, label: e.target.value }))} placeholder="Label" onKeyDown={e => e.key === "Enter" && addStream()} style={{ flex: 2, padding: "6px 8px", borderRadius: 5, border: `1px solid ${C.gray200}`, fontSize: 12 }} />
            <Btn variant="success" onClick={addStream} style={{ fontSize: 11, padding: "4px 10px" }}>+</Btn>
          </div>
        )}
        <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
          {streams.map(s => {
            const a = form.stream === s.value;
            return (<div key={s.value} onClick={() => update("stream", s.value)} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "5px 11px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: a ? 700 : 500, background: a ? C.purple : C.gray50, color: a ? "#fff" : C.gray600, border: `1.5px solid ${a ? C.purple : C.gray200}`, transition: "all 0.15s" }}>
              {s.label}
              {!a && <span onClick={e => { e.stopPropagation(); removeStream(s.value); }} style={{ fontSize: 9, color: C.gray400, cursor: "pointer" }}>✕</span>}
            </div>);
          })}
        </div>
      </Card>

      {/* ASSIGN TO — who can see this test (admin only) */}
      {userRole !== "teacher" && <Card style={{ padding: 16 }}>
        <div style={{ fontSize: 13, fontWeight: 700, color: C.gray700, marginBottom: 10 }}>🎯 Assign Test To</div>
        <div style={{ display: "flex", gap: 6, marginBottom: 12 }}>
          {[
            { value: "all", label: "All Students", icon: "👥", desc: "Everyone can see this test" },
            { value: "course", label: "By Course", icon: "📚", desc: "Only specific courses" },
            { value: "stream", label: "By Stream", icon: "🎓", desc: "Only specific streams" },
            { value: "students", label: "Specific Students", icon: "👤", desc: "Hand-pick students" },
          ].map(opt => {
            const active = form.assignType === opt.value;
            return (
              <div key={opt.value} onClick={() => update("assignType", opt.value)}
                style={{ flex: 1, padding: "10px 10px", borderRadius: 10, cursor: "pointer", textAlign: "center",
                  background: active ? C.primary : C.gray50, color: active ? "#fff" : C.gray600,
                  border: `1.5px solid ${active ? C.primary : C.gray200}`, transition: "all 0.15s" }}>
                <div style={{ fontSize: 18, marginBottom: 4 }}>{opt.icon}</div>
                <div style={{ fontSize: 11, fontWeight: 700 }}>{opt.label}</div>
              </div>
            );
          })}
        </div>

        {/* Course selector */}
        {form.assignType === "course" && (
          <div>
            <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Select courses that can access this test:</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
              {courses.map(c => {
                const sel = form.assignedCourses.includes(c.value);
                const studentCount = students.filter(s => s.course === c.value && s.status === "active").length;
                return (
                  <div key={c.value} onClick={() => update("assignedCourses", sel ? form.assignedCourses.filter(x => x !== c.value) : [...form.assignedCourses, c.value])}
                    style={{ display: "inline-flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 16, cursor: "pointer",
                      background: sel ? C.primary : C.white, color: sel ? "#fff" : C.gray600,
                      border: `1.5px solid ${sel ? C.primary : C.gray200}`, fontSize: 12, fontWeight: sel ? 700 : 500, transition: "all 0.15s" }}>
                    {sel ? "✓ " : ""}{c.value}
                    <span style={{ fontSize: 10, opacity: 0.7 }}>({studentCount})</span>
                  </div>
                );
              })}
            </div>
            {form.assignedCourses.length > 0 && (
              <div style={{ marginTop: 8, fontSize: 11, color: C.green, fontWeight: 600 }}>
                ✓ {students.filter(s => form.assignedCourses.includes(s.course) && s.status === "active").length} active students will see this test
              </div>
            )}
          </div>
        )}

        {/* Stream selector */}
        {form.assignType === "stream" && (
          <div>
            <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Select streams that can access this test:</div>
            <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
              {streams.map(st => {
                const sel = form.assignedStreams.includes(st.value);
                const studentCount = students.filter(s => s.stream === st.value && s.status === "active").length;
                return (
                  <div key={st.value} onClick={() => update("assignedStreams", sel ? form.assignedStreams.filter(x => x !== st.value) : [...form.assignedStreams, st.value])}
                    style={{ display: "inline-flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 16, cursor: "pointer",
                      background: sel ? C.purple : C.white, color: sel ? "#fff" : C.gray600,
                      border: `1.5px solid ${sel ? C.purple : C.gray200}`, fontSize: 12, fontWeight: sel ? 700 : 500, transition: "all 0.15s" }}>
                    {sel ? "✓ " : ""}{st.label}
                    <span style={{ fontSize: 10, opacity: 0.7 }}>({studentCount})</span>
                  </div>
                );
              })}
            </div>
            {form.assignedStreams.length > 0 && (
              <div style={{ marginTop: 8, fontSize: 11, color: C.green, fontWeight: 600 }}>
                ✓ {students.filter(s => form.assignedStreams.includes(s.stream) && s.status === "active").length} active students will see this test
              </div>
            )}
          </div>
        )}

        {/* Individual student picker */}
        {form.assignType === "students" && (
          <div>
            <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Pick specific students:</div>
            <input value={studentSearch} onChange={e => setStudentSearch(e.target.value)} placeholder="Search by name, email, or phone..."
              style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 12, marginBottom: 8, boxSizing: "border-box" }} />
            {/* Selected students badges */}
            {form.assignedStudentIds.length > 0 && (
              <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginBottom: 8 }}>
                {form.assignedStudentIds.map(sid => {
                  const st = students.find(s => s.id === sid);
                  if (!st) return null;
                  return (
                    <span key={sid} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "4px 10px", borderRadius: 16, background: C.primary, color: "#fff", fontSize: 11, fontWeight: 600 }}>
                      {st.name}
                      <span onClick={() => update("assignedStudentIds", form.assignedStudentIds.filter(id => id !== sid))} style={{ cursor: "pointer", fontSize: 10, opacity: 0.8 }}>✕</span>
                    </span>
                  );
                })}
                <span style={{ fontSize: 11, color: C.primary, fontWeight: 700, padding: "4px 8px" }}>{form.assignedStudentIds.length} selected</span>
              </div>
            )}
            {/* Student list */}
            <div style={{ maxHeight: 200, overflowY: "auto", border: `1px solid ${C.gray200}`, borderRadius: 8 }}>
              {students.filter(s => s.status === "active").filter(s => {
                if (!studentSearch) return true;
                const q = studentSearch.toLowerCase();
                return s.name.toLowerCase().includes(q) || s.email.toLowerCase().includes(q) || s.phone.includes(q) || s.course.toLowerCase().includes(q);
              }).map(s => {
                const sel = form.assignedStudentIds.includes(s.id);
                return (
                  <div key={s.id} onClick={() => update("assignedStudentIds", sel ? form.assignedStudentIds.filter(id => id !== s.id) : [...form.assignedStudentIds, s.id])}
                    style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 12px", cursor: "pointer",
                      background: sel ? C.blue50 : "transparent", borderBottom: `1px solid ${C.gray100}`, transition: "background 0.1s" }}>
                    <input type="checkbox" checked={sel} readOnly style={{ accentColor: C.primary, width: 14, height: 14, pointerEvents: "none" }} />
                    <div style={{ flex: 1 }}>
                      <span style={{ fontSize: 13, fontWeight: 600, color: C.gray800 }}>{s.name}</span>
                      <span style={{ fontSize: 11, color: C.gray400, marginLeft: 8 }}>{s.email}</span>
                    </div>
                    <Badge label={s.course} color={C.primary} bg={C.blue50} />
                    <Badge label={s.stream} color={C.purple} bg={C.purpleBg} />
                  </div>
                );
              })}
              {students.filter(s => s.status === "active").length === 0 && (
                <div style={{ padding: 20, textAlign: "center", fontSize: 12, color: C.gray400 }}>No active students</div>
              )}
            </div>
            {/* Quick select by course */}
            <div style={{ marginTop: 8, display: "flex", flexWrap: "wrap", gap: 4, alignItems: "center" }}>
              <span style={{ fontSize: 11, color: C.gray500, fontWeight: 600 }}>Quick add by course:</span>
              {courses.filter(c => students.some(s => s.course === c.value && s.status === "active")).map(c => (
                <button key={c.value} onClick={() => {
                  const courseStudentIds = students.filter(s => s.course === c.value && s.status === "active").map(s => s.id);
                  const merged = [...new Set([...form.assignedStudentIds, ...courseStudentIds])];
                  update("assignedStudentIds", merged);
                }} style={{ background: C.blue50, border: `1px solid ${C.primary}30`, borderRadius: 12, padding: "3px 10px", cursor: "pointer", fontSize: 10, fontWeight: 600, color: C.primary }}>
                  + {c.value}
                </button>
              ))}
              {form.assignedStudentIds.length > 0 && (
                <button onClick={() => update("assignedStudentIds", [])} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 10, color: C.red, fontWeight: 600 }}>Clear all</button>
              )}
            </div>
          </div>
        )}

        {/* Summary for "all" */}
        {form.assignType === "all" && (
          <div style={{ fontSize: 12, color: C.gray500, padding: "4px 0" }}>All {students.filter(s => s.status === "active").length} active students will see this test.</div>
        )}
      </Card>}

      {/* Teacher notice */}
      {userRole === "teacher" && (
        <Card style={{ padding: 16, background: "#fef3c720", border: `1.5px solid #d9770630` }}>
          <div style={{ fontSize: 13, fontWeight: 700, color: "#d97706", marginBottom: 6 }}>📤 Teacher Submission Mode</div>
          <div style={{ fontSize: 12, color: C.gray600, lineHeight: 1.6 }}>
            Your test will be submitted for <strong>admin approval</strong>. Once approved, the admin will assign it to students and publish it. You can track the status in <strong>My Tests</strong>.
          </div>
        </Card>
      )}
    </>
  );
  // ═══ PREVIEW PANEL (shared right side) ═══
  const PreviewPanel = () => (
    <Card style={{ padding: 0, overflow: "hidden" }}>
      <div style={{ padding: "14px 18px", borderBottom: `1px solid ${C.gray200}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
        <div>
          <div style={{ fontWeight: 700, color: C.gray800, fontSize: 15 }}>
            {createMethod === "auto" ? "Generated Preview" : createMethod === "upload" ? "CSV Preview" : "Selected Questions"}
          </div>
          <div style={{ fontSize: 12, color: C.gray400 }}>{previewQs.length} questions ready</div>
        </div>
        <div style={{ display: "flex", gap: 6 }}>
          {createMethod === "auto" && previewQs.length > 0 && <Btn variant="outline" onClick={handleGenerate} style={{ fontSize: 11, padding: "5px 10px" }}>🔄 Regenerate</Btn>}
          {createMethod === "manual" && previewQs.length > 0 && <Btn variant="outline" onClick={() => setSelectedIds(new Set())} style={{ fontSize: 11, padding: "5px 10px" }}>Clear All</Btn>}
          {createMethod === "upload" && previewQs.length > 0 && <Btn variant="outline" onClick={() => { setCsvPreview([]); setCsvText(""); setCsvError(""); }} style={{ fontSize: 11, padding: "5px 10px" }}>Clear</Btn>}
          <Btn variant={userRole === "teacher" ? "primary" : "success"} onClick={handleSave} style={{ fontSize: 11, padding: "5px 12px", background: userRole === "teacher" ? "#d97706" : undefined }}>{userRole === "teacher" ? "📤 Submit for Approval" : "💾 Save as Draft"}</Btn>
        </div>
      </div>
      {/* Stats bar */}
      <div style={{ padding: "8px 18px", background: C.gray50, display: "flex", gap: 8, flexWrap: "wrap", borderBottom: `1px solid ${C.gray100}`, alignItems: "center" }}>
        {SUBJECTS.map(s => { const ct = previewQs.filter(q => q.subject_id === s.id).length; return ct > 0 ? <Badge key={s.id} label={`${s.code}: ${ct}`} color={C.primary} bg={C.blue50} /> : null; })}
        {["easy", "medium", "hard"].map(d => { const ct = previewQs.filter(q => q.difficulty === d).length; return ct > 0 ? <Badge key={d} label={`${d[0].toUpperCase()}:${ct}`} color={d==="easy"?C.green:d==="hard"?C.red:C.orange} bg={d==="easy"?C.greenBg:d==="hard"?C.redBg:C.orangeBg} /> : null; })}
        <span style={{ fontSize: 11, color: C.gray500, fontWeight: 600, marginLeft: "auto" }}>Total: {previewQs.length}</span>
      </div>
      {/* Assignment & access level summary */}
      <div style={{ padding: "6px 18px", background: form.assignType === "all" ? C.greenBg : form.assignType === "course" ? C.blue50 : form.assignType === "stream" ? C.purpleBg : C.orangeBg, borderBottom: `1px solid ${C.gray100}`, fontSize: 11, fontWeight: 600, display: "flex", alignItems: "center", gap: 6, justifyContent: "space-between" }}>
        <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
          <span>🎯</span>
          {form.assignType === "all" && <span style={{ color: C.green }}>Assigned to all {students.filter(s => s.status === "active").length} active students</span>}
          {form.assignType === "course" && <span style={{ color: C.primary }}>Assigned to {form.assignedCourses.length} course{form.assignedCourses.length !== 1 ? "s" : ""}: {form.assignedCourses.join(", ") || "none selected"}</span>}
          {form.assignType === "stream" && <span style={{ color: C.purple }}>Assigned to {form.assignedStreams.length} stream{form.assignedStreams.length !== 1 ? "s" : ""}: {form.assignedStreams.join(", ") || "none selected"}</span>}
          {form.assignType === "students" && <span style={{ color: C.orange }}>Assigned to {form.assignedStudentIds.length} specific student{form.assignedStudentIds.length !== 1 ? "s" : ""}</span>}
        </div>
        <span style={{ padding: "2px 10px", borderRadius: 10, background: form.accessLevel === "prime" ? "#fef3c7" : C.greenBg, color: form.accessLevel === "prime" ? "#d97706" : C.green, fontWeight: 800, fontSize: 10 }}>
          {form.accessLevel === "prime" ? "⭐ PRIME ONLY" : "🆓 FREE ACCESS"}
        </span>
      </div>
      {/* Question list */}
      <div style={{ maxHeight: 520, overflowY: "auto" }}>
        {previewQs.map((q, i) => {
          const sub = SUBJECTS.find(s => s.id === q.subject_id);
          return (
            <div key={q.id || i} style={{ padding: "9px 18px", borderBottom: `1px solid ${C.gray100}`, display: "flex", gap: 8, alignItems: "flex-start" }}>
              <span style={{ fontSize: 11, fontWeight: 800, color: C.gray400, minWidth: 24 }}>{i + 1}.</span>
              <div style={{ flex: 1 }}>
                <div style={{ fontSize: 13, color: C.gray800, lineHeight: 1.5, marginBottom: 3 }}>{q.question_text}</div>
                <div style={{ display: "flex", gap: 4 }}>
                  {sub && <Badge label={sub.code} color={C.primary} bg={C.blue50} />}
                  {q.chapter && <Badge label={q.chapter} color={C.gray500} bg={C.gray100} />}
                  <Badge label={q.difficulty || "medium"} color={(q.difficulty||"medium")==="easy"?C.green:(q.difficulty||"medium")==="hard"?C.red:C.orange} bg={(q.difficulty||"medium")==="easy"?C.greenBg:(q.difficulty||"medium")==="hard"?C.redBg:C.orangeBg} />
                </div>
              </div>
              {createMethod === "manual" && <button onClick={() => toggleSelect(q.id)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 13, color: C.red, flexShrink: 0 }}>✕</button>}
            </div>
          );
        })}
        {previewQs.length === 0 && (
          <div style={{ textAlign: "center", padding: "60px 20px", color: C.gray400 }}>
            <div style={{ fontSize: 36, marginBottom: 8, opacity: 0.3 }}>{createMethod === "auto" ? "⚙️" : createMethod === "upload" ? "📄" : "☑️"}</div>
            <div style={{ fontSize: 14, fontWeight: 600 }}>{createMethod === "auto" ? "Configure & click Generate" : createMethod === "upload" ? "Upload a CSV file" : "Select questions from the bank"}</div>
          </div>
        )}
      </div>
    </Card>
  );

  // ═══ TAB 1: AUTO GENERATE ═══
  const AutoTab = () => (
    <>
      <Card style={{ marginBottom: 14 }}>
        <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 10 }}>Subject Selection</h3>
        <Input label="Total Questions" value={form.totalQuestions} onChange={v => update("totalQuestions", v)} type="number" style={{ marginBottom: 8 }} />
        <div style={{ display: "flex", flexDirection: "column", gap: 6 }}>
          {SUBJECTS.map(s => {
            const active = form.subjects.includes(s.id);
            return (
              <div key={s.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 12px", borderRadius: 8, background: active ? C.blue50 : C.gray50, border: `1.5px solid ${active ? C.primary : C.gray200}`, cursor: "pointer" }} onClick={() => toggleSubject(s.id)}>
                <input type="checkbox" checked={active} readOnly style={{ accentColor: C.primary, width: 15, height: 15 }} />
                <div style={{ flex: 1 }}>
                  <span style={{ fontSize: 13, fontWeight: 600, color: active ? C.primary : C.gray700 }}>{s.name}</span>
                  <span style={{ fontSize: 11, color: C.gray400, marginLeft: 6 }}>{getAvail(s.id)} available</span>
                </div>
                {active && <input type="number" value={form.perSubject[s.id] || ""} onClick={e => e.stopPropagation()} onChange={e => setForm(prev => ({ ...prev, perSubject: { ...prev.perSubject, [s.id]: e.target.value } }))} style={{ width: 54, padding: "4px 6px", borderRadius: 5, border: `1.5px solid ${C.gray200}`, fontSize: 12, textAlign: "center" }} placeholder="Qty" />}
              </div>
            );
          })}
        </div>
      </Card>
      <Card style={{ marginBottom: 14 }}>
        <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 8 }}>Difficulty Mix</h3>
        <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10 }}>
          {[["easyPct", "Easy", C.green], ["mediumPct", "Medium", C.orange], ["hardPct", "Hard", C.red]].map(([key, lbl, clr]) => (
            <div key={key}>
              <label style={{ fontSize: 11, fontWeight: 600, color: clr, display: "block", marginBottom: 2 }}>{lbl}</label>
              <input type="range" min="0" max="100" value={form[key]} onChange={e => update(key, e.target.value)} style={{ width: "100%", accentColor: clr }} />
              <div style={{ textAlign: "center", fontSize: 13, fontWeight: 700, color: clr }}>{form[key]}%</div>
            </div>
          ))}
        </div>
      </Card>
      <Btn variant="purple" onClick={handleGenerate} style={{ width: "100%", justifyContent: "center", padding: 12, fontSize: 14 }}>⚡ Auto Generate</Btn>
    </>
  );

  // ═══ TAB 2: CSV UPLOAD FOR THIS TEST ═══
  const buildTemplateRows = () => {
    const selSubjects = SUBJECTS.filter(s => form.subjects.includes(s.id));
    const totalQ = Number(form.totalQuestions) || 15;
    const defPer = Math.max(1, Math.floor(totalQ / Math.max(selSubjects.length, 1)));
    const rows = [];
    selSubjects.forEach(sub => {
      const chapters = CHAPTERS[sub.id] || [];
      const count = Number(form.perSubject[sub.id]) || defPer;
      const eN = Math.ceil(count * Number(form.easyPct || 30) / 100);
      const hN = Math.ceil(count * Number(form.hardPct || 30) / 100);
      const mN = Math.max(0, count - eN - hN);
      let idx = 0;
      const addRows = (n, diff) => { for (let i = 0; i < n; i++) { const ch = chapters[idx % Math.max(chapters.length, 1)] || "General"; rows.push({ subject: sub.name, chapter: ch, difficulty: diff, question_text: "", option_a: "", option_b: "", option_c: "", option_d: "", correct_option: 0, solution: "" }); idx++; } };
      addRows(eN, "easy"); addRows(mN, "medium"); addRows(hN, "hard");
    });
    if (rows.length === 0) for (let i = 0; i < totalQ; i++) rows.push({ subject: "", chapter: "", difficulty: "medium", question_text: "", option_a: "", option_b: "", option_c: "", option_d: "", correct_option: 0, solution: "" });
    return rows;
  };

  const templateRows = buildTemplateRows();

  const downloadTestTemplate = () => {
    const testName = form.name || "Untitled_Test";
    const header = "subject,chapter,difficulty,question_text,option_a,option_b,option_c,option_d,correct_option,solution";
    const csvRows = templateRows.map(r => `${r.subject},${r.chapter},${r.difficulty},${r.question_text || "Enter question here"},${r.option_a || "Option A"},${r.option_b || "Option B"},${r.option_c || "Option C"},${r.option_d || "Option D"},${r.correct_option},${r.solution || ""}`);
    const csv = [header, ...csvRows].join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href = url;
    a.download = `${testName.replace(/[^a-zA-Z0-9_ ]/g, "").replace(/\s+/g, "_")}_template.csv`;
    a.click(); URL.revokeObjectURL(url);
  };

  const copyTemplateToClipboard = () => {
    const header = "subject,chapter,difficulty,question_text,option_a,option_b,option_c,option_d,correct_option,solution";
    const csvRows = templateRows.map(r => `${r.subject},${r.chapter},${r.difficulty},${r.question_text || "Enter question here"},${r.option_a || "Option A"},${r.option_b || "Option B"},${r.option_c || "Option C"},${r.option_d || "Option D"},${r.correct_option},${r.solution || ""}`);
    navigator.clipboard?.writeText([header, ...csvRows].join("\n")).then(() => alert("Template copied to clipboard!"));
  };

  const [showTemplatePreview, setShowTemplatePreview] = useState(false);

  const UploadTab = () => {
    const selSubjects = SUBJECTS.filter(s => form.subjects.includes(s.id));
    const totalQ = Number(form.totalQuestions) || 15;
    const modeLbl = modes.find(m => m.value === form.mode)?.label || form.mode;
    const streamLbl = streams.find(s => s.value === form.stream)?.label || form.stream;

    return (
    <>
      {/* STEP-BY-STEP WORKFLOW */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8, marginBottom: 14 }}>
        {[
          { step: "1", icon: "📋", title: "Download Template", desc: "Get pre-filled CSV for this test" },
          { step: "2", icon: "✏️", title: "Fill Questions", desc: "Add question text & options" },
          { step: "3", icon: "📤", title: "Upload Back", desc: "Import filled CSV below" },
        ].map(s => (
          <div key={s.step} style={{ padding: "10px 12px", borderRadius: 8, background: C.white, border: `1px solid ${C.gray200}`, textAlign: "center" }}>
            <div style={{ fontSize: 20, marginBottom: 2 }}>{s.icon}</div>
            <div style={{ fontSize: 12, fontWeight: 700, color: C.gray800 }}>Step {s.step}: {s.title}</div>
            <div style={{ fontSize: 10, color: C.gray400, marginTop: 1 }}>{s.desc}</div>
          </div>
        ))}
      </div>

      {/* TEMPLATE CARD */}
      <Card style={{ marginBottom: 14, padding: 0, overflow: "hidden", border: `2px solid ${C.primary}25` }}>
        {/* Header */}
        <div style={{ padding: "14px 18px", background: `linear-gradient(135deg, ${C.blue50}, #eef4ff)`, borderBottom: `1px solid ${C.blue100}` }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
            <div>
              <div style={{ fontSize: 15, fontWeight: 800, color: C.primary }}>📋 Template: {form.name || "Untitled Test"}</div>
              <div style={{ fontSize: 12, color: C.gray500, marginTop: 2 }}>Pre-configured with {templateRows.length} rows · subjects, chapters & difficulty pre-filled</div>
            </div>
            <div style={{ display: "flex", gap: 6 }}>
              <Btn variant="outline" onClick={copyTemplateToClipboard} style={{ fontSize: 11, padding: "6px 12px" }}>📋 Copy</Btn>
              <Btn variant="primary" onClick={downloadTestTemplate} style={{ fontSize: 12, padding: "7px 16px" }}>⬇ Download .csv</Btn>
            </div>
          </div>

          {/* Test config summary */}
          <div style={{ background: C.white, borderRadius: 8, padding: "10px 14px", border: `1px solid ${C.gray200}` }}>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 8, marginBottom: 8 }}>
              {[
                ["Test", form.name || "—"],
                ["Total", `${templateRows.length} Q`],
                ["Mode", modeLbl],
                ["Stream", streamLbl],
              ].map(([lbl, val]) => (
                <div key={lbl} style={{ display: "flex", flexDirection: "column" }}>
                  <span style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", letterSpacing: 0.4 }}>{lbl}</span>
                  <span style={{ fontSize: 12, fontWeight: 700, color: C.gray800, marginTop: 1 }}>{val}</span>
                </div>
              ))}
            </div>

            {/* Per-subject breakdown */}
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
              {selSubjects.map(s => {
                const count = templateRows.filter(r => r.subject === s.name).length;
                const eC = templateRows.filter(r => r.subject === s.name && r.difficulty === "easy").length;
                const mC = templateRows.filter(r => r.subject === s.name && r.difficulty === "medium").length;
                const hC = templateRows.filter(r => r.subject === s.name && r.difficulty === "hard").length;
                const chapters = [...new Set(templateRows.filter(r => r.subject === s.name).map(r => r.chapter))];
                return (
                  <div key={s.id} style={{ background: C.blue50, border: `1px solid ${C.blue100}`, borderRadius: 8, padding: "8px 12px", flex: "1 1 auto", minWidth: 170 }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
                      <span style={{ fontSize: 13, fontWeight: 700, color: C.primary }}>{s.name}</span>
                      <Badge label={`${count} Q`} color={C.primary} bg={C.blue100} />
                    </div>
                    <div style={{ fontSize: 10, color: C.gray500, marginBottom: 4, lineHeight: 1.4 }}>
                      Chapters: {chapters.slice(0, 3).join(", ")}{chapters.length > 3 ? ` +${chapters.length - 3}` : ""}
                    </div>
                    <div style={{ display: "flex", gap: 3 }}>
                      <Badge label={`E:${eC}`} color={C.green} bg={C.greenBg} />
                      <Badge label={`M:${mC}`} color={C.orange} bg={C.orangeBg} />
                      <Badge label={`H:${hC}`} color={C.red} bg={C.redBg} />
                    </div>
                  </div>
                );
              })}
              {selSubjects.length === 0 && (
                <div style={{ fontSize: 12, color: C.orange, fontWeight: 600, padding: 6 }}>⚠ No subjects selected — template will have {totalQ} generic rows. Select subjects in Test Info for a specific template.</div>
              )}
            </div>
          </div>
        </div>

        {/* LIVE TEMPLATE PREVIEW TABLE */}
        <div style={{ borderBottom: `1px solid ${C.gray200}` }}>
          <button onClick={() => setShowTemplatePreview(!showTemplatePreview)}
            style={{ width: "100%", padding: "10px 18px", background: C.gray50, border: "none", cursor: "pointer", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span style={{ fontSize: 12, fontWeight: 700, color: C.gray600 }}>👁 Preview Template ({templateRows.length} rows)</span>
            <span style={{ fontSize: 11, color: C.gray400, transition: "transform 0.2s", transform: showTemplatePreview ? "rotate(180deg)" : "none" }}>▼</span>
          </button>
          {showTemplatePreview && (
            <div style={{ maxHeight: 280, overflowY: "auto", overflowX: "auto" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11, minWidth: 700 }}>
                <thead>
                  <tr style={{ background: C.blue50, position: "sticky", top: 0 }}>
                    {["#", "Subject", "Chapter", "Difficulty", "Question Text", "Opt A", "Opt B", "Opt C", "Opt D", "Ans"].map(h => (
                      <th key={h} style={{ padding: "7px 8px", textAlign: "left", fontSize: 10, fontWeight: 700, color: C.primary, textTransform: "uppercase", borderBottom: `2px solid ${C.primary}30`, whiteSpace: "nowrap" }}>{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {templateRows.map((r, i) => (
                    <tr key={i} style={{ borderBottom: `1px solid ${C.gray100}`, background: i % 2 === 0 ? "transparent" : C.gray50 }}>
                      <td style={{ padding: "6px 8px", fontWeight: 700, color: C.gray400 }}>{i + 1}</td>
                      <td style={{ padding: "6px 8px" }}><Badge label={SUBJECTS.find(s => s.name === r.subject)?.code || "—"} color={C.primary} bg={C.blue50} /></td>
                      <td style={{ padding: "6px 8px", color: C.gray600, maxWidth: 100, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.chapter || "—"}</td>
                      <td style={{ padding: "6px 8px" }}><Badge label={r.difficulty} color={r.difficulty==="easy"?C.green:r.difficulty==="hard"?C.red:C.orange} bg={r.difficulty==="easy"?C.greenBg:r.difficulty==="hard"?C.redBg:C.orangeBg} /></td>
                      <td style={{ padding: "6px 8px", color: C.gray400, fontStyle: "italic" }}>Fill in...</td>
                      <td style={{ padding: "6px 8px", color: C.gray300 }}>A</td>
                      <td style={{ padding: "6px 8px", color: C.gray300 }}>B</td>
                      <td style={{ padding: "6px 8px", color: C.gray300 }}>C</td>
                      <td style={{ padding: "6px 8px", color: C.gray300 }}>D</td>
                      <td style={{ padding: "6px 8px", color: C.gray300 }}>0</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>

        {/* Column legend */}
        <div style={{ padding: "10px 18px", background: C.gray50 }}>
          <div style={{ fontSize: 10, fontWeight: 700, color: C.gray500, marginBottom: 4, textTransform: "uppercase" }}>CSV Columns</div>
          <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
            {[
              { col: "subject", req: true, clr: C.primary, bg: C.blue50, note: "Pre-filled" },
              { col: "chapter", req: true, clr: C.primary, bg: C.blue50, note: "Pre-filled" },
              { col: "difficulty", req: true, clr: C.primary, bg: C.blue50, note: "Pre-filled" },
              { col: "question_text", req: true, clr: C.purple, bg: C.purpleBg, note: "You fill" },
              { col: "option_a", req: true, clr: C.purple, bg: C.purpleBg, note: "You fill" },
              { col: "option_b", req: true, clr: C.purple, bg: C.purpleBg, note: "You fill" },
              { col: "option_c", req: true, clr: C.purple, bg: C.purpleBg, note: "You fill" },
              { col: "option_d", req: true, clr: C.purple, bg: C.purpleBg, note: "You fill" },
              { col: "correct_option", req: true, clr: C.green, bg: C.greenBg, note: "0-3" },
              { col: "solution", req: false, clr: C.gray500, bg: C.gray100, note: "Optional" },
            ].map(c => (
              <span key={c.col} style={{ fontSize: 10, padding: "2px 7px", borderRadius: 4, fontFamily: "monospace", fontWeight: 600, background: c.bg, color: c.clr, position: "relative" }}
                title={c.note}>
                {c.col}
                {c.req && <span style={{ color: C.red, marginLeft: 1 }}>*</span>}
              </span>
            ))}
          </div>
          <div style={{ fontSize: 10, color: C.gray400, marginTop: 4, display: "flex", gap: 12 }}>
            <span><Badge label="Pre-filled" color={C.primary} bg={C.blue50} /> = auto-filled in template</span>
            <span><Badge label="You fill" color={C.purple} bg={C.purpleBg} /> = you enter these</span>
            <span>correct_option: <strong>0</strong>=A <strong>1</strong>=B <strong>2</strong>=C <strong>3</strong>=D</span>
          </div>
        </div>
      </Card>

      {/* UPLOAD ZONE */}
      <Card style={{ marginBottom: 14 }}>
        <div style={{ fontSize: 13, fontWeight: 700, color: C.gray700, marginBottom: 8 }}>Step 3: Upload Filled Template</div>
        <div onClick={() => fileRef.current?.click()}
          style={{ border: `2px dashed ${C.gray300}`, borderRadius: 10, padding: "28px 16px", textAlign: "center", cursor: "pointer", background: C.gray50 }}
          onDragOver={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.primary; e.currentTarget.style.background = C.blue50; }}
          onDragLeave={e => { e.currentTarget.style.borderColor = C.gray300; e.currentTarget.style.background = C.gray50; }}
          onDrop={e => { e.preventDefault(); e.currentTarget.style.borderColor = C.gray300; e.currentTarget.style.background = C.gray50; const f = e.dataTransfer.files[0]; if (f) { const r = new FileReader(); r.onload = ev => { setCsvText(ev.target.result); processCSV(ev.target.result); }; r.readAsText(f); } }}>
          <div style={{ fontSize: 28, marginBottom: 4 }}>📤</div>
          <div style={{ fontSize: 14, fontWeight: 600, color: C.gray700 }}>Drop filled CSV here or click to browse</div>
          <div style={{ fontSize: 11, color: C.gray400, marginTop: 2 }}>.csv files · questions go directly into this test</div>
          <input ref={fileRef} type="file" accept=".csv" onChange={handleCSVFile} style={{ display: "none" }} />
        </div>
        <div style={{ marginTop: 10, textAlign: "center", fontSize: 12, color: C.gray400 }}>— or paste CSV text —</div>
        <Textarea label="" value={csvText} onChange={v => { setCsvText(v); if (v.trim()) processCSV(v); else { setCsvPreview([]); setCsvError(""); } }} rows={4} placeholder="Paste CSV content here..." />
      </Card>

      {csvError && <div style={{ background: C.redBg, border: `1px solid ${C.red}`, borderRadius: 8, padding: "10px 14px", marginBottom: 12, color: C.red, fontWeight: 600, fontSize: 13 }}>✗ {csvError}</div>}

      {/* UPLOADED CSV VALIDATION TABLE */}
      {csvPreview.length > 0 && (
        <Card style={{ padding: 0, overflow: "hidden", marginBottom: 14 }}>
          <div style={{ padding: "10px 16px", background: C.greenBg, borderBottom: `1px solid ${C.green}30`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <span style={{ color: C.green, fontWeight: 600, fontSize: 13 }}>✓ {csvPreview.filter(r => !r._error).length} valid questions {csvPreview.some(r => r._error) && `· ${csvPreview.filter(r => r._error).length} errors`}</span>
            <span style={{ fontSize: 11, color: C.gray500 }}>These questions will be added to the test</span>
          </div>
          <div style={{ maxHeight: 240, overflowY: "auto" }}>
            <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 12 }}>
              <thead>
                <tr style={{ background: C.gray50, position: "sticky", top: 0 }}>
                  {["#", "Question", "Subject", "Chapter", "Difficulty", "Ans", "Status"].map(h => (
                    <th key={h} style={{ padding: "8px 10px", textAlign: "left", fontSize: 10, fontWeight: 700, color: C.gray400, textTransform: "uppercase" }}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {csvPreview.map((r, i) => (
                  <tr key={i} style={{ borderBottom: `1px solid ${C.gray100}`, background: r._error ? C.redBg : "transparent" }}>
                    <td style={{ padding: "8px 10px", color: C.gray400, fontWeight: 700 }}>{r._line}</td>
                    <td style={{ padding: "8px 10px", maxWidth: 180, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", fontWeight: 500 }}>{r.question_text}</td>
                    <td style={{ padding: "8px 10px" }}>{r.subject ? <Badge label={SUBJECTS.find(s => s.name.toLowerCase() === r.subject.toLowerCase())?.code || r.subject} color={C.primary} bg={C.blue50} /> : "—"}</td>
                    <td style={{ padding: "8px 10px", fontSize: 11, color: C.gray600 }}>{r.chapter || "—"}</td>
                    <td style={{ padding: "8px 10px" }}><Badge label={r.difficulty || "medium"} color={(r.difficulty||"medium")==="easy"?C.green:(r.difficulty||"medium")==="hard"?C.red:C.orange} bg={(r.difficulty||"medium")==="easy"?C.greenBg:(r.difficulty||"medium")==="hard"?C.redBg:C.orangeBg} /></td>
                    <td style={{ padding: "8px 10px", fontWeight: 600 }}>{["A","B","C","D"][r.correct_option] || "?"}</td>
                    <td style={{ padding: "8px 10px" }}>{r._error ? <span style={{ color: C.red, fontWeight: 600, fontSize: 11 }}>✗ {r._error}</span> : <span style={{ color: C.green, fontWeight: 600 }}>✓ Valid</span>}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      )}
    </>
  );
  };

  // ═══ TAB 3: MANUAL SELECT ═══
  const ManualTab = () => {
    const allIds = filteredManual.map(q => q.id);
    const allChecked = allIds.length > 0 && allIds.every(id => selectedIds.has(id));
    return (
      <>
        {/* Counter bar */}
        <div style={{ background: selectedIds.size > 0 ? C.greenBg : C.gray100, border: `1px solid ${selectedIds.size > 0 ? C.green : C.gray200}`, borderRadius: 10, padding: "10px 14px", marginBottom: 12, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 14, fontWeight: 700, color: selectedIds.size > 0 ? C.green : C.gray500 }}>
            {selectedIds.size > 0 ? `☑ ${selectedIds.size} question${selectedIds.size !== 1 ? "s" : ""} selected` : "No questions selected"}
          </span>
          {selectedIds.size > 0 && <button onClick={() => setSelectedIds(new Set())} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.red, fontWeight: 600 }}>Clear</button>}
        </div>

        {/* Filters */}
        <Card style={{ padding: 12, marginBottom: 12 }}>
          <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr 1fr", gap: 8, alignItems: "end" }}>
            <Input label="Search" value={mfSearch} onChange={setMfSearch} placeholder="Search questions..." style={{ marginBottom: 0 }} />
            <Select label="Subject" value={mfSubject} onChange={v => { setMfSubject(v); setMfChapter(""); }} options={SUBJECTS.map(s => ({ value: s.id, label: s.name }))} style={{ marginBottom: 0 }} />
            <Select label="Chapter" value={mfChapter} onChange={setMfChapter} options={mfSubject ? (CHAPTERS[Number(mfSubject)] || []) : []} style={{ marginBottom: 0 }} />
            <Select label="Difficulty" value={mfDiff} onChange={setMfDiff} options={["easy", "medium", "hard"]} style={{ marginBottom: 0 }} />
          </div>
        </Card>

        {/* Bulk actions */}
        <div style={{ display: "flex", gap: 8, marginBottom: 8, alignItems: "center" }}>
          <Btn variant={allChecked ? "outline" : "primary"} onClick={() => allChecked ? deselectAll(allIds) : selectAll(allIds)} style={{ fontSize: 12, padding: "6px 12px" }}>
            {allChecked ? "☐ Deselect All" : `☑ Select All (${filteredManual.length})`}
          </Btn>
          {SUBJECTS.map(s => {
            const subIds = filteredManual.filter(q => q.subject_id === s.id).map(q => q.id);
            if (subIds.length === 0) return null;
            const allSubSel = subIds.every(id => selectedIds.has(id));
            return (
              <Btn key={s.id} variant="outline" onClick={() => allSubSel ? deselectAll(subIds) : selectAll(subIds)} style={{ fontSize: 11, padding: "4px 10px", color: allSubSel ? C.primary : C.gray500, borderColor: allSubSel ? C.primary : C.gray300 }}>
                {allSubSel ? "−" : "+"} {s.code} ({subIds.length})
              </Btn>
            );
          })}
        </div>

        {/* Question list */}
        <div style={{ maxHeight: 460, overflowY: "auto", border: `1px solid ${C.gray200}`, borderRadius: 10, background: C.white }}>
          {filteredManual.map(q => {
            const sub = SUBJECTS.find(s => s.id === q.subject_id);
            const checked = selectedIds.has(q.id);
            return (
              <div key={q.id} onClick={() => toggleSelect(q.id)}
                style={{ padding: "9px 14px", borderBottom: `1px solid ${C.gray100}`, display: "flex", gap: 8, alignItems: "flex-start", cursor: "pointer", background: checked ? C.blue50 : "transparent", transition: "background 0.1s" }}>
                <input type="checkbox" checked={checked} readOnly style={{ accentColor: C.primary, width: 16, height: 16, marginTop: 2, flexShrink: 0 }} />
                <span style={{ fontSize: 11, fontWeight: 800, color: C.gray400, minWidth: 26 }}>#{q.id}</span>
                <div style={{ flex: 1 }}>
                  <div style={{ fontSize: 13, color: C.gray800, lineHeight: 1.5, marginBottom: 3 }}>{q.question_text}</div>
                  <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                    <Badge label={sub?.code} color={C.primary} bg={checked ? C.blue100 : C.blue50} />
                    <Badge label={q.chapter} color={C.gray500} bg={C.gray100} />
                    <Badge label={q.difficulty} color={q.difficulty==="easy"?C.green:q.difficulty==="hard"?C.red:C.orange} bg={q.difficulty==="easy"?C.greenBg:q.difficulty==="hard"?C.redBg:C.orangeBg} />
                  </div>
                </div>
                {checked && <span style={{ color: C.primary, fontSize: 15, fontWeight: 700, flexShrink: 0 }}>✓</span>}
              </div>
            );
          })}
          {filteredManual.length === 0 && <div style={{ textAlign: "center", padding: 36, color: C.gray400, fontSize: 13 }}>No questions match filters</div>}
        </div>
      </>
    );
  };

  // ═══ RENDER ═══
  const tabs = [
    { id: "auto", icon: "⚡", label: "Auto Generate", desc: "Random pick by rules" },
    { id: "upload", icon: "📄", label: "Upload CSV", desc: "Import for this test" },
    { id: "manual", icon: "☑️", label: "Manual Select", desc: "Hand-pick questions" },
  ];

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900 }}>Create Test</h1>
        {previewQs.length > 0 && <Badge label={`${previewQs.length} questions ready`} color={C.green} bg={C.greenBg} />}
      </div>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 14 }}>Choose how to add questions, configure settings, and save</p>

      {saved && <div style={{ background: userRole === "teacher" ? C.orangeBg : C.greenBg, border: `1px solid ${userRole === "teacher" ? C.orange : C.green}`, borderRadius: 10, padding: "12px 18px", marginBottom: 14, color: userRole === "teacher" ? C.orange : C.green, fontWeight: 600, fontSize: 14 }}>
        {userRole === "teacher" ? "📤 Test submitted for admin approval! You can track it in My Tests." : "✓ Test saved as draft!"}
      </div>}

      {/* Method tabs */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 18 }}>
        {tabs.map(t => {
          const active = createMethod === t.id;
          return (
            <div key={t.id} onClick={() => setCreateMethod(t.id)}
              style={{ padding: "14px 16px", borderRadius: 10, cursor: "pointer", textAlign: "center", transition: "all 0.15s",
                background: active ? C.primary : C.white, color: active ? "#fff" : C.gray700,
                border: `2px solid ${active ? C.primary : C.gray200}`, boxShadow: active ? "0 4px 14px rgba(37,99,235,0.25)" : "none" }}>
              <div style={{ fontSize: 20, marginBottom: 2 }}>{t.icon}</div>
              <div style={{ fontSize: 14, fontWeight: 700 }}>{t.label}</div>
              <div style={{ fontSize: 11, marginTop: 2, opacity: 0.7 }}>{t.desc}</div>
            </div>
          );
        })}
      </div>

      {/* 2-column: config + preview */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
        <div>
          <ConfigPanel />
          {createMethod === "auto" && <AutoTab />}
          {createMethod === "upload" && <UploadTab />}
          {createMethod === "manual" && <ManualTab />}
        </div>
        <div style={{ position: "sticky", top: 72, alignSelf: "start" }}>
          <PreviewPanel />
        </div>
      </div>
    </div>
  );
}


// ═══════════════════════════════════════════
// PAGE: Manage Tests
// ═══════════════════════════════════════════
function ManageTestsPage({ tests, setTests, students, streams, courses }) {
  const [expandedId, setExpandedId] = useState(null);
  const [editAssignId, setEditAssignId] = useState(null); // test id being edited
  const [editAssign, setEditAssign] = useState({ type: "all", courses: [], streams: [], studentIds: [], accessLevel: "free" });
  const [assignSearch, setAssignSearch] = useState("");
  const [filterStatus, setFilterStatus] = useState("");

  const statusColors = {
    active: { color: C.green, bg: C.greenBg, icon: "●" },
    draft: { color: C.orange, bg: C.orangeBg, icon: "📝" },
    upcoming: { color: C.purple, bg: C.purpleBg, icon: "🕐" },
    archived: { color: C.gray500, bg: C.gray100, icon: "📦" },
    pending_approval: { color: "#d97706", bg: "#fef3c7", icon: "⏳" },
    rejected: { color: C.red, bg: C.redBg, icon: "✗" },
  };

  const cycleStatus = (id) => {
    const order = ["draft", "upcoming", "active", "archived"];
    setTests(prev => prev.map(t => {
      if (t.id !== id) return t;
      // Don't cycle pending/rejected tests — use approve/reject instead
      if (t.status === "pending_approval" || t.status === "rejected") return t;
      const idx = order.indexOf(t.status);
      return { ...t, status: order[(idx + 1) % order.length] };
    }));
  };
  const deleteTest = (id) => { setTests(prev => prev.filter(t => t.id !== id)); setExpandedId(null); };

  // Approval workflow
  const [approvalNoteId, setApprovalNoteId] = useState(null);
  const [approvalNoteText, setApprovalNoteText] = useState("");

  const approveTest = (id) => {
    setTests(prev => prev.map(t => t.id === id ? { ...t, status: "active", approvalStatus: "approved", approvalNote: "" } : t));
    setApprovalNoteId(null); setApprovalNoteText("");
  };
  const rejectTest = (id) => {
    if (!approvalNoteText.trim()) return alert("Please add a note explaining why this test is rejected.");
    setTests(prev => prev.map(t => t.id === id ? { ...t, status: "rejected", approvalStatus: "rejected", approvalNote: approvalNoteText.trim() } : t));
    setApprovalNoteId(null); setApprovalNoteText("");
  };
  const resubmitForApproval = (id) => {
    setTests(prev => prev.map(t => t.id === id ? { ...t, status: "pending_approval", approvalStatus: "pending", approvalNote: "" } : t));
  };

  // Start editing assignment
  const startEditAssign = (t) => {
    setEditAssignId(t.id);
    setEditAssign({ type: t.assignType || "all", courses: [...(t.assignedCourses || [])], streams: [...(t.assignedStreams || [])], studentIds: [...(t.assignedStudentIds || [])], accessLevel: t.accessLevel || "free" });
    setAssignSearch("");
  };
  const saveAssign = (id) => {
    setTests(prev => prev.map(t => t.id === id ? { ...t, assignType: editAssign.type, assignedCourses: editAssign.courses, assignedStreams: editAssign.streams, assignedStudentIds: editAssign.studentIds, accessLevel: editAssign.accessLevel } : t));
    setEditAssignId(null);
  };

  // Count assigned students for a test
  const countAssigned = (t) => {
    if (!t.assignType || t.assignType === "all") return students.filter(s => s.status === "active").length;
    if (t.assignType === "course") return students.filter(s => (t.assignedCourses || []).includes(s.course) && s.status === "active").length;
    if (t.assignType === "stream") return students.filter(s => (t.assignedStreams || []).includes(s.stream) && s.status === "active").length;
    if (t.assignType === "students") return (t.assignedStudentIds || []).length;
    return 0;
  };

  const assignLabel = (t) => {
    if (!t.assignType || t.assignType === "all") return { text: "All Students", icon: "👥", color: C.green };
    if (t.assignType === "course") return { text: `${(t.assignedCourses || []).length} Course${(t.assignedCourses || []).length !== 1 ? "s" : ""}`, icon: "📚", color: C.primary };
    if (t.assignType === "stream") return { text: `${(t.assignedStreams || []).length} Stream${(t.assignedStreams || []).length !== 1 ? "s" : ""}`, icon: "🎓", color: C.purple };
    if (t.assignType === "students") return { text: `${(t.assignedStudentIds || []).length} Student${(t.assignedStudentIds || []).length !== 1 ? "s" : ""}`, icon: "👤", color: C.orange };
    return { text: "All", icon: "👥", color: C.green };
  };

  const filteredTests = filterStatus ? tests.filter(t => t.status === filterStatus) : tests;

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900 }}>Manage Tests</h1>
        <Badge label={`${tests.length} tests`} color={C.primary} bg={C.blue50} />
      </div>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 18 }}>Manage test status, assignments, and visibility</p>

      {/* Status filter chips */}
      <div style={{ display: "flex", gap: 8, marginBottom: 16, flexWrap: "wrap" }}>
        {["", "pending_approval", "active", "draft", "upcoming", "archived", "rejected"].map(st => {
          const a = filterStatus === st;
          const sc = statusColors[st] || { color: C.gray700 };
          const count = st ? tests.filter(t => t.status === st).length : tests.length;
          if (st && count === 0) return null;
          return (
            <div key={st} onClick={() => setFilterStatus(st)} style={{ padding: "6px 14px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: a ? 700 : 500,
              background: a ? (sc.color || C.gray700) : C.gray50, color: a ? "#fff" : C.gray600,
              border: `1.5px solid ${a ? (sc.color || C.gray700) : C.gray200}`, transition: "all 0.15s",
              position: "relative" }}>
              {st === "pending_approval" ? "⏳ Pending" : st || "All"} ({count})
              {st === "pending_approval" && count > 0 && !a && <span style={{ position: "absolute", top: -4, right: -4, width: 16, height: 16, borderRadius: "50%", background: C.red, color: "#fff", fontSize: 9, fontWeight: 800, display: "flex", alignItems: "center", justifyContent: "center" }}>{count}</span>}
            </div>
          );
        })}
      </div>

      <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        {filteredTests.map(t => {
          const sc = statusColors[t.status] || statusColors.draft;
          const asgn = assignLabel(t);
          const expanded = expandedId === t.id;
          const isEditingAssign = editAssignId === t.id;

          return (
            <Card key={t.id} style={{ padding: 0, overflow: "hidden" }}>
              {/* Main row */}
              <div style={{ padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer", transition: "background 0.1s", background: expanded ? C.gray50 : "transparent" }}
                onClick={() => setExpandedId(expanded ? null : t.id)}>
                <div style={{ flex: 1 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                    <span style={{ padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 700, background: sc.bg, color: sc.color }}>{sc.icon} {t.status}</span>
                    <span style={{ fontSize: 11, color: C.gray400 }}>{t.stream} · {t.mode}</span>
                    {/* Assignment badge */}
                    <span style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 700, background: asgn.color + "15", color: asgn.color }}>
                      {asgn.icon} {asgn.text} ({countAssigned(t)})
                    </span>
                    {/* Access level badge */}
                    <span style={{ padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 700,
                      background: (t.accessLevel === "prime") ? "#fef3c7" : C.greenBg,
                      color: (t.accessLevel === "prime") ? "#d97706" : C.green }}>
                      {(t.accessLevel === "prime") ? "⭐ Prime" : "🆓 Free"}
                    </span>
                  </div>
                  <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, margin: 0 }}>{t.name}</h3>
                  <div style={{ fontSize: 12, color: C.gray400, marginTop: 4 }}>
                    {t.total_questions} Qs · {t.duration_minutes} min · {t.is_free ? "FREE" : `₹${t.price}`} · {t.created_at}
                    {t.createdBy && t.createdBy.role === "teacher" && (
                      <span style={{ marginLeft: 8, padding: "2px 8px", borderRadius: 8, fontSize: 10, fontWeight: 700, background: C.purpleBg, color: C.purple }}>
                        👨‍🏫 {t.createdBy.name}
                      </span>
                    )}
                  </div>
                </div>
                <div style={{ display: "flex", gap: 6, alignItems: "center" }} onClick={e => e.stopPropagation()}>
                  {t.status === "pending_approval" && (
                    <>
                      <Btn variant="success" onClick={() => approveTest(t.id)} style={{ fontSize: 11, padding: "5px 14px" }}>✓ Approve</Btn>
                      <Btn variant="danger" onClick={() => { setApprovalNoteId(approvalNoteId === t.id ? null : t.id); setApprovalNoteText(""); setExpandedId(t.id); }} style={{ fontSize: 11, padding: "5px 14px" }}>✗ Reject</Btn>
                    </>
                  )}
                  {t.status === "rejected" && (
                    <Btn variant="outline" onClick={() => resubmitForApproval(t.id)} style={{ fontSize: 11, padding: "5px 12px", color: "#d97706", borderColor: "#d97706" }}>🔄 Re-submit</Btn>
                  )}
                  {t.status !== "pending_approval" && t.status !== "rejected" && (
                    <Btn variant="outline" onClick={() => cycleStatus(t.id)} style={{ fontSize: 11, padding: "5px 12px" }}>⟳ Status</Btn>
                  )}
                  <Btn variant="outline" onClick={() => { if (isEditingAssign) { setEditAssignId(null); } else startEditAssign(t); }}
                    style={{ fontSize: 11, padding: "5px 12px", color: C.purple, borderColor: C.purple }}>🎯 Assign</Btn>
                  <Btn variant="danger" onClick={() => deleteTest(t.id)} style={{ fontSize: 11, padding: "5px 12px" }}>🗑</Btn>
                </div>
              </div>

              {/* Expanded detail */}
              {(expanded || isEditingAssign) && (
                <div style={{ borderTop: `1px solid ${C.gray200}`, padding: "16px 20px", background: C.gray50 }}>

                  {/* Current assignment info */}
                  {!isEditingAssign && (
                    <div>
                      {/* APPROVAL SECTION — for teacher-created tests */}
                      {t.createdBy && t.createdBy.role === "teacher" && (
                        <div style={{ marginBottom: 14, padding: "14px 16px", borderRadius: 10,
                          background: t.approvalStatus === "pending" ? "#fef3c720" : t.approvalStatus === "rejected" ? `${C.redBg}` : C.greenBg,
                          border: `1.5px solid ${t.approvalStatus === "pending" ? "#d9770630" : t.approvalStatus === "rejected" ? `${C.red}30` : `${C.green}30`}` }}>
                          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
                            <div style={{ fontSize: 13, fontWeight: 700, color: t.approvalStatus === "pending" ? "#d97706" : t.approvalStatus === "rejected" ? C.red : C.green }}>
                              {t.approvalStatus === "pending" ? "⏳ Pending Admin Approval" : t.approvalStatus === "rejected" ? "✗ Rejected" : "✓ Approved"}
                            </div>
                            <span style={{ padding: "3px 10px", borderRadius: 10, fontSize: 11, fontWeight: 700, background: C.purpleBg, color: C.purple }}>
                              👨‍🏫 Created by {t.createdBy.name}
                            </span>
                          </div>

                          {t.approvalStatus === "rejected" && t.approvalNote && (
                            <div style={{ padding: "10px 14px", background: C.white, borderRadius: 8, border: `1px solid ${C.red}20`, marginBottom: 8 }}>
                              <div style={{ fontSize: 11, fontWeight: 700, color: C.red, marginBottom: 4 }}>Rejection Reason:</div>
                              <div style={{ fontSize: 13, color: C.gray700, lineHeight: 1.5 }}>{t.approvalNote}</div>
                            </div>
                          )}

                          {t.approvalStatus === "pending" && (
                            <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
                              <Btn variant="success" onClick={() => approveTest(t.id)} style={{ fontSize: 12, padding: "8px 20px" }}>✓ Approve & Publish</Btn>
                              <Btn variant="danger" onClick={() => { setApprovalNoteId(t.id); setApprovalNoteText(""); }} style={{ fontSize: 12, padding: "8px 20px" }}>✗ Reject with Note</Btn>
                            </div>
                          )}

                          {/* Rejection note form */}
                          {approvalNoteId === t.id && (
                            <div style={{ marginTop: 10, padding: 12, background: C.white, borderRadius: 8, border: `1px solid ${C.red}30` }}>
                              <div style={{ fontSize: 12, fontWeight: 700, color: C.red, marginBottom: 6 }}>✗ Rejection Note (required)</div>
                              <textarea value={approvalNoteText} onChange={e => setApprovalNoteText(e.target.value)}
                                placeholder="Explain what needs to be improved before resubmission..."
                                rows={3} style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: `1.5px solid ${C.gray200}`, fontSize: 13, resize: "vertical", boxSizing: "border-box", fontFamily: "inherit" }} />
                              <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                                <Btn variant="danger" onClick={() => rejectTest(t.id)} style={{ fontSize: 12, padding: "7px 18px" }}>✗ Confirm Rejection</Btn>
                                <button onClick={() => setApprovalNoteId(null)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
                              </div>
                            </div>
                          )}
                        </div>
                      )}

                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                        <span style={{ fontSize: 13, fontWeight: 700, color: C.gray700 }}>🎯 Test Assignment</span>
                        <Btn variant="outline" onClick={() => startEditAssign(t)} style={{ fontSize: 11, padding: "4px 12px", color: C.primary }}>✏️ Edit Assignment</Btn>
                      </div>

                      {(!t.assignType || t.assignType === "all") && (
                        <div style={{ padding: "10px 14px", background: C.greenBg, borderRadius: 8, border: `1px solid ${C.green}30` }}>
                          <span style={{ fontSize: 13, fontWeight: 600, color: C.green }}>👥 Visible to all {students.filter(s => s.status === "active").length} active students</span>
                        </div>
                      )}

                      {t.assignType === "course" && (
                        <div style={{ padding: "10px 14px", background: C.blue50, borderRadius: 8, border: `1px solid ${C.primary}30` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.primary, marginBottom: 6 }}>📚 Assigned to courses:</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
                            {(t.assignedCourses || []).map(c => <Badge key={c} label={c} color={C.primary} bg={C.white} />)}
                          </div>
                          <div style={{ fontSize: 11, color: C.gray500, marginTop: 6 }}>{countAssigned(t)} students can see this test</div>
                        </div>
                      )}

                      {t.assignType === "stream" && (
                        <div style={{ padding: "10px 14px", background: C.purpleBg, borderRadius: 8, border: `1px solid ${C.purple}30` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.purple, marginBottom: 6 }}>🎓 Assigned to streams:</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
                            {(t.assignedStreams || []).map(s => <Badge key={s} label={streams.find(st => st.value === s)?.label || s} color={C.purple} bg={C.white} />)}
                          </div>
                          <div style={{ fontSize: 11, color: C.gray500, marginTop: 6 }}>{countAssigned(t)} students can see this test</div>
                        </div>
                      )}

                      {t.assignType === "students" && (
                        <div style={{ padding: "10px 14px", background: C.orangeBg, borderRadius: 8, border: `1px solid ${C.orange}30` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.orange, marginBottom: 6 }}>👤 Assigned to {(t.assignedStudentIds || []).length} specific students:</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 4 }}>
                            {(t.assignedStudentIds || []).map(sid => {
                              const st = students.find(s => s.id === sid);
                              return st ? <Badge key={sid} label={st.name} color={C.orange} bg={C.white} /> : null;
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Assignment editor */}
                  {isEditingAssign && (
                    <div>
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
                        <span style={{ fontSize: 14, fontWeight: 700, color: C.gray800 }}>🎯 Edit Assignment — {t.name}</span>
                        <div style={{ display: "flex", gap: 6 }}>
                          <Btn variant="success" onClick={() => saveAssign(t.id)} style={{ fontSize: 11, padding: "5px 14px" }}>✓ Save</Btn>
                          <button onClick={() => setEditAssignId(null)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
                        </div>
                      </div>

                      {/* Type selector */}
                      <div style={{ display: "flex", gap: 6, marginBottom: 14 }}>
                        {[
                          { value: "all", label: "All Students", icon: "👥" },
                          { value: "course", label: "By Course", icon: "📚" },
                          { value: "stream", label: "By Stream", icon: "🎓" },
                          { value: "students", label: "Pick Students", icon: "👤" },
                        ].map(opt => {
                          const active = editAssign.type === opt.value;
                          return (
                            <div key={opt.value} onClick={() => setEditAssign(p => ({ ...p, type: opt.value }))}
                              style={{ flex: 1, padding: "10px", borderRadius: 10, cursor: "pointer", textAlign: "center",
                                background: active ? C.primary : C.white, color: active ? "#fff" : C.gray600,
                                border: `1.5px solid ${active ? C.primary : C.gray200}`, transition: "all 0.15s" }}>
                              <div style={{ fontSize: 16 }}>{opt.icon}</div>
                              <div style={{ fontSize: 11, fontWeight: 700, marginTop: 2 }}>{opt.label}</div>
                            </div>
                          );
                        })}
                      </div>

                      {/* Course picker */}
                      {editAssign.type === "course" && (
                        <div style={{ background: C.white, padding: 12, borderRadius: 8, border: `1px solid ${C.gray200}` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 8 }}>Select courses:</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
                            {courses.map(c => {
                              const sel = editAssign.courses.includes(c.value);
                              const ct = students.filter(s => s.course === c.value && s.status === "active").length;
                              return (
                                <div key={c.value} onClick={() => setEditAssign(p => ({ ...p, courses: sel ? p.courses.filter(x => x !== c.value) : [...p.courses, c.value] }))}
                                  style={{ padding: "6px 12px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: sel ? 700 : 500,
                                    background: sel ? C.primary : C.gray50, color: sel ? "#fff" : C.gray600,
                                    border: `1.5px solid ${sel ? C.primary : C.gray200}`, transition: "all 0.15s" }}>
                                  {sel ? "✓ " : ""}{c.value} <span style={{ fontSize: 10, opacity: 0.7 }}>({ct})</span>
                                </div>
                              );
                            })}
                          </div>
                          {editAssign.courses.length > 0 && (
                            <div style={{ marginTop: 8, fontSize: 11, color: C.green, fontWeight: 600 }}>
                              ✓ {students.filter(s => editAssign.courses.includes(s.course) && s.status === "active").length} students will see this test
                            </div>
                          )}
                        </div>
                      )}

                      {/* Stream picker */}
                      {editAssign.type === "stream" && (
                        <div style={{ background: C.white, padding: 12, borderRadius: 8, border: `1px solid ${C.gray200}` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 8 }}>Select streams:</div>
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 5 }}>
                            {streams.map(st => {
                              const sel = editAssign.streams.includes(st.value);
                              const ct = students.filter(s => s.stream === st.value && s.status === "active").length;
                              return (
                                <div key={st.value} onClick={() => setEditAssign(p => ({ ...p, streams: sel ? p.streams.filter(x => x !== st.value) : [...p.streams, st.value] }))}
                                  style={{ padding: "6px 12px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: sel ? 700 : 500,
                                    background: sel ? C.purple : C.gray50, color: sel ? "#fff" : C.gray600,
                                    border: `1.5px solid ${sel ? C.purple : C.gray200}`, transition: "all 0.15s" }}>
                                  {sel ? "✓ " : ""}{st.label} <span style={{ fontSize: 10, opacity: 0.7 }}>({ct})</span>
                                </div>
                              );
                            })}
                          </div>
                          {editAssign.streams.length > 0 && (
                            <div style={{ marginTop: 8, fontSize: 11, color: C.green, fontWeight: 600 }}>
                              ✓ {students.filter(s => editAssign.streams.includes(s.stream) && s.status === "active").length} students will see this test
                            </div>
                          )}
                        </div>
                      )}

                      {/* Student picker */}
                      {editAssign.type === "students" && (
                        <div style={{ background: C.white, padding: 12, borderRadius: 8, border: `1px solid ${C.gray200}` }}>
                          <div style={{ fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Pick students:</div>
                          {/* Selected badges */}
                          {editAssign.studentIds.length > 0 && (
                            <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginBottom: 8 }}>
                              {editAssign.studentIds.map(sid => {
                                const st = students.find(s => s.id === sid);
                                if (!st) return null;
                                return (
                                  <span key={sid} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "4px 10px", borderRadius: 16, background: C.primary, color: "#fff", fontSize: 11, fontWeight: 600 }}>
                                    {st.name}
                                    <span onClick={() => setEditAssign(p => ({ ...p, studentIds: p.studentIds.filter(id => id !== sid) }))} style={{ cursor: "pointer", fontSize: 10, opacity: 0.8 }}>✕</span>
                                  </span>
                                );
                              })}
                              <span style={{ fontSize: 11, color: C.primary, fontWeight: 700, padding: "4px 6px" }}>{editAssign.studentIds.length} selected</span>
                              <button onClick={() => setEditAssign(p => ({ ...p, studentIds: [] }))} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 10, color: C.red }}>Clear</button>
                            </div>
                          )}
                          <input value={assignSearch} onChange={e => setAssignSearch(e.target.value)} placeholder="Search students..."
                            style={{ width: "100%", padding: "7px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 12, marginBottom: 6, boxSizing: "border-box" }} />
                          {/* Quick add by course */}
                          <div style={{ display: "flex", flexWrap: "wrap", gap: 4, marginBottom: 6, alignItems: "center" }}>
                            <span style={{ fontSize: 10, color: C.gray500, fontWeight: 600 }}>Quick add:</span>
                            {courses.filter(c => students.some(s => s.course === c.value && s.status === "active")).map(c => (
                              <button key={c.value} onClick={() => {
                                const ids = students.filter(s => s.course === c.value && s.status === "active").map(s => s.id);
                                setEditAssign(p => ({ ...p, studentIds: [...new Set([...p.studentIds, ...ids])] }));
                              }} style={{ background: C.blue50, border: `1px solid ${C.primary}30`, borderRadius: 12, padding: "2px 8px", cursor: "pointer", fontSize: 10, fontWeight: 600, color: C.primary }}>
                                + {c.value}
                              </button>
                            ))}
                          </div>
                          <div style={{ maxHeight: 180, overflowY: "auto", border: `1px solid ${C.gray100}`, borderRadius: 6 }}>
                            {students.filter(s => s.status === "active").filter(s => {
                              if (!assignSearch) return true;
                              const q = assignSearch.toLowerCase();
                              return s.name.toLowerCase().includes(q) || s.email.toLowerCase().includes(q) || s.course.toLowerCase().includes(q);
                            }).map(s => {
                              const sel = editAssign.studentIds.includes(s.id);
                              return (
                                <div key={s.id} onClick={() => setEditAssign(p => ({ ...p, studentIds: sel ? p.studentIds.filter(id => id !== s.id) : [...p.studentIds, s.id] }))}
                                  style={{ display: "flex", alignItems: "center", gap: 8, padding: "7px 10px", cursor: "pointer",
                                    background: sel ? C.blue50 : "transparent", borderBottom: `1px solid ${C.gray100}` }}>
                                  <input type="checkbox" checked={sel} readOnly style={{ accentColor: C.primary, width: 14, height: 14, pointerEvents: "none" }} />
                                  <span style={{ fontSize: 12, fontWeight: 600, color: C.gray800, flex: 1 }}>{s.name}</span>
                                  <span style={{ fontSize: 10, color: C.gray400 }}>{s.email}</span>
                                  <Badge label={s.course} color={C.primary} bg={C.blue50} />
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {editAssign.type === "all" && (
                        <div style={{ padding: "10px 14px", background: C.greenBg, borderRadius: 8, fontSize: 12, color: C.green, fontWeight: 600 }}>
                          👥 All {students.filter(s => s.status === "active").length} active students will see this test
                        </div>
                      )}

                      {/* Access Level toggle */}
                      <div style={{ marginTop: 12, padding: 12, background: C.white, borderRadius: 8, border: `1px solid ${C.gray200}` }}>
                        <div style={{ fontSize: 12, fontWeight: 700, color: C.gray700, marginBottom: 8 }}>🔒 Access Level</div>
                        <div style={{ display: "flex", gap: 8 }}>
                          {[
                            { value: "free", label: "🆓 Free Access", desc: "All students", color: C.green, bg: C.greenBg },
                            { value: "prime", label: "⭐ Prime Only", desc: "Paid students only", color: "#d97706", bg: "#fef3c7" },
                          ].map(opt => {
                            const active = editAssign.accessLevel === opt.value;
                            return (
                              <div key={opt.value} onClick={() => setEditAssign(p => ({ ...p, accessLevel: opt.value }))}
                                style={{ flex: 1, padding: "8px 12px", borderRadius: 8, cursor: "pointer",
                                  background: active ? opt.bg : C.gray50, border: `2px solid ${active ? opt.color : C.gray200}`, transition: "all 0.15s" }}>
                                <div style={{ fontSize: 13, fontWeight: 800, color: active ? opt.color : C.gray500 }}>{opt.label}</div>
                                <div style={{ fontSize: 10, color: active ? opt.color : C.gray400, opacity: 0.8 }}>{opt.desc}</div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </Card>
          );
        })}
        {filteredTests.length === 0 && (
          <Card style={{ textAlign: "center", padding: 48, color: C.gray400 }}>
            <div style={{ fontSize: 36, marginBottom: 12 }}>📋</div>
            {tests.length === 0 ? "No tests created yet. Use Create Test to make one." : "No tests match this filter."}
          </Card>
        )}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Manage Students
// ═══════════════════════════════════════════
function ManageStudentsPage({ students, setStudents, streams, courses }) {
  const [search, setSearch] = useState("");
  const [filterStream, setFilterStream] = useState("");
  const [filterCourse, setFilterCourse] = useState("");
  const [filterStatus, setFilterStatus] = useState("");
  const [filterCity, setFilterCity] = useState("");
  const [filterPlan, setFilterPlan] = useState("");
  const [selectedIds, setSelectedIds] = useState(new Set());
  const [expandedId, setExpandedId] = useState(null);
  const [confirmAction, setConfirmAction] = useState(null);
  const [sortBy, setSortBy] = useState("name");
  const [sortDir, setSortDir] = useState("asc");
  const [showPasswords, setShowPasswords] = useState(new Set());
  const [resetConfirm, setResetConfirm] = useState(null);
  const [newPassword, setNewPassword] = useState("");
  const [editingStudent, setEditingStudent] = useState(null);
  const [editStream, setEditStream] = useState("");
  const [editCourse, setEditCourse] = useState("");
  const [resetSuccess, setResetSuccess] = useState(null);
  const [upgradingStudent, setUpgradingStudent] = useState(null);
  const [upgradeForm, setUpgradeForm] = useState({ planName: "", amount: "", expiry: "" });

  // Dynamic options from props
  const streamOptions = streams.map(s => ({ value: s.value, label: s.label }));
  const courseOptions = courses.map(c => ({ value: c.value, label: c.label }));

  // Derived data
  const allCities = [...new Set(students.map(s => s.city))].sort();
  const courseCounts = courses.map(c => ({
    course: c.value, label: c.label,
    count: students.filter(s => s.course === c.value).length,
    active: students.filter(s => s.course === c.value && s.status === "active").length,
  })).filter(c => c.count > 0);
  const streamCounts = streams.map(st => ({
    stream: st.value, label: st.label,
    count: students.filter(s => s.stream === st.value).length,
  })).filter(s => s.count > 0);

  const activeCount = students.filter(s => s.status === "active").length;
  const blockedCount = students.filter(s => s.status === "blocked").length;
  const inactiveCount = students.filter(s => s.status === "inactive").length;
  const primeCount = students.filter(s => s.plan === "prime").length;
  const freeCount = students.filter(s => s.plan === "free" || !s.plan).length;
  const totalRevenue = students.reduce((a, s) => a + (s.amountPaid || 0), 0);

  // Filtering
  const filtered = students.filter(s => {
    if (search && !s.name.toLowerCase().includes(search.toLowerCase()) && !s.email.toLowerCase().includes(search.toLowerCase()) && !s.phone.includes(search) && !(s.username || "").toLowerCase().includes(search.toLowerCase())) return false;
    if (filterStream && s.stream !== filterStream) return false;
    if (filterCourse && s.course !== filterCourse) return false;
    if (filterStatus && s.status !== filterStatus) return false;
    if (filterCity && s.city !== filterCity) return false;
    if (filterPlan && (s.plan || "free") !== filterPlan) return false;
    return true;
  });

  // Sorting
  const sorted = [...filtered].sort((a, b) => {
    let va = a[sortBy], vb = b[sortBy];
    if (typeof va === "string") { va = va.toLowerCase(); vb = (vb||"").toLowerCase(); }
    if (va < vb) return sortDir === "asc" ? -1 : 1;
    if (va > vb) return sortDir === "asc" ? 1 : -1;
    return 0;
  });

  const toggleSort = (col) => { if (sortBy === col) setSortDir(p => p === "asc" ? "desc" : "asc"); else { setSortBy(col); setSortDir("asc"); } };
  const toggleSelect = (id) => setSelectedIds(p => { const n = new Set(p); n.has(id) ? n.delete(id) : n.add(id); return n; });
  const selectAllVisible = () => { const ids = sorted.map(s => s.id); const all = ids.every(id => selectedIds.has(id)); if (all) setSelectedIds(p => { const n = new Set(p); ids.forEach(id => n.delete(id)); return n; }); else setSelectedIds(p => { const n = new Set(p); ids.forEach(id => n.add(id)); return n; }); };

  // Actions
  const handleAction = (type, ids) => {
    setStudents(prev => prev.map(s => {
      if (!ids.includes(s.id)) return s;
      if (type === "block") return { ...s, status: "blocked" };
      if (type === "unblock" || type === "activate") return { ...s, status: "active" };
      if (type === "deactivate") return { ...s, status: "inactive" };
      return s;
    }).filter(s => type === "delete" ? !ids.includes(s.id) : true));
    setSelectedIds(new Set()); setConfirmAction(null); setExpandedId(null);
  };

  // Password reset
  const handleResetPassword = (studentId) => {
    const pw = newPassword.trim() || generatePassword();
    setStudents(prev => prev.map(s => s.id === studentId ? { ...s, password: pw, passwordResetDate: new Date().toISOString().split("T")[0] } : s));
    setResetSuccess({ id: studentId, password: pw });
    setResetConfirm(null); setNewPassword("");
    setTimeout(() => setResetSuccess(null), 8000);
  };

  const generatePassword = () => {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789@#$!";
    let pw = ""; for (let i = 0; i < 10; i++) pw += chars.charAt(Math.floor(Math.random() * chars.length));
    return pw;
  };

  const handleSendResetEmail = (studentId) => {
    const s = students.find(st => st.id === studentId);
    alert(`Password reset link sent to: ${s?.email}\n(In production this would send an actual email)`);
  };

  const toggleShowPassword = (id) => setShowPasswords(p => { const n = new Set(p); n.has(id) ? n.delete(id) : n.add(id); return n; });

  // Inline course/stream edit
  const startEditStudent = (s) => { setEditingStudent(s.id); setEditStream(s.stream); setEditCourse(s.course); };
  const saveEditStudent = (id) => {
    setStudents(prev => prev.map(s => s.id === id ? { ...s, stream: editStream, course: editCourse } : s));
    setEditingStudent(null);
  };

  // Plan upgrade/downgrade
  const handleUpgradeToPrime = (studentId) => {
    const f = upgradeForm;
    if (!f.planName.trim()) return alert("Enter a plan name");
    if (!f.amount || Number(f.amount) <= 0) return alert("Enter a valid amount");
    if (!f.expiry) return alert("Set an expiry date");
    setStudents(prev => prev.map(s => s.id === studentId ? { ...s, plan: "prime", planName: f.planName.trim(), amountPaid: Number(f.amount), planExpiry: f.expiry, planStartDate: new Date().toISOString().split("T")[0] } : s));
    setUpgradingStudent(null); setUpgradeForm({ planName: "", amount: "", expiry: "" });
  };
  const handleDowngradeToFree = (studentId) => {
    setStudents(prev => prev.map(s => s.id === studentId ? { ...s, plan: "free", planName: null, amountPaid: 0, planExpiry: null, planStartDate: null } : s));
  };
  const handleRenewPlan = (studentId) => {
    const s = students.find(st => st.id === studentId);
    if (!s) return;
    setUpgradingStudent(studentId);
    setUpgradeForm({ planName: s.planName || "", amount: String(s.amountPaid || ""), expiry: "" });
  };
  const planBadge = (plan) => plan === "prime"
    ? { label: "⭐ Prime", color: "#d97706", bg: "#fef3c7" }
    : { label: "Free", color: C.gray500, bg: C.gray100 };

  const statusStyle = (st) => ({ active: { color: C.green, bg: C.greenBg, icon: "●" }, blocked: { color: C.red, bg: C.redBg, icon: "⛔" }, inactive: { color: C.gray400, bg: C.gray100, icon: "○" } }[st] || { color: C.gray400, bg: C.gray100, icon: "?" });

  const SortHeader = ({ col, label, align }) => (
    <th onClick={() => toggleSort(col)} style={{ padding: "10px 12px", textAlign: align || "left", fontSize: 10, fontWeight: 700, color: sortBy === col ? C.primary : C.gray400, textTransform: "uppercase", cursor: "pointer", userSelect: "none", whiteSpace: "nowrap" }}>
      {label} {sortBy === col ? (sortDir === "asc" ? "↑" : "↓") : ""}
    </th>
  );

  const DetailField = ({ label, value, icon, color }) => (
    <div>
      <div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>{label}</div>
      <div style={{ fontSize: 13, fontWeight: 600, color: color || C.gray800 }}>{icon ? `${icon} ` : ""}{value}</div>
    </div>
  );

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900 }}>Manage Students</h1>
        <Badge label={`${students.length} total students`} color={C.primary} bg={C.blue50} />
      </div>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 18 }}>View, search, block, reset login, or manage students across all courses</p>

      {/* OVERVIEW STATS */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 12 }}>
        {[
          { label: "Total", value: students.length, color: C.primary, bg: C.blue50, icon: "👥", filter: "" },
          { label: "Active", value: activeCount, color: C.green, bg: C.greenBg, icon: "✓", filter: "active" },
          { label: "Blocked", value: blockedCount, color: C.red, bg: C.redBg, icon: "⛔", filter: "blocked" },
          { label: "Inactive", value: inactiveCount, color: C.gray500, bg: C.gray100, icon: "○", filter: "inactive" },
        ].map(s => (
          <Card key={s.label} onClick={() => setFilterStatus(filterStatus === s.filter ? "" : s.filter)}
            style={{ padding: "14px 16px", cursor: "pointer", border: filterStatus === s.filter && s.filter ? `2px solid ${s.color}` : undefined }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div>
                <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>{s.label}</div>
                <div style={{ fontSize: 26, fontWeight: 800, color: s.color }}>{s.value}</div>
              </div>
              <div style={{ width: 40, height: 40, borderRadius: 10, background: s.bg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18 }}>{s.icon}</div>
            </div>
          </Card>
        ))}
      </div>

      {/* PLAN STATS ROW */}
      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12, marginBottom: 18 }}>
        <Card onClick={() => setFilterPlan(filterPlan === "prime" ? "" : "prime")}
          style={{ padding: "14px 16px", cursor: "pointer", border: filterPlan === "prime" ? "2px solid #d97706" : undefined, background: filterPlan === "prime" ? "#fef3c720" : undefined }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>⭐ Prime Students</div>
              <div style={{ fontSize: 26, fontWeight: 800, color: "#d97706" }}>{primeCount}</div>
            </div>
            <div style={{ width: 40, height: 40, borderRadius: 10, background: "#fef3c7", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>⭐</div>
          </div>
        </Card>
        <Card onClick={() => setFilterPlan(filterPlan === "free" ? "" : "free")}
          style={{ padding: "14px 16px", cursor: "pointer", border: filterPlan === "free" ? `2px solid ${C.gray500}` : undefined }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>Free Students</div>
              <div style={{ fontSize: 26, fontWeight: 800, color: C.gray600 }}>{freeCount}</div>
            </div>
            <div style={{ width: 40, height: 40, borderRadius: 10, background: C.gray100, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>🆓</div>
          </div>
        </Card>
        <Card style={{ padding: "14px 16px" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>Total Revenue</div>
              <div style={{ fontSize: 26, fontWeight: 800, color: C.green }}>₹{totalRevenue.toLocaleString("en-IN")}</div>
            </div>
            <div style={{ width: 40, height: 40, borderRadius: 10, background: C.greenBg, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 20 }}>💰</div>
          </div>
        </Card>
      </div>

      {/* COURSE-WISE (dynamic) */}
      <Card style={{ marginBottom: 16, padding: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>📊 Students by Course</h3>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(150px, 1fr))", gap: 8 }}>
          {courseCounts.map(c => {
            const active = filterCourse === c.course;
            return (
              <div key={c.course} onClick={() => setFilterCourse(active ? "" : c.course)}
                style={{ padding: "10px 12px", borderRadius: 10, cursor: "pointer", transition: "all 0.15s",
                  background: active ? C.primary : C.gray50, color: active ? "#fff" : C.gray800,
                  border: `1.5px solid ${active ? C.primary : C.gray200}` }}>
                <div style={{ fontSize: 22, fontWeight: 800 }}>{c.count}</div>
                <div style={{ fontSize: 12, fontWeight: 600, marginTop: 2 }}>{c.course}</div>
                <div style={{ fontSize: 10, opacity: 0.7, marginTop: 1 }}>{c.active} active</div>
              </div>
            );
          })}
          {courseCounts.length === 0 && <div style={{ fontSize: 13, color: C.gray400, padding: 10 }}>No students enrolled yet</div>}
        </div>
      </Card>

      {/* STREAM-WISE (dynamic) */}
      <Card style={{ marginBottom: 16, padding: 16 }}>
        <h3 style={{ fontSize: 14, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 12 }}>🎓 Students by Stream</h3>
        <div style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
          {streamCounts.map(s => {
            const active = filterStream === s.stream;
            return (
              <div key={s.stream} onClick={() => setFilterStream(active ? "" : s.stream)}
                style={{ display: "flex", alignItems: "center", gap: 8, padding: "8px 14px", borderRadius: 20, cursor: "pointer",
                  background: active ? C.purple : C.white, color: active ? "#fff" : C.gray700,
                  border: `1.5px solid ${active ? C.purple : C.gray200}`, transition: "all 0.15s" }}>
                <span style={{ fontSize: 18, fontWeight: 800 }}>{s.count}</span>
                <span style={{ fontSize: 12, fontWeight: 600 }}>{s.label}</span>
              </div>
            );
          })}
          {streamCounts.length === 0 && <div style={{ fontSize: 13, color: C.gray400, padding: 10 }}>No students enrolled yet</div>}
        </div>
      </Card>

      {/* FILTERS */}
      <Card style={{ padding: 14, marginBottom: 14 }}>
        <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr 1fr 0.8fr 0.8fr", gap: 8, alignItems: "end" }}>
          <Input label="Search (name, email, phone, username)" value={search} onChange={setSearch} placeholder="Search..." style={{ marginBottom: 0 }} />
          <Select label="Stream" value={filterStream} onChange={setFilterStream} options={streamOptions} style={{ marginBottom: 0 }} />
          <Select label="Course" value={filterCourse} onChange={setFilterCourse} options={courseOptions} style={{ marginBottom: 0 }} />
          <Select label="Status" value={filterStatus} onChange={setFilterStatus} options={[{ value: "active", label: "Active" }, { value: "blocked", label: "Blocked" }, { value: "inactive", label: "Inactive" }]} style={{ marginBottom: 0 }} />
          <Select label="Plan" value={filterPlan} onChange={setFilterPlan} options={[{ value: "prime", label: "⭐ Prime" }, { value: "free", label: "🆓 Free" }]} style={{ marginBottom: 0 }} />
          <Select label="City" value={filterCity} onChange={setFilterCity} options={allCities} style={{ marginBottom: 0 }} />
        </div>
        {(search || filterStream || filterCourse || filterStatus || filterCity || filterPlan) && (
          <div style={{ marginTop: 8, display: "flex", gap: 6, alignItems: "center", flexWrap: "wrap" }}>
            <span style={{ fontSize: 12, color: C.gray500 }}>Filters:</span>
            {search && <Badge label={`"${search}"`} color={C.primary} bg={C.blue50} />}
            {filterStream && <Badge label={streams.find(s => s.value === filterStream)?.label || filterStream} color={C.purple} bg={C.purpleBg} />}
            {filterCourse && <Badge label={courses.find(c => c.value === filterCourse)?.label || filterCourse} color={C.orange} bg={C.orangeBg} />}
            {filterStatus && <Badge label={filterStatus} color={filterStatus==="active"?C.green:filterStatus==="blocked"?C.red:C.gray500} bg={filterStatus==="active"?C.greenBg:filterStatus==="blocked"?C.redBg:C.gray100} />}
            {filterPlan && <Badge label={filterPlan === "prime" ? "⭐ Prime" : "🆓 Free"} color={filterPlan === "prime" ? "#d97706" : C.gray500} bg={filterPlan === "prime" ? "#fef3c7" : C.gray100} />}
            {filterCity && <Badge label={filterCity} color={C.gray600} bg={C.gray100} />}
            <button onClick={() => { setSearch(""); setFilterStream(""); setFilterCourse(""); setFilterStatus(""); setFilterCity(""); setFilterPlan(""); }}
              style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.red, fontWeight: 600 }}>✕ Clear all</button>
          </div>
        )}
      </Card>

      {/* BULK ACTIONS */}
      {selectedIds.size > 0 && (
        <Card style={{ padding: "10px 16px", marginBottom: 14, background: C.blue50, border: `1.5px solid ${C.primary}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 14, fontWeight: 700, color: C.primary }}>☑ {selectedIds.size} selected</span>
          <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
            <Btn variant="outline" onClick={() => setConfirmAction({ type: "block", ids: [...selectedIds] })} style={{ fontSize: 11, padding: "5px 12px", color: C.orange, borderColor: C.orange }}>⛔ Block</Btn>
            <Btn variant="outline" onClick={() => setConfirmAction({ type: "unblock", ids: [...selectedIds] })} style={{ fontSize: 11, padding: "5px 12px", color: C.green, borderColor: C.green }}>✓ Unblock</Btn>
            <Btn variant="outline" onClick={() => setConfirmAction({ type: "deactivate", ids: [...selectedIds] })} style={{ fontSize: 11, padding: "5px 12px", color: C.gray500, borderColor: C.gray400 }}>○ Deactivate</Btn>
            <Btn variant="outline" onClick={() => { setStudents(prev => prev.map(s => selectedIds.has(s.id) ? { ...s, plan: "free", planName: null, amountPaid: 0, planExpiry: null, planStartDate: null } : s)); setSelectedIds(new Set()); }}
              style={{ fontSize: 11, padding: "5px 12px", color: C.gray500, borderColor: "#d97706" }}>🆓 Downgrade</Btn>
            <Btn variant="outline" onClick={() => setConfirmAction({ type: "delete", ids: [...selectedIds] })} style={{ fontSize: 11, padding: "5px 12px", color: C.red, borderColor: C.red }}>🗑 Delete</Btn>
            <button onClick={() => setSelectedIds(new Set())} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
          </div>
        </Card>
      )}

      {/* CONFIRM DIALOG */}
      {confirmAction && (
        <Card style={{ padding: "16px 20px", marginBottom: 14, background: confirmAction.type === "delete" ? C.redBg : C.orangeBg, border: `1.5px solid ${confirmAction.type === "delete" ? C.red : C.orange}` }}>
          <div style={{ fontSize: 14, fontWeight: 700, color: confirmAction.type === "delete" ? C.red : C.orange, marginBottom: 8 }}>
            ⚠ Confirm: {confirmAction.type === "delete" ? `Permanently delete ${confirmAction.ids.length} student(s)?` : `${confirmAction.type.charAt(0).toUpperCase() + confirmAction.type.slice(1)} ${confirmAction.ids.length} student(s)?`}
          </div>
          <div style={{ display: "flex", gap: 8 }}>
            <Btn variant={confirmAction.type === "delete" ? "danger" : "primary"} onClick={() => handleAction(confirmAction.type, confirmAction.ids)}
              style={{ fontSize: 12, padding: "6px 16px", background: confirmAction.type === "delete" ? C.red : C.orange }}>Yes, {confirmAction.type}</Btn>
            <Btn variant="outline" onClick={() => setConfirmAction(null)} style={{ fontSize: 12, padding: "6px 16px" }}>Cancel</Btn>
          </div>
        </Card>
      )}

      {/* Password reset success banner */}
      {resetSuccess && (
        <Card style={{ padding: "12px 18px", marginBottom: 14, background: C.greenBg, border: `1.5px solid ${C.green}` }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <div>
              <span style={{ fontSize: 13, fontWeight: 700, color: C.green }}>✓ Password reset for {students.find(s => s.id === resetSuccess.id)?.name}</span>
              <span style={{ fontSize: 13, fontWeight: 600, color: C.gray700, marginLeft: 8 }}>New password: </span>
              <code style={{ background: C.white, padding: "2px 8px", borderRadius: 4, fontSize: 13, fontWeight: 700, color: C.primary, border: `1px solid ${C.gray200}` }}>{resetSuccess.password}</code>
            </div>
            <button onClick={() => { navigator.clipboard?.writeText(resetSuccess.password); }} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600 }}>📋 Copy</button>
          </div>
        </Card>
      )}

      {/* STUDENT TABLE */}
      <Card style={{ padding: 0, overflow: "hidden" }}>
        <div style={{ padding: "12px 16px", borderBottom: `1px solid ${C.gray200}`, display: "flex", justifyContent: "space-between", alignItems: "center", background: C.gray50 }}>
          <span style={{ fontSize: 13, fontWeight: 600, color: C.gray600 }}>Showing {sorted.length} of {students.length} students</span>
        </div>
        <div style={{ overflowX: "auto" }}>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13, minWidth: 1000 }}>
            <thead>
              <tr style={{ background: C.gray50 }}>
                <th style={{ padding: "10px 12px", width: 36 }}>
                  <input type="checkbox" checked={sorted.length > 0 && sorted.every(s => selectedIds.has(s.id))} onChange={selectAllVisible} style={{ accentColor: C.primary, width: 15, height: 15 }} />
                </th>
                <SortHeader col="name" label="Student" />
                <SortHeader col="course" label="Course" />
                <SortHeader col="stream" label="Stream" />
                <SortHeader col="status" label="Status" align="center" />
                <th onClick={() => { setSortBy("plan"); setSortDir(p => sortBy === "plan" ? (p === "asc" ? "desc" : "asc") : "asc"); }}
                  style={{ padding: "10px 12px", textAlign: "center", fontSize: 10, fontWeight: 700, color: sortBy === "plan" ? C.primary : C.gray400, textTransform: "uppercase", cursor: "pointer", userSelect: "none", whiteSpace: "nowrap" }}>
                  Plan {sortBy === "plan" ? (sortDir === "asc" ? "↑" : "↓") : ""}
                </th>
                <SortHeader col="testsAttempted" label="Tests" align="center" />
                <SortHeader col="avgScore" label="Avg %" align="center" />
                <SortHeader col="lastLogin" label="Last Login" />
                <th style={{ padding: "10px 12px", fontSize: 10, fontWeight: 700, color: C.gray400, textTransform: "uppercase", textAlign: "center" }}>Actions</th>
              </tr>
            </thead>
            <tbody>
              {sorted.map(s => {
                const st = statusStyle(s.status);
                const checked = selectedIds.has(s.id);
                const expanded = expandedId === s.id;
                const isEditing = editingStudent === s.id;
                return [
                  <tr key={s.id} style={{ borderBottom: `1px solid ${C.gray100}`, background: checked ? C.blue50 : expanded ? C.gray50 : "transparent", cursor: "pointer", transition: "background 0.1s" }}
                    onClick={() => setExpandedId(expanded ? null : s.id)}>
                    <td style={{ padding: "10px 12px" }} onClick={e => e.stopPropagation()}>
                      <input type="checkbox" checked={checked} onChange={() => toggleSelect(s.id)} style={{ accentColor: C.primary, width: 15, height: 15 }} />
                    </td>
                    <td style={{ padding: "10px 12px" }}>
                      <div style={{ fontWeight: 600, color: C.gray800 }}>{s.name}</div>
                      <div style={{ fontSize: 11, color: C.gray400 }}>{s.email}</div>
                    </td>
                    <td style={{ padding: "10px 12px" }}><Badge label={s.course} color={C.primary} bg={C.blue50} /></td>
                    <td style={{ padding: "10px 12px" }}><Badge label={s.stream} color={C.purple} bg={C.purpleBg} /></td>
                    <td style={{ padding: "10px 12px", textAlign: "center" }}>
                      <span style={{ padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 700, background: st.bg, color: st.color }}>{st.icon} {s.status}</span>
                    </td>
                    <td style={{ padding: "10px 12px", textAlign: "center" }}>
                      {(() => { const pb = planBadge(s.plan || "free"); return <span style={{ padding: "3px 10px", borderRadius: 12, fontSize: 11, fontWeight: 700, background: pb.bg, color: pb.color }}>{pb.label}</span>; })()}
                    </td>
                    <td style={{ padding: "10px 12px", textAlign: "center", fontWeight: 700, color: C.gray700 }}>{s.testsAttempted}</td>
                    <td style={{ padding: "10px 12px", textAlign: "center" }}>
                      <span style={{ fontWeight: 700, color: s.avgScore >= 70 ? C.green : s.avgScore >= 40 ? C.orange : C.red }}>{s.avgScore}%</span>
                    </td>
                    <td style={{ padding: "10px 12px", fontSize: 11, color: C.gray500 }}>
                      {s.lastLogin ? new Date(s.lastLogin).toLocaleDateString("en-IN", { day: "numeric", month: "short" }) + " " + new Date(s.lastLogin).toLocaleTimeString("en-IN", { hour: "2-digit", minute: "2-digit" }) : "Never"}
                    </td>
                    <td style={{ padding: "10px 12px", textAlign: "center" }} onClick={e => e.stopPropagation()}>
                      <div style={{ display: "flex", gap: 4, justifyContent: "center" }}>
                        {s.status === "active" && <button onClick={() => setConfirmAction({ type: "block", ids: [s.id] })} title="Block" style={{ background: "none", border: "none", cursor: "pointer", fontSize: 14 }}>⛔</button>}
                        {s.status === "blocked" && <button onClick={() => handleAction("unblock", [s.id])} title="Unblock" style={{ background: "none", border: "none", cursor: "pointer", fontSize: 14 }}>✅</button>}
                        {s.status === "inactive" && <button onClick={() => handleAction("activate", [s.id])} title="Activate" style={{ background: "none", border: "none", cursor: "pointer", fontSize: 14 }}>▶</button>}
                        <button onClick={() => { setResetConfirm(s.id); setNewPassword(""); }} title="Reset Password" style={{ background: "none", border: "none", cursor: "pointer", fontSize: 14 }}>🔑</button>
                        <button onClick={() => setConfirmAction({ type: "delete", ids: [s.id] })} title="Delete" style={{ background: "none", border: "none", cursor: "pointer", fontSize: 14 }}>🗑</button>
                      </div>
                    </td>
                  </tr>,

                  /* EXPANDED DETAIL ROW */
                  expanded && (
                    <tr key={`${s.id}_detail`} style={{ background: C.gray50, borderBottom: `2px solid ${C.primary}20` }}>
                      <td colSpan="10" style={{ padding: "0" }}>
                        <div style={{ padding: "16px 24px 16px 56px" }}>

                          {/* Row 1: Basic details */}
                          <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 14, marginBottom: 14 }}>
                            <DetailField label="Phone" value={s.phone} />
                            <DetailField label="Gender" value={s.gender} />
                            <DetailField label="City" value={s.city} />
                            <DetailField label="Tests Done" value={s.testsAttempted} />
                            <DetailField label="Member Since" value={new Date(s.joinDate).toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" })} />
                          </div>

                          {/* Row 2: Course & Stream (editable) */}
                          <div style={{ background: C.white, borderRadius: 8, padding: "12px 16px", border: `1px solid ${C.gray200}`, marginBottom: 14 }}>
                            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: isEditing ? 10 : 0 }}>
                              <span style={{ fontSize: 12, fontWeight: 700, color: C.gray600 }}>📚 Course & Stream</span>
                              {!isEditing ? (
                                <button onClick={(e) => { e.stopPropagation(); startEditStudent(s); }} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600 }}>✏️ Edit</button>
                              ) : (
                                <div style={{ display: "flex", gap: 6 }}>
                                  <Btn variant="success" onClick={(e) => { e.stopPropagation(); saveEditStudent(s.id); }} style={{ fontSize: 11, padding: "4px 12px" }}>✓ Save</Btn>
                                  <button onClick={(e) => { e.stopPropagation(); setEditingStudent(null); }} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
                                </div>
                              )}
                            </div>
                            {isEditing ? (
                              <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10 }} onClick={e => e.stopPropagation()}>
                                <Select label="Stream" value={editStream} onChange={setEditStream} options={streamOptions} style={{ marginBottom: 0 }} />
                                <Select label="Course" value={editCourse} onChange={setEditCourse} options={courseOptions} style={{ marginBottom: 0 }} />
                              </div>
                            ) : (
                              <div style={{ display: "flex", gap: 12, marginTop: 6 }}>
                                <div><span style={{ fontSize: 10, color: C.gray400 }}>Stream: </span><Badge label={streams.find(st => st.value === s.stream)?.label || s.stream} color={C.purple} bg={C.purpleBg} /></div>
                                <div><span style={{ fontSize: 10, color: C.gray400 }}>Course: </span><Badge label={courses.find(c => c.value === s.course)?.label || s.course} color={C.primary} bg={C.blue50} /></div>
                              </div>
                            )}
                          </div>

                          {/* Row 3: LOGIN DETAILS */}
                          <div style={{ background: C.white, borderRadius: 8, padding: "12px 16px", border: `1px solid ${C.gray200}`, marginBottom: 14 }}>
                            <div style={{ fontSize: 12, fontWeight: 700, color: C.gray600, marginBottom: 10 }}>🔐 Login Details</div>
                            <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 14 }}>
                              <DetailField label="Username" value={s.username || s.email} />
                              <div>
                                <div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Password</div>
                                <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                                  <code style={{ fontSize: 13, fontWeight: 600, color: C.gray800, background: C.gray100, padding: "2px 8px", borderRadius: 4 }}>
                                    {showPasswords.has(s.id) ? s.password : "••••••••"}
                                  </code>
                                  <button onClick={(e) => { e.stopPropagation(); toggleShowPassword(s.id); }}
                                    style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary }}
                                    title={showPasswords.has(s.id) ? "Hide" : "Show"}>
                                    {showPasswords.has(s.id) ? "🙈" : "👁"}
                                  </button>
                                  <button onClick={(e) => { e.stopPropagation(); navigator.clipboard?.writeText(s.password); }}
                                    style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }} title="Copy">📋</button>
                                </div>
                              </div>
                              <DetailField label="Login Provider" value={s.loginProvider === "google" ? "🔵 Google" : "📧 Email"} />
                              <DetailField label="Last Login" value={s.lastLogin ? new Date(s.lastLogin).toLocaleString("en-IN", { day: "numeric", month: "short", year: "numeric", hour: "2-digit", minute: "2-digit" }) : "Never"} />
                            </div>
                            {s.passwordResetDate && (
                              <div style={{ fontSize: 11, color: C.orange, fontWeight: 600, marginTop: 6 }}>
                                ⚠ Password was last reset on {new Date(s.passwordResetDate).toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" })}
                              </div>
                            )}

                            {/* PASSWORD RESET SECTION */}
                            <div style={{ marginTop: 10, borderTop: `1px solid ${C.gray200}`, paddingTop: 10 }} onClick={e => e.stopPropagation()}>
                              {resetConfirm === s.id ? (
                                <div style={{ background: C.orangeBg, padding: 12, borderRadius: 8, border: `1px solid ${C.orange}40` }}>
                                  <div style={{ fontSize: 13, fontWeight: 700, color: C.orange, marginBottom: 8 }}>🔑 Reset password for {s.name}</div>
                                  <div style={{ display: "flex", gap: 8, alignItems: "end", marginBottom: 8 }}>
                                    <div style={{ flex: 1 }}>
                                      <label style={{ fontSize: 11, fontWeight: 600, color: C.gray600, display: "block", marginBottom: 3 }}>New Password (leave blank for auto-generate)</label>
                                      <input value={newPassword} onChange={e => setNewPassword(e.target.value)} placeholder="Auto-generate if empty"
                                        style={{ width: "100%", padding: "8px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13 }} />
                                    </div>
                                    <Btn variant="primary" onClick={() => handleResetPassword(s.id)} style={{ fontSize: 12, padding: "8px 16px", whiteSpace: "nowrap", background: C.orange }}>🔑 Reset</Btn>
                                    <button onClick={() => setResetConfirm(null)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
                                  </div>
                                  <Btn variant="outline" onClick={() => handleSendResetEmail(s.id)} style={{ fontSize: 11, padding: "5px 12px", color: C.primary, borderColor: C.primary }}>📧 Send Reset Link via Email</Btn>
                                </div>
                              ) : (
                                <div style={{ display: "flex", gap: 8 }}>
                                  <Btn variant="outline" onClick={() => { setResetConfirm(s.id); setNewPassword(""); }} style={{ fontSize: 11, padding: "5px 12px", color: C.orange, borderColor: C.orange }}>🔑 Reset Password</Btn>
                                  <Btn variant="outline" onClick={() => handleSendResetEmail(s.id)} style={{ fontSize: 11, padding: "5px 12px", color: C.primary, borderColor: C.primary }}>📧 Send Reset Link</Btn>
                                  <Btn variant="outline" onClick={() => { navigator.clipboard?.writeText(`Username: ${s.username || s.email}\nPassword: ${s.password}`); alert("Login details copied!"); }}
                                    style={{ fontSize: 11, padding: "5px 12px", color: C.gray600, borderColor: C.gray400 }}>📋 Copy Login Info</Btn>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Row 4: PLAN / SUBSCRIPTION */}
                          <div style={{ background: (s.plan === "prime") ? "#fef3c710" : C.white, borderRadius: 8, padding: "12px 16px", border: `1px solid ${(s.plan === "prime") ? "#d9770630" : C.gray200}`, marginBottom: 14 }} onClick={e => e.stopPropagation()}>
                            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 10 }}>
                              <span style={{ fontSize: 12, fontWeight: 700, color: C.gray600 }}>
                                {(s.plan === "prime") ? "⭐ Prime Subscription" : "🆓 Free Plan"}
                              </span>
                              {(() => { const pb = planBadge(s.plan || "free"); return <span style={{ padding: "4px 12px", borderRadius: 14, fontSize: 12, fontWeight: 800, background: pb.bg, color: pb.color }}>{pb.label}</span>; })()}
                            </div>

                            {(s.plan === "prime") ? (
                              <div>
                                <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 14, marginBottom: 10 }}>
                                  <DetailField label="Plan Name" value={s.planName || "—"} icon="📦" />
                                  <DetailField label="Amount Paid" value={`₹${(s.amountPaid || 0).toLocaleString("en-IN")}`} icon="💰" color={C.green} />
                                  <DetailField label="Started" value={s.planStartDate ? new Date(s.planStartDate).toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" }) : "—"} />
                                  <DetailField label="Expires" value={s.planExpiry ? new Date(s.planExpiry).toLocaleDateString("en-IN", { day: "numeric", month: "short", year: "numeric" }) : "—"}
                                    color={s.planExpiry && new Date(s.planExpiry) < new Date() ? C.red : s.planExpiry && new Date(s.planExpiry) < new Date(Date.now() + 30*86400000) ? C.orange : C.green} />
                                </div>
                                {s.planExpiry && new Date(s.planExpiry) < new Date() && (
                                  <div style={{ padding: "6px 12px", background: C.redBg, borderRadius: 6, border: `1px solid ${C.red}30`, marginBottom: 8, fontSize: 12, fontWeight: 600, color: C.red }}>
                                    ⚠ Plan expired on {new Date(s.planExpiry).toLocaleDateString("en-IN")}! Student now has Free-level access.
                                  </div>
                                )}
                                {s.planExpiry && !isNaN(new Date(s.planExpiry)) && new Date(s.planExpiry) >= new Date() && new Date(s.planExpiry) < new Date(Date.now() + 30*86400000) && (
                                  <div style={{ padding: "6px 12px", background: C.orangeBg, borderRadius: 6, border: `1px solid ${C.orange}30`, marginBottom: 8, fontSize: 12, fontWeight: 600, color: C.orange }}>
                                    ⏳ Plan expiring soon! {Math.ceil((new Date(s.planExpiry) - new Date()) / 86400000)} days remaining.
                                  </div>
                                )}
                                <div style={{ display: "flex", gap: 6 }}>
                                  <Btn variant="outline" onClick={() => handleRenewPlan(s.id)} style={{ fontSize: 11, padding: "5px 12px", color: "#d97706", borderColor: "#d97706" }}>🔄 Renew / Extend</Btn>
                                  <Btn variant="outline" onClick={() => { if (confirm(`Downgrade ${s.name} to Free plan? They will lose access to premium tests.`)) handleDowngradeToFree(s.id); }}
                                    style={{ fontSize: 11, padding: "5px 12px", color: C.gray500, borderColor: C.gray400 }}>🆓 Downgrade to Free</Btn>
                                </div>
                              </div>
                            ) : (
                              <div>
                                <div style={{ fontSize: 12, color: C.gray500, marginBottom: 10 }}>
                                  This student is on the Free plan. They can only access tests marked as <strong>Free access</strong>. Upgrade to Prime for full access to paid test packages.
                                </div>
                                {upgradingStudent !== s.id ? (
                                  <Btn variant="outline" onClick={() => { setUpgradingStudent(s.id); setUpgradeForm({ planName: "", amount: "", expiry: "" }); }}
                                    style={{ fontSize: 11, padding: "5px 14px", color: "#d97706", borderColor: "#d97706", fontWeight: 700 }}>⭐ Upgrade to Prime</Btn>
                                ) : null}
                              </div>
                            )}

                            {/* Upgrade form (shown for both new upgrade and renewal) */}
                            {upgradingStudent === s.id && (
                              <div style={{ marginTop: 10, padding: 12, background: "#fef3c720", borderRadius: 8, border: "1px solid #d9770630" }}>
                                <div style={{ fontSize: 13, fontWeight: 700, color: "#d97706", marginBottom: 10 }}>⭐ {s.plan === "prime" ? "Renew / Extend Plan" : "Upgrade to Prime"}</div>
                                <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1fr", gap: 8, marginBottom: 10 }}>
                                  <div>
                                    <label style={{ fontSize: 11, fontWeight: 600, color: C.gray600, display: "block", marginBottom: 3 }}>Plan Name *</label>
                                    <input value={upgradeForm.planName} onChange={e => setUpgradeForm(p => ({ ...p, planName: e.target.value }))}
                                      placeholder="e.g. CET Full Access" style={{ width: "100%", padding: "7px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 12, boxSizing: "border-box" }} />
                                  </div>
                                  <div>
                                    <label style={{ fontSize: 11, fontWeight: 600, color: C.gray600, display: "block", marginBottom: 3 }}>Amount (₹) *</label>
                                    <input value={upgradeForm.amount} onChange={e => setUpgradeForm(p => ({ ...p, amount: e.target.value }))} type="number"
                                      placeholder="999" style={{ width: "100%", padding: "7px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 12, boxSizing: "border-box" }} />
                                  </div>
                                  <div>
                                    <label style={{ fontSize: 11, fontWeight: 600, color: C.gray600, display: "block", marginBottom: 3 }}>Expiry Date *</label>
                                    <input value={upgradeForm.expiry} onChange={e => setUpgradeForm(p => ({ ...p, expiry: e.target.value }))} type="date"
                                      style={{ width: "100%", padding: "7px 10px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 12, boxSizing: "border-box" }} />
                                  </div>
                                </div>
                                {/* Quick plan presets */}
                                <div style={{ display: "flex", gap: 4, marginBottom: 10, flexWrap: "wrap" }}>
                                  <span style={{ fontSize: 10, color: C.gray400, fontWeight: 600, alignSelf: "center" }}>Quick:</span>
                                  {[
                                    { name: "CET Full Access", amt: 999, months: 6 },
                                    { name: "NEET Pro Bundle", amt: 1499, months: 6 },
                                    { name: "JEE Champion Pack", amt: 1999, months: 8 },
                                    { name: "MBA Complete Pack", amt: 799, months: 4 },
                                    { name: "3 Month Basic", amt: 499, months: 3 },
                                  ].map(p => (
                                    <button key={p.name} onClick={() => {
                                      const exp = new Date(); exp.setMonth(exp.getMonth() + p.months);
                                      setUpgradeForm({ planName: p.name, amount: String(p.amt), expiry: exp.toISOString().split("T")[0] });
                                    }} style={{ padding: "3px 10px", borderRadius: 12, border: `1px solid #d9770640`, background: "#fef3c7", cursor: "pointer", fontSize: 10, fontWeight: 600, color: "#d97706" }}>
                                      {p.name} — ₹{p.amt}/{p.months}mo
                                    </button>
                                  ))}
                                </div>
                                <div style={{ display: "flex", gap: 6 }}>
                                  <Btn variant="primary" onClick={() => handleUpgradeToPrime(s.id)} style={{ fontSize: 12, padding: "7px 18px", background: "#d97706" }}>✓ Confirm {s.plan === "prime" ? "Renewal" : "Upgrade"}</Btn>
                                  <button onClick={() => setUpgradingStudent(null)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.gray500 }}>Cancel</button>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* Row 5: Status Actions */}
                          <div style={{ display: "flex", gap: 8 }}>
                            {s.status !== "blocked" && <Btn variant="outline" onClick={() => setConfirmAction({ type: "block", ids: [s.id] })} style={{ fontSize: 11, padding: "5px 12px", color: C.orange, borderColor: C.orange }}>⛔ Block</Btn>}
                            {s.status === "blocked" && <Btn variant="outline" onClick={() => handleAction("unblock", [s.id])} style={{ fontSize: 11, padding: "5px 12px", color: C.green, borderColor: C.green }}>✅ Unblock</Btn>}
                            {s.status === "active" && <Btn variant="outline" onClick={() => setConfirmAction({ type: "deactivate", ids: [s.id] })} style={{ fontSize: 11, padding: "5px 12px", color: C.gray500, borderColor: C.gray400 }}>○ Deactivate</Btn>}
                            {s.status === "inactive" && <Btn variant="outline" onClick={() => handleAction("activate", [s.id])} style={{ fontSize: 11, padding: "5px 12px", color: C.green, borderColor: C.green }}>▶ Activate</Btn>}
                            <Btn variant="outline" onClick={() => setConfirmAction({ type: "delete", ids: [s.id] })} style={{ fontSize: 11, padding: "5px 12px", color: C.red, borderColor: C.red }}>🗑 Delete</Btn>
                          </div>

                        </div>
                      </td>
                    </tr>
                  )
                ];
              })}
              {sorted.length === 0 && (
                <tr><td colSpan="10" style={{ padding: 40, textAlign: "center", color: C.gray400, fontSize: 14 }}>No students found matching filters</td></tr>
              )}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Student Results
// ═══════════════════════════════════════════
function StudentResultsPage() {
  // Mock data for demo
  const mockAttempts = [
    { id: 1, student: "Rahul Sharma", test: "Mock Test 1 — Full Syllabus", date: "5 Feb 2026", score: 12, total: 15, pct: 80, time: "22m 15s" },
    { id: 2, student: "Priya Patil", test: "Mock Test 1 — Full Syllabus", date: "5 Feb 2026", score: 10, total: 15, pct: 67, time: "28m 40s" },
    { id: 3, student: "Amit Kumar", test: "Mock Test 2 — Physics Focus", date: "6 Feb 2026", score: 35, total: 50, pct: 70, time: "55m 10s" },
    { id: 4, student: "Sneha Desai", test: "Mock Test 1 — Full Syllabus", date: "6 Feb 2026", score: 8, total: 15, pct: 53, time: "25m 00s" },
    { id: 5, student: "Vikram Joshi", test: "Mock Test 2 — Physics Focus", date: "7 Feb 2026", score: 42, total: 50, pct: 84, time: "50m 30s" },
  ];

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Student Results</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 20 }}>All student test attempts and scores</p>

      <Card style={{ padding: 0, overflow: "hidden" }}>
        <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 14 }}>
          <thead>
            <tr style={{ background: C.gray50 }}>
              {["#", "Student", "Test", "Date", "Score", "Percentage", "Time", "Status"].map(h => (
                <th key={h} style={{ padding: "12px 16px", textAlign: h === "Student" || h === "Test" ? "left" : "center", fontSize: 11, fontWeight: 700, color: C.gray400, textTransform: "uppercase" }}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {mockAttempts.map((a, i) => (
              <tr key={a.id} style={{ borderBottom: `1px solid ${C.gray100}` }}>
                <td style={{ padding: "12px 16px", color: C.gray400, textAlign: "center" }}>{i + 1}</td>
                <td style={{ padding: "12px 16px", fontWeight: 600, color: C.gray800 }}>{a.student}</td>
                <td style={{ padding: "12px 16px", color: C.gray600 }}>{a.test}</td>
                <td style={{ padding: "12px 16px", textAlign: "center", color: C.gray500 }}>{a.date}</td>
                <td style={{ padding: "12px 16px", textAlign: "center", fontWeight: 700, color: C.gray800 }}>{a.score}/{a.total}</td>
                <td style={{ padding: "12px 16px", textAlign: "center" }}>
                  <span style={{ padding: "3px 10px", borderRadius: 4, fontSize: 12, fontWeight: 700,
                    background: a.pct >= 70 ? C.greenBg : a.pct >= 40 ? C.orangeBg : C.redBg,
                    color: a.pct >= 70 ? C.green : a.pct >= 40 ? C.orange : C.red }}>{a.pct}%</span>
                </td>
                <td style={{ padding: "12px 16px", textAlign: "center", color: C.gray500 }}>{a.time}</td>
                <td style={{ padding: "12px 16px", textAlign: "center" }}><Badge label="Completed" color={C.green} bg={C.greenBg} /></td>
              </tr>
            ))}
          </tbody>
        </table>
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Settings (Manage Modes, Streams, etc.)
// ═══════════════════════════════════════════
function SettingsPage({ modes, setModes, streams, setStreams, courses, setCourses, colleges, setColleges }) {
  const [newMode, setNewMode] = useState({ value: "", label: "" });
  const [newStream, setNewStream] = useState({ value: "", label: "" });
  const [newCourse, setNewCourse] = useState({ value: "", label: "" });
  const [editingMode, setEditingMode] = useState(null);
  const [editingStream, setEditingStream] = useState(null);
  const [editingCourse, setEditingCourse] = useState(null);
  const [editingCollegeId, setEditingCollegeId] = useState(null);
  const [newCollege, setNewCollege] = useState({ name: "", shortName: "", city: "", color: "#2563eb" });

  const addMode = () => {
    if (!newMode.value.trim() || !newMode.label.trim()) return;
    const val = newMode.value.trim().toLowerCase().replace(/\s+/g, "_");
    if (modes.find(m => m.value === val)) return alert("Mode already exists");
    setModes(prev => [...prev, { value: val, label: newMode.label.trim() }]);
    setNewMode({ value: "", label: "" });
  };

  const addStream = () => {
    if (!newStream.value.trim() || !newStream.label.trim()) return;
    if (streams.find(s => s.value === newStream.value.trim())) return alert("Stream already exists");
    setStreams(prev => [...prev, { value: newStream.value.trim(), label: newStream.label.trim() }]);
    setNewStream({ value: "", label: "" });
  };

  const updateModeLabel = (val, label) => setModes(prev => prev.map(m => m.value === val ? { ...m, label } : m));
  const updateStreamLabel = (val, label) => setStreams(prev => prev.map(s => s.value === val ? { ...s, label } : s));

  const addCourse = () => {
    if (!newCourse.value.trim() || !newCourse.label.trim()) return;
    if (courses.find(c => c.value === newCourse.value.trim())) return alert("Course already exists");
    setCourses(prev => [...prev, { value: newCourse.value.trim(), label: newCourse.label.trim() }]);
    setNewCourse({ value: "", label: "" });
  };
  const updateCourseLabel = (val, label) => setCourses(prev => prev.map(c => c.value === val ? { ...c, label } : c));

  const TagManager = ({ title, subtitle, items, onAdd, onRemove, newItem, setNewItem, editingId, setEditingId, onUpdateLabel, color, valuePlaceholder, labelPlaceholder }) => (
    <Card style={{ marginBottom: 20 }}>
      <div style={{ marginBottom: 16 }}>
        <h3 style={{ fontSize: 16, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 4 }}>{title}</h3>
        <p style={{ fontSize: 13, color: C.gray400, margin: 0 }}>{subtitle}</p>
      </div>

      {/* Existing items */}
      <div style={{ display: "flex", flexDirection: "column", gap: 6, marginBottom: 16 }}>
        {items.map((item, idx) => (
          <div key={item.value} style={{ display: "flex", alignItems: "center", gap: 10, padding: "10px 14px", background: C.gray50, borderRadius: 8, border: `1px solid ${C.gray200}` }}>
            <span style={{ fontSize: 12, fontWeight: 800, color: C.gray400, minWidth: 24 }}>{idx + 1}.</span>
            <span style={{ padding: "3px 10px", borderRadius: 4, fontSize: 11, fontWeight: 700, background: color + "15", color, fontFamily: "monospace" }}>{item.value}</span>
            {editingId === item.value ? (
              <input value={item.label} onChange={e => onUpdateLabel(item.value, e.target.value)} onBlur={() => setEditingId(null)} onKeyDown={e => e.key === "Enter" && setEditingId(null)} autoFocus
                style={{ flex: 1, padding: "6px 10px", borderRadius: 6, border: `1.5px solid ${C.primary}`, fontSize: 13, color: C.gray800 }} />
            ) : (
              <span style={{ flex: 1, fontSize: 14, color: C.gray700, cursor: "pointer" }} onClick={() => setEditingId(item.value)} title="Click to edit">{item.label}</span>
            )}
            <button onClick={() => setEditingId(editingId === item.value ? null : item.value)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600 }}>
              {editingId === item.value ? "✓ Done" : "✎ Edit"}
            </button>
            <button onClick={() => { if (items.length <= 1) return alert("Must have at least 1 item"); onRemove(item.value); }}
              style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.red, fontWeight: 600 }}>✕</button>
          </div>
        ))}
      </div>

      {/* Add new */}
      <div style={{ display: "flex", gap: 8, padding: 14, background: C.blue50, borderRadius: 10, border: `1px dashed ${C.blue100}` }}>
        <input value={newItem.value} onChange={e => setNewItem(p => ({ ...p, value: e.target.value }))} placeholder={valuePlaceholder}
          style={{ flex: 1, padding: "9px 12px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13, background: C.white }} />
        <input value={newItem.label} onChange={e => setNewItem(p => ({ ...p, label: e.target.value }))} placeholder={labelPlaceholder}
          onKeyDown={e => e.key === "Enter" && onAdd()}
          style={{ flex: 2, padding: "9px 12px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13, background: C.white }} />
        <Btn variant="success" onClick={onAdd} style={{ fontSize: 13, padding: "8px 18px", whiteSpace: "nowrap" }}>+ Add</Btn>
      </div>
    </Card>
  );

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Settings</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 24 }}>Manage test modes, streams, courses, and other configuration</p>

      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20, marginBottom: 20 }}>
        <TagManager
          title="Test Modes" subtitle={`${modes.length} modes configured — used in Test Generator`}
          items={modes} onRemove={v => setModes(prev => prev.filter(m => m.value !== v))}
          onAdd={addMode} newItem={newMode} setNewItem={setNewMode}
          editingId={editingMode} setEditingId={setEditingMode} onUpdateLabel={updateModeLabel}
          color={C.primary} valuePlaceholder="Code (e.g. mock)" labelPlaceholder="Display Label (e.g. Mock Test)" />

        <TagManager
          title="Streams" subtitle={`${streams.length} streams — subject groups (PCM, PCB, Law, etc.)`}
          items={streams} onRemove={v => setStreams(prev => prev.filter(s => s.value !== v))}
          onAdd={addStream} newItem={newStream} setNewItem={setNewStream}
          editingId={editingStream} setEditingId={setEditingStream} onUpdateLabel={updateStreamLabel}
          color={C.purple} valuePlaceholder="Code (e.g. NEET)" labelPlaceholder="Display Label (e.g. NEET Medical)" />
      </div>

      <TagManager
        title="📚 Courses / Exams" subtitle={`${courses.length} courses — what students enroll in (CET PCM, JEE, NEET, MBA CET, etc.)`}
        items={courses} onRemove={v => setCourses(prev => prev.filter(c => c.value !== v))}
        onAdd={addCourse} newItem={newCourse} setNewItem={setNewCourse}
        editingId={editingCourse} setEditingId={setEditingCourse} onUpdateLabel={updateCourseLabel}
        color={C.orange} valuePlaceholder="Course code (e.g. NEET)" labelPlaceholder="Display Label (e.g. NEET UG Medical)" />

      {/* Colleges / Institutions */}
      <Card style={{ marginBottom: 20 }}>
        <div style={{ marginBottom: 16 }}>
          <h3 style={{ fontSize: 16, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 4 }}>🏫 Colleges / Institutions</h3>
          <p style={{ fontSize: 13, color: C.gray400, margin: 0 }}>{colleges.length} colleges — each teacher is linked to their institution. Upload a logo for personalized branding.</p>
        </div>

        {/* Existing colleges */}
        <div style={{ display: "flex", flexDirection: "column", gap: 8, marginBottom: 16 }}>
          {colleges.map((col, idx) => {
            const isEditing = editingCollegeId === col.id;
            return (
              <div key={col.id} style={{ display: "flex", alignItems: "center", gap: 12, padding: "12px 16px", background: C.gray50, borderRadius: 10, border: `1px solid ${C.gray200}` }}>
                <span style={{ fontSize: 12, fontWeight: 800, color: C.gray400, minWidth: 24 }}>{idx + 1}.</span>
                {/* Logo preview / upload */}
                <label style={{ cursor: "pointer", flexShrink: 0 }}>
                  {col.logo ? (
                    <img src={col.logo} alt={col.shortName} style={{ width: 40, height: 40, borderRadius: 10, objectFit: "cover", border: `2px solid ${col.color}30` }} />
                  ) : (
                    <div style={{ width: 40, height: 40, borderRadius: 10, background: col.color + "18", border: `2px dashed ${col.color}60`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 14, fontWeight: 800, color: col.color }}>{col.shortName[0]}</div>
                  )}
                  <input type="file" accept="image/*" style={{ display: "none" }} onChange={e => {
                    const file = e.target.files?.[0];
                    if (!file) return;
                    if (file.size > 500000) return alert("Logo must be under 500KB");
                    const reader = new FileReader();
                    reader.onload = ev => setColleges(p => p.map(c => c.id === col.id ? { ...c, logo: ev.target.result } : c));
                    reader.readAsDataURL(file);
                    e.target.value = "";
                  }} />
                </label>
                {isEditing ? (
                  <div style={{ flex: 1, display: "flex", gap: 8, alignItems: "center", flexWrap: "wrap" }}>
                    <input value={col.name} onChange={e => setColleges(p => p.map(c => c.id === col.id ? { ...c, name: e.target.value } : c))} placeholder="Full Name"
                      style={{ flex: 2, minWidth: 150, padding: "6px 10px", borderRadius: 6, border: `1.5px solid ${C.primary}`, fontSize: 13, color: C.gray800 }} />
                    <input value={col.shortName} onChange={e => setColleges(p => p.map(c => c.id === col.id ? { ...c, shortName: e.target.value } : c))} placeholder="Short"
                      style={{ width: 70, padding: "6px 10px", borderRadius: 6, border: `1.5px solid ${C.primary}`, fontSize: 13, color: C.gray800 }} />
                    <input value={col.city} onChange={e => setColleges(p => p.map(c => c.id === col.id ? { ...c, city: e.target.value } : c))} placeholder="City"
                      style={{ width: 100, padding: "6px 10px", borderRadius: 6, border: `1.5px solid ${C.primary}`, fontSize: 13, color: C.gray800 }} />
                    <input type="color" value={col.color} onChange={e => setColleges(p => p.map(c => c.id === col.id ? { ...c, color: e.target.value } : c))}
                      style={{ width: 36, height: 30, border: "none", cursor: "pointer", borderRadius: 4 }} title="Brand color" />
                  </div>
                ) : (
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 600, color: C.gray800, fontSize: 14 }}>{col.name} <span style={{ fontSize: 11, fontWeight: 700, color: col.color, background: col.color + "15", padding: "1px 8px", borderRadius: 4, marginLeft: 4 }}>{col.shortName}</span></div>
                    <div style={{ fontSize: 11, color: C.gray400 }}>📍 {col.city}</div>
                  </div>
                )}
                <button onClick={() => setEditingCollegeId(isEditing ? null : col.id)} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600 }}>
                  {isEditing ? "✓ Done" : "✎ Edit"}
                </button>
                {col.logo && <button onClick={() => setColleges(p => p.map(c => c.id === col.id ? { ...c, logo: null } : c))} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 10, color: C.red, fontWeight: 600 }} title="Remove logo">🗑</button>}
                <button onClick={() => { if (colleges.length <= 1) return alert("Must have at least 1 college"); setColleges(p => p.filter(c => c.id !== col.id)); }}
                  style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.red, fontWeight: 600 }}>✕</button>
              </div>
            );
          })}
        </div>

        {/* Add new college */}
        <div style={{ display: "flex", gap: 8, padding: 14, background: "#f0fdf420", borderRadius: 10, border: `1px dashed ${C.green}60`, alignItems: "center", flexWrap: "wrap" }}>
          <input value={newCollege.name} onChange={e => setNewCollege(p => ({ ...p, name: e.target.value }))} placeholder="College Name"
            style={{ flex: 2, minWidth: 150, padding: "9px 12px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13, background: C.white }} />
          <input value={newCollege.shortName} onChange={e => setNewCollege(p => ({ ...p, shortName: e.target.value }))} placeholder="Short (e.g. FC)"
            style={{ width: 90, padding: "9px 12px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13, background: C.white }} />
          <input value={newCollege.city} onChange={e => setNewCollege(p => ({ ...p, city: e.target.value }))} placeholder="City"
            style={{ width: 100, padding: "9px 12px", borderRadius: 6, border: `1.5px solid ${C.gray200}`, fontSize: 13, background: C.white }} />
          <input type="color" value={newCollege.color} onChange={e => setNewCollege(p => ({ ...p, color: e.target.value }))}
            style={{ width: 36, height: 34, border: "none", cursor: "pointer", borderRadius: 4 }} title="Brand color" />
          <Btn variant="success" onClick={() => {
            if (!newCollege.name.trim() || !newCollege.shortName.trim()) return alert("Name and short name required");
            setColleges(p => [...p, { id: Math.max(0, ...p.map(c => c.id)) + 1, name: newCollege.name.trim(), shortName: newCollege.shortName.trim(), city: newCollege.city.trim(), color: newCollege.color, logo: null }]);
            setNewCollege({ name: "", shortName: "", city: "", color: "#2563eb" });
          }} style={{ fontSize: 13, padding: "8px 18px", whiteSpace: "nowrap" }}>+ Add</Btn>
        </div>
        <p style={{ fontSize: 11, color: C.gray400, marginTop: 8, marginBottom: 0 }}>{"💡 Click a college logo area to upload an image (max 500KB). The logo will appear in the teacher's portal sidebar and dashboard."}</p>
      </Card>

      {/* Info card */}
      <Card style={{ background: C.blue50, border: `1px solid ${C.blue100}`, padding: 18 }}>
        <div style={{ fontSize: 14, fontWeight: 700, color: C.primary, marginBottom: 6 }}>💡 How it works</div>
        <div style={{ fontSize: 13, color: C.gray600, lineHeight: 1.7 }}>
          <strong>Modes</strong> — test types (Combined, Subject-wise, Grand Test, etc.). Used when creating tests.<br/>
          <strong>Streams</strong> — subject groups (PCM, PCB, Law, MBA). Used to categorize tests by subject combination.<br/>
          <strong>Courses</strong> — what students enroll in (CET PCM, JEE, NEET, etc.). Used in student management and test assignment.<br/>
          <strong>Colleges</strong> — institutions linked to teachers. Upload logos for personalized teacher portal branding.<br/><br/>
          All four are <strong>fully dynamic</strong> — add, edit, or remove anytime. Changes reflect instantly across Test Generator, Manage Students, Manage Teachers, and Dashboard.
          The <strong>Code</strong> is a short identifier stored in the database. The <strong>Label</strong> is what admins and students see in the UI.
        </div>
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// ═══════════════════════════════════════════
// LOGIN SCREEN
// ═══════════════════════════════════════════
function LoginScreen({ teachers, colleges, onLogin }) {
  const [role, setRole] = useState("admin");
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [selectedCollegeId, setSelectedCollegeId] = useState(null);

  const selectedCollege = colleges.find(c => c.id === selectedCollegeId) || null;

  const handleLogin = () => {
    if (!username.trim() || !password.trim()) return setError("Enter username and password");
    if (role === "admin") {
      if (username.trim() === ADMIN_USER.username && password === ADMIN_USER.password) {
        onLogin("admin", { ...ADMIN_USER });
      } else { setError("Invalid admin credentials"); }
    } else {
      const t = teachers.find(t => (t.username === username.trim() || t.email === username.trim()) && t.password === password);
      if (t) {
        if (t.status !== "active") return setError("Your account is inactive. Contact admin.");
        onLogin("teacher", t);
      } else { setError("Invalid teacher credentials"); }
    }
  };

  const isTeacherMode = role === "teacher";
  const showCollegePicker = isTeacherMode && !selectedCollegeId;

  // Teachers belonging to selected college (for demo credentials)
  const collegeTeachers = selectedCollegeId ? teachers.filter(t => t.collegeId === selectedCollegeId && t.status === "active") : [];

  return (
    <div style={{ minHeight: "100vh", background: isTeacherMode && selectedCollege ? `linear-gradient(135deg, ${selectedCollege.color}18 0%, ${C.gray900} 40%, ${selectedCollege.color}12 100%)` : `linear-gradient(135deg, ${C.gray900} 0%, #1e293b 50%, ${C.primary}22 100%)`, display: "flex", alignItems: "center", justifyContent: "center", fontFamily: "'DM Sans', sans-serif", transition: "background 0.5s ease" }}>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
      <div style={{ width: showCollegePicker ? 520 : 420, background: C.white, borderRadius: 20, padding: "40px 36px", boxShadow: "0 20px 60px rgba(0,0,0,0.3)", transition: "width 0.3s ease" }}>

        {/* Logo — dynamic per college for teachers */}
        <div style={{ textAlign: "center", marginBottom: 24 }}>
          {isTeacherMode && selectedCollege ? (
            <>
              {selectedCollege.logo ? (
                <img src={selectedCollege.logo} alt={selectedCollege.shortName} style={{ width: 72, height: 72, borderRadius: 16, objectFit: "cover", marginBottom: 10, border: `3px solid ${selectedCollege.color}30` }} />
              ) : (
                <div style={{ width: 72, height: 72, borderRadius: 16, background: `linear-gradient(135deg, ${selectedCollege.color}, ${selectedCollege.color}cc)`, display: "inline-flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 24, fontWeight: 800, marginBottom: 10, border: `3px solid ${selectedCollege.color}30` }}>{selectedCollege.shortName.slice(0, 2)}</div>
              )}
              <h1 style={{ fontSize: 18, fontWeight: 800, color: selectedCollege.color, margin: 0 }}>{selectedCollege.name}</h1>
              <p style={{ fontSize: 12, color: C.gray400, marginTop: 4 }}>📍 {selectedCollege.city} · Teacher Portal</p>
            </>
          ) : (
            <>
              <img src={LOGO_ICON_BASE64} alt="GR Educational Consultancy" style={{ width: 80, height: 80, borderRadius: 20, objectFit: "cover", marginBottom: 14, display: "block", marginLeft: "auto", marginRight: "auto" }} />
              <h2 style={{ fontSize: 15, fontWeight: 700, color: C.primary, margin: 0, letterSpacing: 0.5 }}>GR Educational Consultancy</h2>
              <h1 style={{ fontSize: 20, fontWeight: 800, color: C.gray900, margin: "10px 0 0" }}>{showCollegePicker ? "Select Your College" : "Welcome Back"}</h1>
              <p style={{ fontSize: 13, color: C.gray400, marginTop: 4 }}>{showCollegePicker ? "Choose your institution to continue" : "Login to manage your testing platform"}</p>
            </>
          )}
        </div>

        {/* Role Selector */}
        <div style={{ display: "flex", gap: 8, marginBottom: 24 }}>
          {[
            { value: "admin", label: "Admin", icon: "🛡️", desc: "Full access" },
            { value: "teacher", label: "Teacher", icon: "👨‍🏫", desc: "Question management" },
          ].map(r => {
            const active = role === r.value;
            return (
              <div key={r.value} onClick={() => { setRole(r.value); setError(""); setSelectedCollegeId(null); setUsername(""); setPassword(""); }}
                style={{ flex: 1, padding: "14px 12px", borderRadius: 12, cursor: "pointer", textAlign: "center",
                  background: active ? (r.value === "teacher" && selectedCollege ? selectedCollege.color : C.primary) : C.gray50,
                  color: active ? "#fff" : C.gray600,
                  border: `2px solid ${active ? (r.value === "teacher" && selectedCollege ? selectedCollege.color : C.primary) : C.gray200}`, transition: "all 0.2s" }}>
                <div style={{ fontSize: 24, marginBottom: 4 }}>{r.icon}</div>
                <div style={{ fontSize: 14, fontWeight: 700 }}>{r.label}</div>
                <div style={{ fontSize: 10, opacity: 0.7, marginTop: 2 }}>{r.desc}</div>
              </div>
            );
          })}
        </div>

        {/* College Picker Grid — shown when teacher role selected but no college chosen */}
        {showCollegePicker && (
          <div>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(2, 1fr)", gap: 10, marginBottom: 16 }}>
              {colleges.map(col => {
                const teacherCount = teachers.filter(t => t.collegeId === col.id && t.status === "active").length;
                return (
                  <div key={col.id} onClick={() => setSelectedCollegeId(col.id)}
                    style={{ padding: "18px 14px", borderRadius: 14, cursor: "pointer", border: `2px solid ${col.color}30`, background: `${col.color}06`, transition: "all 0.2s", textAlign: "center" }}
                    onMouseOver={e => { e.currentTarget.style.borderColor = col.color; e.currentTarget.style.background = col.color + "12"; e.currentTarget.style.transform = "translateY(-2px)"; }}
                    onMouseOut={e => { e.currentTarget.style.borderColor = col.color + "30"; e.currentTarget.style.background = col.color + "06"; e.currentTarget.style.transform = "none"; }}>
                    {col.logo ? (
                      <img src={col.logo} alt={col.shortName} style={{ width: 48, height: 48, borderRadius: 12, objectFit: "cover", marginBottom: 8, border: `2px solid ${col.color}25` }} />
                    ) : (
                      <div style={{ width: 48, height: 48, borderRadius: 12, background: `linear-gradient(135deg, ${col.color}, ${col.color}bb)`, display: "inline-flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 16, fontWeight: 800, marginBottom: 8 }}>{col.shortName.slice(0, 2)}</div>
                    )}
                    <div style={{ fontWeight: 700, fontSize: 13, color: col.color }}>{col.name}</div>
                    <div style={{ fontSize: 11, color: C.gray400, marginTop: 2 }}>📍 {col.city}</div>
                    <div style={{ fontSize: 10, color: C.gray500, marginTop: 4, fontWeight: 600 }}>{teacherCount} active teacher{teacherCount !== 1 ? "s" : ""}</div>
                  </div>
                );
              })}
            </div>
            {colleges.length === 0 && (
              <div style={{ textAlign: "center", padding: 24, color: C.gray400, fontSize: 13 }}>No colleges configured. Admin can add them in Settings.</div>
            )}
          </div>
        )}

        {/* Login Form — shown for admin, or for teacher after college selection */}
        {!showCollegePicker && (
          <>
            {/* Back to college picker button for teachers */}
            {isTeacherMode && selectedCollegeId && (
              <button onClick={() => { setSelectedCollegeId(null); setUsername(""); setPassword(""); setError(""); }}
                style={{ display: "flex", alignItems: "center", gap: 6, background: "none", border: "none", cursor: "pointer", fontSize: 12, fontWeight: 600, color: selectedCollege?.color || C.primary, marginBottom: 16, padding: 0 }}>
                ← Change College
              </button>
            )}

            <div style={{ marginBottom: 16 }}>
              <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>Username or Email</label>
              <input value={username} onChange={e => { setUsername(e.target.value); setError(""); }} placeholder={role === "admin" ? "admin" : "teacher username or email"}
                onKeyDown={e => e.key === "Enter" && handleLogin()}
                style={{ width: "100%", padding: "12px 14px", borderRadius: 10, border: `1.5px solid ${error ? C.red : C.gray200}`, fontSize: 14, boxSizing: "border-box", outline: "none" }} />
            </div>
            <div style={{ marginBottom: 20 }}>
              <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 5 }}>Password</label>
              <div style={{ position: "relative" }}>
                <input type={showPassword ? "text" : "password"} value={password} onChange={e => { setPassword(e.target.value); setError(""); }} placeholder="Enter password"
                  onKeyDown={e => e.key === "Enter" && handleLogin()}
                  style={{ width: "100%", padding: "12px 42px 12px 14px", borderRadius: 10, border: `1.5px solid ${error ? C.red : C.gray200}`, fontSize: 14, boxSizing: "border-box", outline: "none" }} />
                <button onClick={() => setShowPassword(!showPassword)} style={{ position: "absolute", right: 10, top: "50%", transform: "translateY(-50%)", background: "none", border: "none", cursor: "pointer", fontSize: 16, color: C.gray400 }}>
                  {showPassword ? "🙈" : "👁"}
                </button>
              </div>
            </div>

            {error && (
              <div style={{ padding: "10px 14px", background: C.redBg, borderRadius: 8, border: `1px solid ${C.red}30`, marginBottom: 16, fontSize: 13, fontWeight: 600, color: C.red }}>⚠ {error}</div>
            )}

            <button onClick={handleLogin}
              style={{ width: "100%", padding: "14px", borderRadius: 12, border: "none", cursor: "pointer",
                background: isTeacherMode && selectedCollege ? `linear-gradient(135deg, ${selectedCollege.color}, ${selectedCollege.color}cc)` : `linear-gradient(135deg, ${C.primary}, ${C.purple})`,
                color: "#fff", fontSize: 15, fontWeight: 700,
                boxShadow: `0 4px 12px ${isTeacherMode && selectedCollege ? selectedCollege.color : C.primary}40` }}>
              Login as {role === "admin" ? "Admin 🛡️" : "Teacher 👨‍🏫"}
            </button>

            {/* Demo credentials */}
            <div style={{ marginTop: 20, padding: "12px 14px", background: C.gray50, borderRadius: 10, border: `1px solid ${C.gray200}` }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: C.gray500, marginBottom: 6, textTransform: "uppercase" }}>Demo Credentials</div>
              {role === "admin" ? (
                <>
                  <div style={{ fontSize: 12, color: C.gray600, lineHeight: 1.8 }}>
                    <strong>Admin:</strong> admin / Admin@123
                  </div>
                  <div style={{ display: "flex", gap: 6, marginTop: 8 }}>
                    <button onClick={() => { setUsername("admin"); setPassword("Admin@123"); }}
                      style={{ flex: 1, padding: "6px", borderRadius: 6, border: `1px solid ${C.primary}40`, background: C.blue50, cursor: "pointer", fontSize: 11, fontWeight: 600, color: C.primary }}>🛡️ Auto-fill Admin</button>
                  </div>
                </>
              ) : (
                <>
                  <div style={{ fontSize: 12, color: C.gray600, lineHeight: 1.8 }}>
                    {collegeTeachers.length > 0 ? collegeTeachers.slice(0, 2).map(t => (
                      <div key={t.id}><strong>{t.name}:</strong> {t.username} / {t.password}</div>
                    )) : <span style={{ color: C.gray400 }}>No active teachers in this college</span>}
                  </div>
                  {collegeTeachers.length > 0 && (
                    <div style={{ display: "flex", gap: 6, marginTop: 8, flexWrap: "wrap" }}>
                      {collegeTeachers.slice(0, 3).map(t => (
                        <button key={t.id} onClick={() => { setUsername(t.username); setPassword(t.password); }}
                          style={{ flex: 1, minWidth: 100, padding: "6px", borderRadius: 6, border: `1px solid ${selectedCollege?.color || C.purple}40`, background: (selectedCollege?.color || C.purple) + "10", cursor: "pointer", fontSize: 10, fontWeight: 600, color: selectedCollege?.color || C.purple, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                          👨‍🏫 {t.name.split(" ")[0]}
                        </button>
                      ))}
                    </div>
                  )}
                </>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: Manage Teachers (Admin only)
// ═══════════════════════════════════════════
function ManageTeachersPage({ teachers, setTeachers, tests, colleges }) {
  const [expandedId, setExpandedId] = useState(null);
  const [showAdd, setShowAdd] = useState(false);
  const [editId, setEditId] = useState(null);
  const [form, setForm] = useState({ name: "", email: "", phone: "", username: "", password: "", subjects: [], assignedTests: [], collegeId: null, permissions: [...ALL_TEACHER_PERM_IDS] });
  const resetForm = () => setForm({ name: "", email: "", phone: "", username: "", password: "", subjects: [], assignedTests: [], collegeId: null, permissions: [...ALL_TEACHER_PERM_IDS] });

  const handleAdd = () => {
    if (!form.name.trim() || !form.username.trim() || !form.password.trim()) return alert("Name, username, and password are required");
    const newT = { id: Math.max(0, ...teachers.map(t => t.id)) + 1, ...form, name: form.name.trim(), email: form.email.trim(), phone: form.phone.trim(), username: form.username.trim(), permissions: [...(form.permissions || [])], status: "active", questionsAdded: 0, lastLogin: null, joinDate: new Date().toISOString().split("T")[0] };
    setTeachers(p => [...p, newT]); resetForm(); setShowAdd(false);
  };
  const handleSaveEdit = (id) => { setTeachers(p => p.map(t => t.id === id ? { ...t, ...form } : t)); setEditId(null); resetForm(); };
  const toggleStatus = (id) => setTeachers(p => p.map(t => t.id === id ? { ...t, status: t.status === "active" ? "inactive" : "active" } : t));
  const deleteTeacher = (id) => { if (confirm("Delete this teacher?")) setTeachers(p => p.filter(t => t.id !== id)); };
  const startEdit = (t) => { setEditId(t.id); setForm({ name: t.name, email: t.email, phone: t.phone, username: t.username, password: t.password, subjects: [...t.subjects], assignedTests: [...t.assignedTests], collegeId: t.collegeId || null, permissions: [...(t.permissions || ALL_TEACHER_PERM_IDS)] }); };

  const activeCount = teachers.filter(t => t.status === "active").length;
  const totalQs = teachers.reduce((a, t) => a + t.questionsAdded, 0);

  return (
    <div>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 4 }}>
        <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900 }}>Manage Teachers</h1>
        <Btn variant="primary" onClick={() => { resetForm(); setShowAdd(!showAdd); }} style={{ fontSize: 13, padding: "8px 18px" }}>{showAdd ? "✕ Cancel" : "＋ Add Teacher"}</Btn>
      </div>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 18 }}>{teachers.length} teachers · {activeCount} active · {totalQs} questions added</p>

      {/* Stats */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 18 }}>
        {[{ label: "Total", value: teachers.length, color: C.primary, icon: "👨‍🏫" }, { label: "Active", value: activeCount, color: C.green, icon: "●" }, { label: "Inactive", value: teachers.length - activeCount, color: C.gray400, icon: "○" }, { label: "Questions", value: totalQs, color: C.purple, icon: "📝" }].map(s => (
          <Card key={s.label} style={{ padding: "14px 16px" }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>{s.label}</div>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 26, fontWeight: 800, color: s.color }}>{s.value}</span><span style={{ fontSize: 22 }}>{s.icon}</span>
            </div>
          </Card>
        ))}
      </div>

      {/* Add form */}
      {showAdd && (
        <Card style={{ marginBottom: 16, border: `2px solid ${C.primary}40` }}>
          <h3 style={{ fontSize: 15, fontWeight: 700, color: C.primary, marginTop: 0, marginBottom: 14 }}>＋ Add New Teacher</h3>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 10 }}>
            <Input label="Full Name *" value={form.name} onChange={v => setForm(p => ({ ...p, name: v }))} placeholder="Prof. Name" />
            <Input label="Email" value={form.email} onChange={v => setForm(p => ({ ...p, email: v }))} placeholder="email@example.com" />
            <Input label="Phone" value={form.phone} onChange={v => setForm(p => ({ ...p, phone: v }))} placeholder="98XXXXXXXX" />
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 14 }}>
            <Input label="Username *" value={form.username} onChange={v => setForm(p => ({ ...p, username: v }))} placeholder="teacher.name" />
            <Input label="Password *" value={form.password} onChange={v => setForm(p => ({ ...p, password: v }))} placeholder="Secure password" />
          </div>
          {/* College select */}
          <div style={{ marginBottom: 14 }}>
            <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>🏫 College / Institution</label>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {colleges.map(col => { const sel = form.collegeId === col.id; return (
                <div key={col.id} onClick={() => setForm(p => ({ ...p, collegeId: sel ? null : col.id }))}
                  style={{ padding: "7px 14px", borderRadius: 10, cursor: "pointer", fontSize: 12, fontWeight: sel ? 700 : 500, background: sel ? col.color : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? col.color : C.gray200}`, display: "flex", alignItems: "center", gap: 6 }}>
                  {col.logo ? <img src={col.logo} alt="" style={{ width: 18, height: 18, borderRadius: 4, objectFit: "cover" }} /> : null}
                  {sel ? "✓ " : ""}{col.shortName} — {col.name}
                </div>
              ); })}
              {colleges.length === 0 && <span style={{ fontSize: 12, color: C.gray400 }}>No colleges — add in Settings</span>}
            </div>
          </div>
          <div style={{ marginBottom: 14 }}>
            <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Subjects</label>
            <div style={{ display: "flex", gap: 6 }}>
              {SUBJECTS.map(sub => { const sel = form.subjects.includes(sub.id); return (
                <div key={sub.id} onClick={() => setForm(p => ({ ...p, subjects: sel ? p.subjects.filter(id => id !== sub.id) : [...p.subjects, sub.id] }))}
                  style={{ padding: "6px 14px", borderRadius: 16, cursor: "pointer", fontSize: 12, fontWeight: sel ? 700 : 500, background: sel ? C.primary : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? C.primary : C.gray200}` }}>{sel ? "✓ " : ""}{sub.name}</div>
              ); })}
            </div>
          </div>
          <div style={{ marginBottom: 14 }}>
            <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Assign Tests</label>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
              {tests.map(t => { const sel = form.assignedTests.includes(t.id); return (
                <div key={t.id} onClick={() => setForm(p => ({ ...p, assignedTests: sel ? p.assignedTests.filter(id => id !== t.id) : [...p.assignedTests, t.id] }))}
                  style={{ padding: "6px 12px", borderRadius: 16, cursor: "pointer", fontSize: 11, fontWeight: sel ? 700 : 500, background: sel ? C.purple : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? C.purple : C.gray200}` }}>{sel ? "✓ " : ""}{t.name.length > 30 ? t.name.slice(0,30)+"…" : t.name}</div>
              ); })}
              {tests.length === 0 && <span style={{ fontSize: 12, color: C.gray400 }}>No tests yet</span>}
            </div>
          </div>
          {/* Permissions */}
          <div style={{ marginBottom: 14 }}>
            <label style={{ display: "block", fontSize: 13, fontWeight: 600, color: C.gray600, marginBottom: 4 }}>🔐 Page Permissions</label>
            <p style={{ fontSize: 11, color: C.gray400, margin: "0 0 8px" }}>Control which pages this teacher can access. Dashboard is always enabled.</p>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 6 }}>
              <div onClick={() => setForm(p => ({ ...p, permissions: p.permissions.length === ALL_TEACHER_PERM_IDS.length ? [] : [...ALL_TEACHER_PERM_IDS] }))}
                style={{ padding: "5px 12px", borderRadius: 14, cursor: "pointer", fontSize: 11, fontWeight: 700, background: form.permissions.length === ALL_TEACHER_PERM_IDS.length ? C.green : C.gray50, color: form.permissions.length === ALL_TEACHER_PERM_IDS.length ? "#fff" : C.gray500, border: `1.5px solid ${form.permissions.length === ALL_TEACHER_PERM_IDS.length ? C.green : C.gray200}` }}>
                {form.permissions.length === ALL_TEACHER_PERM_IDS.length ? "✓ All" : "Select All"}
              </div>
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 6 }}>
              {TEACHER_PERMISSIONS.map(perm => { const sel = form.permissions.includes(perm.id); return (
                <div key={perm.id} onClick={() => setForm(p => ({ ...p, permissions: sel ? p.permissions.filter(id => id !== perm.id) : [...p.permissions, perm.id] }))}
                  style={{ padding: "8px 12px", borderRadius: 10, cursor: "pointer", background: sel ? C.primary + "10" : C.gray50, border: `1.5px solid ${sel ? C.primary : C.gray200}`, display: "flex", alignItems: "center", gap: 8, transition: "all 0.15s" }}>
                  <span style={{ fontSize: 16 }}>{perm.icon}</span>
                  <div>
                    <div style={{ fontSize: 12, fontWeight: sel ? 700 : 500, color: sel ? C.primary : C.gray600 }}>{sel ? "✓ " : ""}{perm.label}</div>
                    <div style={{ fontSize: 10, color: C.gray400 }}>{perm.desc}</div>
                  </div>
                </div>
              ); })}
            </div>
          </div>
          <Btn variant="success" onClick={handleAdd} style={{ padding: "10px 24px" }}>✓ Add Teacher</Btn>
        </Card>
      )}

      {/* Teacher list */}
      <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        {teachers.map(t => {
          const expanded = expandedId === t.id;
          const isEditing = editId === t.id;
          return (
            <Card key={t.id} style={{ padding: 0, overflow: "hidden" }}>
              <div style={{ padding: "16px 20px", display: "flex", justifyContent: "space-between", alignItems: "center", cursor: "pointer", background: expanded ? C.gray50 : "transparent" }}
                onClick={() => setExpandedId(expanded ? null : t.id)}>
                <div style={{ display: "flex", alignItems: "center", gap: 14 }}>
                  <div style={{ width: 42, height: 42, borderRadius: "50%", background: t.status === "active" ? `linear-gradient(135deg, ${C.primary}, ${C.purple})` : C.gray300, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 16, fontWeight: 800 }}>
                    {t.name.split(" ").map(w => w[0]).join("").slice(0, 2)}
                  </div>
                  <div>
                    <div style={{ fontWeight: 700, color: C.gray800, fontSize: 15 }}>{t.name}</div>
                    <div style={{ fontSize: 12, color: C.gray400, display: "flex", alignItems: "center", gap: 6, flexWrap: "wrap" }}>
                      {t.email} · {SUBJECTS.filter(s => t.subjects.includes(s.id)).map(s => s.code).join(", ") || "No subjects"}
                      {(() => { const col = colleges.find(c => c.id === t.collegeId); return col ? (
                        <span style={{ display: "inline-flex", alignItems: "center", gap: 3, padding: "1px 8px", borderRadius: 6, fontSize: 10, fontWeight: 700, background: col.color + "15", color: col.color, border: `1px solid ${col.color}30` }}>
                          {col.logo ? <img src={col.logo} alt="" style={{ width: 12, height: 12, borderRadius: 3, objectFit: "cover" }} /> : "🏫"} {col.shortName}
                        </span>
                      ) : null; })()}
                    </div>
                  </div>
                </div>
                <div style={{ display: "flex", gap: 8, alignItems: "center" }} onClick={e => e.stopPropagation()}>
                  <span style={{ padding: "4px 12px", borderRadius: 12, fontSize: 11, fontWeight: 700, background: t.status === "active" ? C.greenBg : C.gray100, color: t.status === "active" ? C.green : C.gray400 }}>
                    {t.status === "active" ? "● Active" : "○ Inactive"}
                  </span>
                  <Badge label={`${t.questionsAdded} Qs`} color={C.purple} bg={C.purpleBg} />
                  <Badge label={`${t.assignedTests.length} Tests`} color={C.primary} bg={C.blue50} />
                  <Badge label={(t.permissions || []).length === ALL_TEACHER_PERM_IDS.length ? "Full Access" : `${(t.permissions || []).length}/${ALL_TEACHER_PERM_IDS.length} perms`} color={(t.permissions || []).length === ALL_TEACHER_PERM_IDS.length ? C.green : (t.permissions || []).length === 0 ? C.red : "#d97706"} bg={(t.permissions || []).length === ALL_TEACHER_PERM_IDS.length ? C.greenBg : (t.permissions || []).length === 0 ? C.redBg : "#fef3c7"} />
                  <Btn variant="outline" onClick={() => toggleStatus(t.id)} style={{ fontSize: 11, padding: "5px 12px" }}>{t.status === "active" ? "Deactivate" : "Activate"}</Btn>
                </div>
              </div>

              {expanded && (
                <div style={{ borderTop: `1px solid ${C.gray200}`, padding: "16px 20px", background: C.gray50 }}>
                  {!isEditing ? (
                    <div>
                      <div style={{ display: "grid", gridTemplateColumns: "repeat(5, 1fr)", gap: 14, marginBottom: 14 }}>
                        <div><div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Username</div><div style={{ fontSize: 13, fontWeight: 600, color: C.gray800 }}>{t.username}</div></div>
                        <div><div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Password</div><code style={{ fontSize: 12, fontWeight: 600, background: C.gray100, padding: "2px 8px", borderRadius: 4 }}>{t.password}</code></div>
                        <div><div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Phone</div><div style={{ fontSize: 13, fontWeight: 600 }}>{t.phone || "—"}</div></div>
                        <div><div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Last Login</div><div style={{ fontSize: 13, fontWeight: 600 }}>{t.lastLogin ? new Date(t.lastLogin).toLocaleDateString("en-IN", { day: "numeric", month: "short" }) : "Never"}</div></div>
                        <div><div style={{ fontSize: 10, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 3 }}>Joined</div><div style={{ fontSize: 13, fontWeight: 600 }}>{t.joinDate}</div></div>
                      </div>
                      <div style={{ marginBottom: 14 }}>
                        <div style={{ fontSize: 12, fontWeight: 700, color: C.gray600, marginBottom: 6 }}>📚 Subjects</div>
                        <div style={{ display: "flex", gap: 6 }}>{t.subjects.length > 0 ? SUBJECTS.filter(s => t.subjects.includes(s.id)).map(s => <Badge key={s.id} label={s.name} color={C.primary} bg={C.blue50} />) : <span style={{ fontSize: 12, color: C.gray400 }}>None</span>}</div>
                      </div>
                      <div style={{ marginBottom: 14 }}>
                        <div style={{ fontSize: 12, fontWeight: 700, color: C.gray600, marginBottom: 6 }}>🏫 College</div>
                        {(() => { const col = colleges.find(c => c.id === t.collegeId); return col ? (
                          <div style={{ display: "inline-flex", alignItems: "center", gap: 8, padding: "6px 14px", borderRadius: 8, background: col.color + "10", border: `1px solid ${col.color}30` }}>
                            {col.logo ? <img src={col.logo} alt="" style={{ width: 24, height: 24, borderRadius: 6, objectFit: "cover" }} /> : <span style={{ fontSize: 16 }}>🏫</span>}
                            <div><div style={{ fontWeight: 700, fontSize: 13, color: col.color }}>{col.name}</div><div style={{ fontSize: 10, color: C.gray400 }}>📍 {col.city}</div></div>
                          </div>
                        ) : <span style={{ fontSize: 12, color: C.gray400 }}>Not assigned</span>; })()}
                      </div>
                      <div style={{ marginBottom: 14 }}>
                        <div style={{ fontSize: 12, fontWeight: 700, color: C.gray600, marginBottom: 6 }}>📋 Assigned Tests</div>
                        <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>{t.assignedTests.length > 0 ? t.assignedTests.map(tid => { const ts = tests.find(x => x.id === tid); return ts ? <Badge key={tid} label={ts.name} color={C.purple} bg={C.purpleBg} /> : null; }) : <span style={{ fontSize: 12, color: C.gray400 }}>None</span>}</div>
                      </div>
                      {/* Permissions */}
                      <div style={{ marginBottom: 14 }}>
                        <div style={{ fontSize: 12, fontWeight: 700, color: C.gray600, marginBottom: 6 }}>🔐 Page Permissions</div>
                        {(t.permissions || []).length === ALL_TEACHER_PERM_IDS.length ? (
                          <Badge label="✓ Full Access (All Pages)" color={C.green} bg={C.greenBg} />
                        ) : (t.permissions || []).length === 0 ? (
                          <span style={{ fontSize: 12, color: C.red, fontWeight: 600 }}>⚠ Dashboard only (no permissions)</span>
                        ) : (
                          <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                            {TEACHER_PERMISSIONS.filter(p => (t.permissions || []).includes(p.id)).map(p => (
                              <span key={p.id} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "4px 10px", borderRadius: 8, fontSize: 11, fontWeight: 600, background: C.primary + "10", color: C.primary, border: `1px solid ${C.primary}20` }}>
                                {p.icon} {p.label}
                              </span>
                            ))}
                            {TEACHER_PERMISSIONS.filter(p => !(t.permissions || []).includes(p.id)).map(p => (
                              <span key={p.id} style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "4px 10px", borderRadius: 8, fontSize: 11, fontWeight: 600, background: C.gray100, color: C.gray400, border: `1px solid ${C.gray200}`, textDecoration: "line-through" }}>
                                {p.icon} {p.label}
                              </span>
                            ))}
                          </div>
                        )}
                      </div>
                      <div style={{ display: "flex", gap: 8 }}>
                        <Btn variant="outline" onClick={() => startEdit(t)} style={{ fontSize: 11, padding: "5px 14px", color: C.primary }}>✏️ Edit</Btn>
                        <Btn variant="outline" onClick={() => { navigator.clipboard?.writeText(`Username: ${t.username}\nPassword: ${t.password}`); alert("Login copied!"); }} style={{ fontSize: 11, padding: "5px 14px", color: C.gray600 }}>📋 Copy Login</Btn>
                        <Btn variant="danger" onClick={() => deleteTeacher(t.id)} style={{ fontSize: 11, padding: "5px 14px" }}>🗑 Delete</Btn>
                      </div>
                    </div>
                  ) : (
                    <div>
                      <h4 style={{ fontSize: 14, fontWeight: 700, color: C.primary, marginTop: 0, marginBottom: 12 }}>✏️ Edit {t.name}</h4>
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 10 }}>
                        <Input label="Name" value={form.name} onChange={v => setForm(p => ({ ...p, name: v }))} />
                        <Input label="Email" value={form.email} onChange={v => setForm(p => ({ ...p, email: v }))} />
                        <Input label="Phone" value={form.phone} onChange={v => setForm(p => ({ ...p, phone: v }))} />
                      </div>
                      <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 10, marginBottom: 12 }}>
                        <Input label="Username" value={form.username} onChange={v => setForm(p => ({ ...p, username: v }))} />
                        <Input label="Password" value={form.password} onChange={v => setForm(p => ({ ...p, password: v }))} />
                      </div>
                      {/* College select */}
                      <div style={{ marginBottom: 12 }}>
                        <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>🏫 College</label>
                        <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>
                          {colleges.map(col => { const sel = form.collegeId === col.id; return (
                            <div key={col.id} onClick={() => setForm(p => ({ ...p, collegeId: sel ? null : col.id }))}
                              style={{ padding: "5px 12px", borderRadius: 10, cursor: "pointer", fontSize: 11, fontWeight: sel ? 700 : 500, background: sel ? col.color : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? col.color : C.gray200}`, display: "flex", alignItems: "center", gap: 4 }}>
                              {col.logo ? <img src={col.logo} alt="" style={{ width: 14, height: 14, borderRadius: 3, objectFit: "cover" }} /> : null}
                              {sel ? "✓ " : ""}{col.shortName}
                            </div>
                          ); })}
                        </div>
                      </div>
                      <div style={{ marginBottom: 12 }}>
                        <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Subjects</label>
                        <div style={{ display: "flex", gap: 6 }}>{SUBJECTS.map(sub => { const sel = form.subjects.includes(sub.id); return (
                          <div key={sub.id} onClick={() => setForm(p => ({ ...p, subjects: sel ? p.subjects.filter(id => id !== sub.id) : [...p.subjects, sub.id] }))}
                            style={{ padding: "5px 12px", borderRadius: 14, cursor: "pointer", fontSize: 12, fontWeight: sel ? 700 : 500, background: sel ? C.primary : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? C.primary : C.gray200}` }}>{sel ? "✓ " : ""}{sub.code}</div>
                        ); })}</div>
                      </div>
                      <div style={{ marginBottom: 14 }}>
                        <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 6 }}>Tests</label>
                        <div style={{ display: "flex", gap: 5, flexWrap: "wrap" }}>{tests.map(ts => { const sel = form.assignedTests.includes(ts.id); return (
                          <div key={ts.id} onClick={() => setForm(p => ({ ...p, assignedTests: sel ? p.assignedTests.filter(id => id !== ts.id) : [...p.assignedTests, ts.id] }))}
                            style={{ padding: "5px 12px", borderRadius: 14, cursor: "pointer", fontSize: 11, fontWeight: sel ? 700 : 500, background: sel ? C.purple : C.gray50, color: sel ? "#fff" : C.gray600, border: `1.5px solid ${sel ? C.purple : C.gray200}` }}>{sel ? "✓ " : ""}{ts.name.length > 25 ? ts.name.slice(0,25)+"…" : ts.name}</div>
                        ); })}</div>
                      </div>
                      {/* Permissions */}
                      <div style={{ marginBottom: 14 }}>
                        <label style={{ display: "block", fontSize: 12, fontWeight: 600, color: C.gray600, marginBottom: 4 }}>🔐 Page Permissions</label>
                        <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 6 }}>
                          <div onClick={() => setForm(p => ({ ...p, permissions: p.permissions.length === ALL_TEACHER_PERM_IDS.length ? [] : [...ALL_TEACHER_PERM_IDS] }))}
                            style={{ padding: "4px 10px", borderRadius: 12, cursor: "pointer", fontSize: 10, fontWeight: 700, background: form.permissions.length === ALL_TEACHER_PERM_IDS.length ? C.green : C.gray50, color: form.permissions.length === ALL_TEACHER_PERM_IDS.length ? "#fff" : C.gray500, border: `1.5px solid ${form.permissions.length === ALL_TEACHER_PERM_IDS.length ? C.green : C.gray200}` }}>
                            {form.permissions.length === ALL_TEACHER_PERM_IDS.length ? "✓ All" : "Select All"}
                          </div>
                          <div onClick={() => setForm(p => ({ ...p, permissions: [] }))}
                            style={{ padding: "4px 10px", borderRadius: 12, cursor: "pointer", fontSize: 10, fontWeight: 700, background: form.permissions.length === 0 ? C.red : C.gray50, color: form.permissions.length === 0 ? "#fff" : C.gray400, border: `1.5px solid ${form.permissions.length === 0 ? C.red : C.gray200}` }}>
                            None
                          </div>
                        </div>
                        <div style={{ display: "grid", gridTemplateColumns: "repeat(3, 1fr)", gap: 5 }}>
                          {TEACHER_PERMISSIONS.map(perm => { const sel = form.permissions.includes(perm.id); return (
                            <div key={perm.id} onClick={() => setForm(p => ({ ...p, permissions: sel ? p.permissions.filter(id => id !== perm.id) : [...p.permissions, perm.id] }))}
                              style={{ padding: "6px 10px", borderRadius: 8, cursor: "pointer", background: sel ? C.primary + "10" : C.gray50, border: `1.5px solid ${sel ? C.primary : C.gray200}`, display: "flex", alignItems: "center", gap: 6, transition: "all 0.15s" }}>
                              <span style={{ fontSize: 14 }}>{perm.icon}</span>
                              <div style={{ fontSize: 11, fontWeight: sel ? 700 : 500, color: sel ? C.primary : C.gray500 }}>{sel ? "✓ " : ""}{perm.label}</div>
                            </div>
                          ); })}
                        </div>
                      </div>
                      <div style={{ display: "flex", gap: 6 }}>
                        <Btn variant="success" onClick={() => handleSaveEdit(t.id)} style={{ padding: "8px 20px" }}>✓ Save</Btn>
                        <button onClick={() => { setEditId(null); resetForm(); }} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 13, color: C.gray500 }}>Cancel</button>
                      </div>
                    </div>
                  )}
                </div>
              )}
            </Card>
          );
        })}
        {teachers.length === 0 && <Card style={{ textAlign: "center", padding: 48, color: C.gray400 }}><div style={{ fontSize: 36, marginBottom: 12 }}>👨‍🏫</div>No teachers yet.</Card>}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// TEACHER DASHBOARD
// ═══════════════════════════════════════════
function TeacherDashboardPage({ currentUser, questions, tests, setPage, colleges }) {
  const myCreatedTests = tests.filter(t => t.createdBy?.role === "teacher" && t.createdBy?.id === currentUser.id);
  const pendingTests = myCreatedTests.filter(t => t.approvalStatus === "pending");
  const approvedTests = myCreatedTests.filter(t => t.approvalStatus === "approved");
  const rejectedTests = myCreatedTests.filter(t => t.approvalStatus === "rejected");
  const mySubjects = SUBJECTS.filter(s => (currentUser.subjects || []).includes(s.id));
  const myQuestions = questions.filter(q => (currentUser.subjects || []).includes(q.subject_id));
  const myCollege = colleges?.find(c => c.id === currentUser.collegeId);

  return (
    <div>
      {/* College branded header */}
      {myCollege ? (
        <div style={{ display: "flex", alignItems: "center", gap: 16, marginBottom: 18, padding: "16px 20px", borderRadius: 14, background: `linear-gradient(135deg, ${myCollege.color}08, ${myCollege.color}15)`, border: `1.5px solid ${myCollege.color}20` }}>
          {myCollege.logo ? (
            <img src={myCollege.logo} alt={myCollege.shortName} style={{ width: 52, height: 52, borderRadius: 12, objectFit: "cover", border: `2px solid ${myCollege.color}30`, flexShrink: 0 }} />
          ) : (
            <div style={{ width: 52, height: 52, borderRadius: 12, background: myCollege.color, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 18, fontWeight: 800, flexShrink: 0 }}>{myCollege.shortName.slice(0, 2)}</div>
          )}
          <div style={{ flex: 1 }}>
            <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 2 }}>Welcome, {currentUser.name}!</h1>
            <div style={{ fontSize: 13, color: C.gray500 }}>{myCollege.name}{myCollege.city ? ` · 📍 ${myCollege.city}` : ""}</div>
          </div>
          <div style={{ padding: "6px 14px", borderRadius: 10, background: myCollege.color + "15", color: myCollege.color, fontSize: 12, fontWeight: 700, border: `1px solid ${myCollege.color}30`, whiteSpace: "nowrap" }}>🏫 {myCollege.shortName}</div>
        </div>
      ) : (
        <>
          <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>Welcome, {currentUser.name}!</h1>
          <p style={{ color: C.gray500, fontSize: 14, marginBottom: 18 }}>Your teaching dashboard</p>
        </>
      )}

      {/* Row 1: Stats */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 14, marginBottom: 16 }}>
        {[{ label: "My Subjects", value: mySubjects.length, icon: "📚", color: C.primary }, { label: "Questions in Bank", value: myQuestions.length, icon: "❓", color: C.orange }, { label: "Tests Created", value: myCreatedTests.length, icon: "📋", color: C.purple }, { label: "Contributed", value: currentUser.questionsAdded || 0, icon: "✍️", color: C.green }].map(s => (
          <Card key={s.label} style={{ padding: "16px 18px" }}>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div><div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>{s.label}</div><div style={{ fontSize: 28, fontWeight: 800, color: s.color }}>{s.value}</div></div>
              <span style={{ fontSize: 28 }}>{s.icon}</span>
            </div>
          </Card>
        ))}
      </div>

      {/* Row 2: Test Approval Status — only if teacher has create_test or my_tests perm */}
      {myCreatedTests.length > 0 && ((currentUser.permissions || []).includes("create_test") || (currentUser.permissions || []).includes("my_tests")) && (
        <Card style={{ marginBottom: 16 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 14 }}>
            <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, margin: 0 }}>📤 My Test Submissions</h3>
            <button onClick={() => setPage("my-tests")} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: C.primary, fontWeight: 600, display: (currentUser.permissions || []).includes("my_tests") ? "block" : "none" }}>View All →</button>
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 10, marginBottom: 12 }}>
            <div style={{ padding: "12px 14px", borderRadius: 10, background: "#fef3c720", border: "1px solid #d9770630", textAlign: "center" }}>
              <div style={{ fontSize: 24, fontWeight: 800, color: "#d97706" }}>{pendingTests.length}</div>
              <div style={{ fontSize: 11, fontWeight: 600, color: "#d97706" }}>⏳ Pending</div>
            </div>
            <div style={{ padding: "12px 14px", borderRadius: 10, background: C.greenBg, border: `1px solid ${C.green}30`, textAlign: "center" }}>
              <div style={{ fontSize: 24, fontWeight: 800, color: C.green }}>{approvedTests.length}</div>
              <div style={{ fontSize: 11, fontWeight: 600, color: C.green }}>✓ Approved</div>
            </div>
            <div style={{ padding: "12px 14px", borderRadius: 10, background: C.redBg, border: `1px solid ${C.red}30`, textAlign: "center" }}>
              <div style={{ fontSize: 24, fontWeight: 800, color: C.red }}>{rejectedTests.length}</div>
              <div style={{ fontSize: 11, fontWeight: 600, color: C.red }}>✗ Rejected</div>
            </div>
          </div>
          {/* Recent submissions */}
          {myCreatedTests.slice(0, 3).map(t => {
            const sc = t.approvalStatus === "pending" ? { color: "#d97706", bg: "#fef3c7", label: "⏳ Pending" } : t.approvalStatus === "rejected" ? { color: C.red, bg: C.redBg, label: "✗ Rejected" } : { color: C.green, bg: C.greenBg, label: "✓ Approved" };
            return (
              <div key={t.id} style={{ padding: "10px 14px", borderRadius: 8, background: C.gray50, border: `1px solid ${C.gray200}`, marginBottom: 6, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div>
                  <div style={{ fontWeight: 600, color: C.gray800, fontSize: 13 }}>{t.name}</div>
                  <div style={{ fontSize: 11, color: C.gray400 }}>{t.total_questions} Qs · {t.created_at}</div>
                </div>
                <span style={{ padding: "3px 10px", borderRadius: 10, fontSize: 11, fontWeight: 700, background: sc.bg, color: sc.color }}>{sc.label}</span>
              </div>
            );
          })}
        </Card>
      )}

      {/* My Subjects */}
      <Card style={{ marginBottom: 16 }}>
        <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>📚 My Subjects</h3>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(200px, 1fr))", gap: 10 }}>
          {mySubjects.map(sub => {
            const count = questions.filter(q => q.subject_id === sub.id).length;
            return (
              <div key={sub.id} style={{ padding: "14px 16px", borderRadius: 10, background: C.blue50, border: `1px solid ${C.primary}20` }}>
                <div style={{ fontSize: 14, fontWeight: 700, color: C.primary }}>{sub.name}</div>
                <div style={{ fontSize: 12, color: C.gray500, marginTop: 4 }}>{count} questions in bank</div>
              </div>
            );
          })}
          {mySubjects.length === 0 && <div style={{ fontSize: 13, color: C.gray400, padding: 12 }}>No subjects assigned.</div>}
        </div>
      </Card>

      {/* Quick Actions — filtered by permissions */}
      <Card>
        <h3 style={{ fontSize: 15, fontWeight: 700, color: C.gray800, marginTop: 0, marginBottom: 14 }}>⚡ Quick Actions</h3>
        {(() => {
          const perms = currentUser.permissions || [];
          const allActions = [
            { icon: "🧪", label: "Create Test", desc: "Generate & submit", color: "#d97706", page: "generator", perm: "create_test" },
            { icon: "➕", label: "Add Question", desc: "Add manually", color: C.primary, page: "add-question", perm: "add_question" },
            { icon: "📄", label: "Upload CSV", desc: "Bulk upload", color: C.purple, page: "csv-upload", perm: "csv_upload" },
            { icon: "📊", label: "My Tests", desc: "Track submissions", color: C.green, page: "my-tests", perm: "my_tests" },
            { icon: "📚", label: "Question Bank", desc: "Browse questions", color: "#0369a1", page: "questions", perm: "question_bank" },
            { icon: "📈", label: "Results", desc: "Student performance", color: "#7c3aed", page: "results", perm: "view_results" },
          ];
          const available = allActions.filter(a => perms.includes(a.perm));
          if (available.length === 0) return (
            <div style={{ textAlign: "center", padding: 24, color: C.gray400, fontSize: 13 }}>
              <div style={{ fontSize: 32, marginBottom: 8 }}>🔒</div>
              No page permissions assigned. Contact your admin for access.
            </div>
          );
          return (
            <div style={{ display: "grid", gridTemplateColumns: `repeat(${Math.min(available.length, 4)}, 1fr)`, gap: 12 }}>
              {available.map(a => (
                <div key={a.label} onClick={() => setPage(a.page)} style={{ padding: "20px 16px", borderRadius: 12, background: `${a.color}08`, border: `1px solid ${a.color}20`, textAlign: "center", cursor: "pointer" }}>
                  <div style={{ fontSize: 28, marginBottom: 6 }}>{a.icon}</div>
                  <div style={{ fontSize: 13, fontWeight: 700, color: a.color }}>{a.label}</div>
                  <div style={{ fontSize: 11, color: C.gray400, marginTop: 2 }}>{a.desc}</div>
                </div>
              ))}
            </div>
          );
        })()}
      </Card>
    </div>
  );
}

// ═══════════════════════════════════════════
// PAGE: My Tests (Teacher — track submissions)
// ═══════════════════════════════════════════
function MyTestsPage({ tests, currentUser }) {
  const [filterApproval, setFilterApproval] = useState("");
  const myTests = tests.filter(t => t.createdBy?.role === "teacher" && t.createdBy?.id === currentUser.id);
  const filtered = filterApproval ? myTests.filter(t => t.approvalStatus === filterApproval) : myTests;

  const pendingCount = myTests.filter(t => t.approvalStatus === "pending").length;
  const approvedCount = myTests.filter(t => t.approvalStatus === "approved").length;
  const rejectedCount = myTests.filter(t => t.approvalStatus === "rejected").length;

  return (
    <div>
      <h1 style={{ fontSize: 22, fontWeight: 800, color: C.gray900, marginBottom: 4 }}>My Tests</h1>
      <p style={{ color: C.gray500, fontSize: 14, marginBottom: 18 }}>Track your test submissions and approval status</p>

      {/* Stats */}
      <div style={{ display: "grid", gridTemplateColumns: "repeat(4, 1fr)", gap: 12, marginBottom: 18 }}>
        {[
          { label: "Total Created", value: myTests.length, color: C.primary, icon: "📋", filter: "" },
          { label: "Pending Approval", value: pendingCount, color: "#d97706", icon: "⏳", filter: "pending" },
          { label: "Approved", value: approvedCount, color: C.green, icon: "✓", filter: "approved" },
          { label: "Rejected", value: rejectedCount, color: C.red, icon: "✗", filter: "rejected" },
        ].map(s => (
          <Card key={s.label} onClick={() => setFilterApproval(filterApproval === s.filter ? "" : s.filter)}
            style={{ padding: "14px 16px", cursor: "pointer", border: filterApproval === s.filter ? `2px solid ${s.color}` : undefined }}>
            <div style={{ fontSize: 11, fontWeight: 600, color: C.gray400, textTransform: "uppercase", marginBottom: 4 }}>{s.label}</div>
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <span style={{ fontSize: 26, fontWeight: 800, color: s.color }}>{s.value}</span>
              <span style={{ fontSize: 22 }}>{s.icon}</span>
            </div>
          </Card>
        ))}
      </div>

      {/* Test list */}
      <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
        {filtered.map(t => {
          const sc = t.approvalStatus === "pending"
            ? { color: "#d97706", bg: "#fef3c7", label: "⏳ Pending Approval", desc: "Waiting for admin to review" }
            : t.approvalStatus === "rejected"
              ? { color: C.red, bg: C.redBg, label: "✗ Rejected", desc: "Needs changes — see feedback below" }
              : { color: C.green, bg: C.greenBg, label: "✓ Approved & Published", desc: `Status: ${t.status}` };
          return (
            <Card key={t.id} style={{ padding: 0, overflow: "hidden" }}>
              <div style={{ padding: "16px 20px" }}>
                {/* Header */}
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 8 }}>
                  <div>
                    <h3 style={{ fontSize: 16, fontWeight: 700, color: C.gray800, margin: "0 0 4px 0" }}>{t.name}</h3>
                    <div style={{ fontSize: 12, color: C.gray400 }}>
                      {t.total_questions} Qs · {t.duration_minutes} min · {t.stream} · {t.mode} · Created {t.created_at}
                    </div>
                  </div>
                  <span style={{ padding: "5px 14px", borderRadius: 14, fontSize: 12, fontWeight: 700, background: sc.bg, color: sc.color, whiteSpace: "nowrap" }}>
                    {sc.label}
                  </span>
                </div>

                {/* Status description */}
                <div style={{ fontSize: 12, color: sc.color, fontWeight: 600, marginBottom: 8 }}>{sc.desc}</div>

                {/* Test details */}
                <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginBottom: 8 }}>
                  <Badge label={t.is_free ? "FREE" : `₹${t.price}`} color={t.is_free ? C.green : C.orange} bg={t.is_free ? C.greenBg : C.orangeBg} />
                  <Badge label={t.accessLevel === "prime" ? "⭐ Prime" : "🆓 Free Access"} color={t.accessLevel === "prime" ? "#d97706" : C.green} bg={t.accessLevel === "prime" ? "#fef3c7" : C.greenBg} />
                  {SUBJECTS.filter(s => (t.subjects || []).includes(s.id)).map(s => (
                    <Badge key={s.id} label={s.name} color={C.primary} bg={C.blue50} />
                  ))}
                </div>

                {/* Rejection note */}
                {t.approvalStatus === "rejected" && t.approvalNote && (
                  <div style={{ padding: "12px 16px", background: C.redBg, borderRadius: 8, border: `1px solid ${C.red}20`, marginTop: 8 }}>
                    <div style={{ fontSize: 12, fontWeight: 700, color: C.red, marginBottom: 4 }}>📝 Admin Feedback:</div>
                    <div style={{ fontSize: 13, color: C.gray700, lineHeight: 1.5 }}>{t.approvalNote}</div>
                  </div>
                )}

                {/* Pending timeline */}
                {t.approvalStatus === "pending" && (
                  <div style={{ padding: "10px 14px", background: "#fef3c720", borderRadius: 8, border: "1px solid #d9770620", marginTop: 8, display: "flex", alignItems: "center", gap: 10 }}>
                    <span style={{ fontSize: 20 }}>⏳</span>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: "#d97706" }}>Awaiting Admin Review</div>
                      <div style={{ fontSize: 11, color: C.gray500 }}>Submitted on {t.created_at}. You'll see updates here once the admin reviews.</div>
                    </div>
                  </div>
                )}

                {/* Approved info */}
                {t.approvalStatus === "approved" && (
                  <div style={{ padding: "10px 14px", background: C.greenBg, borderRadius: 8, border: `1px solid ${C.green}20`, marginTop: 8, display: "flex", alignItems: "center", gap: 10 }}>
                    <span style={{ fontSize: 20 }}>✓</span>
                    <div>
                      <div style={{ fontSize: 12, fontWeight: 700, color: C.green }}>Published & Live</div>
                      <div style={{ fontSize: 11, color: C.gray500 }}>This test is now available to students. Current status: {t.status}</div>
                    </div>
                  </div>
                )}
              </div>
            </Card>
          );
        })}
        {filtered.length === 0 && (
          <Card style={{ textAlign: "center", padding: 48, color: C.gray400 }}>
            <div style={{ fontSize: 36, marginBottom: 12 }}>{filterApproval ? "🔍" : "📋"}</div>
            {myTests.length === 0 ? "You haven't created any tests yet. Use Create Test to get started!" : "No tests match this filter."}
          </Card>
        )}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════
// MAIN APP — with Login & Role-based Access
// ═══════════════════════════════════════════
export default function AdminPanel() {
  // Auth state
  const [loggedIn, setLoggedIn] = useState(false);
  const [role, setRole] = useState(null); // "admin" | "teacher"
  const [currentUser, setCurrentUser] = useState(null);

  const [page, setPage] = useState("dashboard");
  const [questions, setQuestions] = useState(INITIAL_QUESTIONS);
  const [tests, setTests] = useState(INITIAL_TESTS);
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [teachers, setTeachers] = useState(INITIAL_TEACHERS);
  const [colleges, setColleges] = useState(INITIAL_COLLEGES);

  // Students data (with login details)
  const [students, setStudents] = useState([
    { id: 1, name: "Rahul Sharma", email: "rahul.sharma@gmail.com", phone: "9876543210", stream: "PCM", course: "CET PCM", status: "active", joinDate: "2025-12-10", testsAttempted: 8, avgScore: 72, city: "Pune", gender: "Male", username: "rahul.sharma", password: "Rahul@2025", lastLogin: "2026-02-06 14:30", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "CET Full Access", planExpiry: "2026-06-30", amountPaid: 999, planStartDate: "2025-12-10" },
    { id: 2, name: "Priya Patil", email: "priya.patil@gmail.com", phone: "9876543211", stream: "PCB", course: "CET PCB", status: "active", joinDate: "2025-12-15", testsAttempted: 12, avgScore: 85, city: "Mumbai", gender: "Female", username: "priya.patil", password: "Priya@2025", lastLogin: "2026-02-07 09:15", passwordResetDate: null, loginProvider: "google", plan: "prime", planName: "NEET Pro Bundle", planExpiry: "2026-05-31", amountPaid: 1499, planStartDate: "2025-12-15" },
    { id: 3, name: "Amit Kumar", email: "amit.kumar@yahoo.com", phone: "9876543212", stream: "PCM", course: "JEE", status: "active", joinDate: "2026-01-02", testsAttempted: 15, avgScore: 68, city: "Nagpur", gender: "Male", username: "amit.kumar", password: "Amit@2026", lastLogin: "2026-02-07 11:00", passwordResetDate: "2026-01-20", loginProvider: "email", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 4, name: "Sneha Desai", email: "sneha.d@gmail.com", phone: "9876543213", stream: "PCB", course: "NEET", status: "blocked", joinDate: "2025-11-20", testsAttempted: 5, avgScore: 45, city: "Nashik", gender: "Female", username: "sneha.desai", password: "Sneha@2025", lastLogin: "2026-01-15 18:40", passwordResetDate: null, loginProvider: "email", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 5, name: "Vikram Joshi", email: "vikram.j@outlook.com", phone: "9876543214", stream: "PCM", course: "CET PCM", status: "active", joinDate: "2026-01-10", testsAttempted: 6, avgScore: 91, city: "Pune", gender: "Male", username: "vikram.joshi", password: "Vikram@2026", lastLogin: "2026-02-07 08:00", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "CET Full Access", planExpiry: "2026-07-15", amountPaid: 999, planStartDate: "2026-01-10" },
    { id: 6, name: "Ananya Kulkarni", email: "ananya.k@gmail.com", phone: "9876543215", stream: "Law", course: "Law Entrance", status: "active", joinDate: "2026-01-05", testsAttempted: 4, avgScore: 78, city: "Mumbai", gender: "Female", username: "ananya.k", password: "Ananya@2026", lastLogin: "2026-02-05 16:20", passwordResetDate: null, loginProvider: "google", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 7, name: "Rohan Mehta", email: "rohan.m@gmail.com", phone: "9876543216", stream: "MBA", course: "MBA CET", status: "active", joinDate: "2025-12-28", testsAttempted: 10, avgScore: 62, city: "Thane", gender: "Male", username: "rohan.mehta", password: "Rohan@2025", lastLogin: "2026-02-06 20:10", passwordResetDate: "2026-02-01", loginProvider: "email", plan: "prime", planName: "MBA Complete Pack", planExpiry: "2026-04-30", amountPaid: 799, planStartDate: "2025-12-28" },
    { id: 8, name: "Kavita Rane", email: "kavita.r@gmail.com", phone: "9876543217", stream: "PCB", course: "NEET", status: "active", joinDate: "2026-01-15", testsAttempted: 9, avgScore: 88, city: "Kolhapur", gender: "Female", username: "kavita.rane", password: "Kavita@2026", lastLogin: "2026-02-07 10:30", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "NEET Pro Bundle", planExpiry: "2026-08-15", amountPaid: 1499, planStartDate: "2026-01-15" },
    { id: 9, name: "Sanjay Patil", email: "sanjay.p@yahoo.com", phone: "9876543218", stream: "PCM", course: "JEE", status: "inactive", joinDate: "2025-10-05", testsAttempted: 2, avgScore: 35, city: "Aurangabad", gender: "Male", username: "sanjay.patil", password: "Sanjay@2025", lastLogin: "2025-12-01 12:00", passwordResetDate: null, loginProvider: "email", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 10, name: "Meera Iyer", email: "meera.i@gmail.com", phone: "9876543219", stream: "PCMB", course: "CET PCM", status: "active", joinDate: "2026-01-20", testsAttempted: 3, avgScore: 76, city: "Pune", gender: "Female", username: "meera.iyer", password: "Meera@2026", lastLogin: "2026-02-04 15:45", passwordResetDate: null, loginProvider: "google", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 11, name: "Arjun Nair", email: "arjun.n@gmail.com", phone: "9876543220", stream: "PCB", course: "CET PCB", status: "active", joinDate: "2026-01-08", testsAttempted: 7, avgScore: 81, city: "Mumbai", gender: "Male", username: "arjun.nair", password: "Arjun@2026", lastLogin: "2026-02-06 19:00", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "CET Full Access", planExpiry: "2026-06-30", amountPaid: 999, planStartDate: "2026-01-08" },
    { id: 12, name: "Deepa Tiwari", email: "deepa.t@gmail.com", phone: "9876543221", stream: "Law", course: "Law Entrance", status: "blocked", joinDate: "2025-11-15", testsAttempted: 1, avgScore: 28, city: "Nagpur", gender: "Female", username: "deepa.tiwari", password: "Deepa@2025", lastLogin: "2025-12-20 10:00", passwordResetDate: null, loginProvider: "email", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 13, name: "Karan Singh", email: "karan.s@gmail.com", phone: "9876543222", stream: "PCM", course: "JEE", status: "active", joinDate: "2026-02-01", testsAttempted: 11, avgScore: 74, city: "Pune", gender: "Male", username: "karan.singh", password: "Karan@2026", lastLogin: "2026-02-07 07:30", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "JEE Champion Pack", planExpiry: "2026-09-01", amountPaid: 1999, planStartDate: "2026-02-01" },
    { id: 14, name: "Nisha Gupta", email: "nisha.g@gmail.com", phone: "9876543223", stream: "MBA", course: "MBA CET", status: "active", joinDate: "2025-12-20", testsAttempted: 14, avgScore: 69, city: "Mumbai", gender: "Female", username: "nisha.gupta", password: "Nisha@2025", lastLogin: "2026-02-05 22:10", passwordResetDate: null, loginProvider: "google", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 15, name: "Prasad Kadam", email: "prasad.k@gmail.com", phone: "9876543224", stream: "Pharmacy", course: "B.Pharma", status: "active", joinDate: "2026-01-25", testsAttempted: 5, avgScore: 58, city: "Solapur", gender: "Male", username: "prasad.kadam", password: "Prasad@2026", lastLogin: "2026-02-03 13:00", passwordResetDate: null, loginProvider: "email", plan: "free", planName: null, planExpiry: null, amountPaid: 0, planStartDate: null },
    { id: 16, name: "Ritu Bhosale", email: "ritu.b@gmail.com", phone: "9876543225", stream: "Nursing", course: "B.Sc Nursing", status: "active", joinDate: "2026-01-12", testsAttempted: 6, avgScore: 82, city: "Nashik", gender: "Female", username: "ritu.bhosale", password: "Ritu@2026", lastLogin: "2026-02-06 11:30", passwordResetDate: null, loginProvider: "email", plan: "prime", planName: "Nursing All-in-One", planExpiry: "2026-05-15", amountPaid: 699, planStartDate: "2026-01-12" },
  ]);

  // Dynamic configurable lists
  const [courses, setCourses] = useState([
    { value: "CET PCM", label: "CET PCM (MHT-CET Engineering)" },
    { value: "CET PCB", label: "CET PCB (MHT-CET Medical)" },
    { value: "JEE", label: "JEE Main / Advanced" },
    { value: "NEET", label: "NEET UG (Medical)" },
    { value: "MBA CET", label: "MBA CET / MCA CET" },
    { value: "Law Entrance", label: "Law Entrance (5Y / 3Y LLB)" },
    { value: "B.Pharma", label: "B.Pharmacy Entrance" },
    { value: "B.Sc Nursing", label: "B.Sc Nursing Entrance" },
    { value: "CTET", label: "CTET / State TET" },
    { value: "SSC", label: "SSC / Banking / Railway" },
    { value: "CUET", label: "CUET UG / PG" },
  ]);
  const [modes, setModes] = useState([
    { value: "combined", label: "Combined (Multi-subject)" },
    { value: "subject_wise", label: "Subject-wise (Single Subject)" },
    { value: "chapter_wise", label: "Chapter-wise" },
    { value: "topic_wise", label: "Topic-wise" },
    { value: "previous_year", label: "Previous Year Paper" },
    { value: "mini_test", label: "Mini Test (Quick 10 min)" },
    { value: "sectional", label: "Sectional Test" },
    { value: "grand_test", label: "Grand Test (Full Syllabus)" },
    { value: "practice", label: "Practice / Untimed" },
    { value: "revision", label: "Revision Test" },
    { value: "custom", label: "Custom" },
  ]);
  const [streams, setStreams] = useState([
    { value: "PCM", label: "PCM (Physics, Chemistry, Maths)" },
    { value: "PCB", label: "PCB (Physics, Chemistry, Biology)" },
    { value: "PCMB", label: "PCMB (All Sciences)" },
    { value: "Law", label: "Law (5 Year / 3 Year)" },
    { value: "MBA", label: "MBA / MCA Entrance" },
    { value: "Pharmacy", label: "B.Pharmacy" },
    { value: "Agriculture", label: "B.Sc Agriculture" },
    { value: "Nursing", label: "B.Sc Nursing" },
    { value: "BEd", label: "B.Ed Entrance" },
    { value: "CTET", label: "CTET / TET" },
    { value: "SSC", label: "SSC / Competitive" },
    { value: "General", label: "General (All Streams)" },
  ]);

  // Login handler
  const handleLogin = (r, user) => {
    setRole(r);
    setCurrentUser(user);
    setLoggedIn(true);
    setPage("dashboard");
    // Update teacher lastLogin
    if (r === "teacher") {
      setTeachers(prev => prev.map(t => t.id === user.id ? { ...t, lastLogin: new Date().toISOString().replace("T", " ").slice(0, 16) } : t));
    }
  };

  const handleLogout = () => {
    setLoggedIn(false); setRole(null); setCurrentUser(null); setPage("dashboard");
  };

  // Role-based nav items
  const adminNavItems = [
    { id: "dashboard", label: "Dashboard", icon: SideIcons.dashboard },
    { id: "questions", label: "Question Bank", icon: SideIcons.questions },
    { id: "add-question", label: "Add Question", icon: SideIcons.upload },
    { id: "csv-upload", label: "CSV Upload", icon: SideIcons.upload },
    { id: "generator", label: "Create Test", icon: SideIcons.generate },
    { id: "tests", label: "Manage Tests", icon: SideIcons.tests },
    { id: "students", label: "Manage Students", icon: SideIcons.students },
    { id: "teachers", label: "Manage Teachers", icon: SideIcons.teachers },
    { id: "results", label: "Student Results", icon: SideIcons.results },
    { id: "settings", label: "Settings", icon: SideIcons.settings },
  ];

  const teacherPerms = currentUser?.permissions || [];
  const teacherNavItems = [
    { id: "dashboard", label: "My Dashboard", icon: SideIcons.dashboard }, // always visible
    ...(teacherPerms.includes("create_test") ? [{ id: "generator", label: "Create Test", icon: SideIcons.generate }] : []),
    ...(teacherPerms.includes("my_tests") ? [{ id: "my-tests", label: "My Tests", icon: SideIcons.tests }] : []),
    ...(teacherPerms.includes("question_bank") ? [{ id: "questions", label: "Question Bank", icon: SideIcons.questions }] : []),
    ...(teacherPerms.includes("add_question") ? [{ id: "add-question", label: "Add Question", icon: SideIcons.upload }] : []),
    ...(teacherPerms.includes("csv_upload") ? [{ id: "csv-upload", label: "CSV Upload", icon: SideIcons.upload }] : []),
    ...(teacherPerms.includes("view_results") ? [{ id: "results", label: "Student Results", icon: SideIcons.results }] : []),
  ];

  const navItems = role === "teacher" ? teacherNavItems : adminNavItems;

  const renderPage = () => {
    // Teacher pages
    if (role === "teacher") {
      // Permission-based access control
      const permMap = { "generator": "create_test", "my-tests": "my_tests", "questions": "question_bank", "add-question": "add_question", "csv-upload": "csv_upload", "results": "view_results" };
      const requiredPerm = permMap[page];
      if (requiredPerm && !teacherPerms.includes(requiredPerm)) {
        return (
          <div style={{ textAlign: "center", padding: "60px 20px" }}>
            <div style={{ fontSize: 56, marginBottom: 16 }}>🔒</div>
            <h2 style={{ fontSize: 20, fontWeight: 800, color: C.gray800, marginBottom: 8 }}>Access Restricted</h2>
            <p style={{ fontSize: 14, color: C.gray500, marginBottom: 20, maxWidth: 400, margin: "0 auto 20px" }}>{"You don't have permission to access this page. Please contact your admin to request access."}</p>
            <Btn variant="primary" onClick={() => setPage("dashboard")} style={{ padding: "10px 24px" }}>← Back to Dashboard</Btn>
          </div>
        );
      }
      switch (page) {
        case "dashboard": return <TeacherDashboardPage currentUser={currentUser} questions={questions} tests={tests} setPage={setPage} colleges={colleges} />;
        case "generator": return <TestGeneratorPage questions={questions} tests={tests} setTests={setTests} modes={modes} setModes={setModes} streams={streams} setStreams={setStreams} students={students} courses={courses} role="teacher" currentUser={currentUser} />;
        case "my-tests": return <MyTestsPage tests={tests} currentUser={currentUser} />;
        case "questions": return <QuestionBankPage questions={questions} setQuestions={setQuestions} />;
        case "add-question": return <AddQuestionPage questions={questions} setQuestions={setQuestions} setPage={setPage} />;
        case "csv-upload": return <CSVUploadPage questions={questions} setQuestions={setQuestions} />;
        case "results": return <StudentResultsPage />;
        default: return <TeacherDashboardPage currentUser={currentUser} questions={questions} tests={tests} setPage={setPage} colleges={colleges} />;
      }
    }
    // Admin pages
    switch (page) {
      case "dashboard": return <DashboardPage questions={questions} tests={tests} students={students} streams={streams} courses={courses} setPage={setPage} />;
      case "questions": return <QuestionBankPage questions={questions} setQuestions={setQuestions} />;
      case "add-question": return <AddQuestionPage questions={questions} setQuestions={setQuestions} setPage={setPage} />;
      case "csv-upload": return <CSVUploadPage questions={questions} setQuestions={setQuestions} />;
      case "generator": return <TestGeneratorPage questions={questions} tests={tests} setTests={setTests} modes={modes} setModes={setModes} streams={streams} setStreams={setStreams} students={students} courses={courses} role="admin" currentUser={currentUser} />;
      case "tests": return <ManageTestsPage tests={tests} setTests={setTests} students={students} streams={streams} courses={courses} />;
      case "students": return <ManageStudentsPage students={students} setStudents={setStudents} streams={streams} courses={courses} />;
      case "teachers": return <ManageTeachersPage teachers={teachers} setTeachers={setTeachers} tests={tests} colleges={colleges} />;
      case "results": return <StudentResultsPage />;
      case "settings": return <SettingsPage modes={modes} setModes={setModes} streams={streams} setStreams={setStreams} courses={courses} setCourses={setCourses} colleges={colleges} setColleges={setColleges} />;
      default: return <DashboardPage questions={questions} tests={tests} students={students} streams={streams} courses={courses} setPage={setPage} />;
    }
  };

  // Show login screen if not logged in
  if (!loggedIn) {
    return <LoginScreen teachers={teachers} colleges={colleges} onLogin={handleLogin} />;
  }

  const isTeacher = role === "teacher";
  const teacherCollege = isTeacher && currentUser?.collegeId ? colleges.find(c => c.id === currentUser.collegeId) : null;

  return (
    <>
      <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
      <style>{`
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background:${C.bg}; font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif; }
        button:hover:not(:disabled) { filter:brightness(0.93); }
        ::selection { background:${C.blue100}; color:${C.primary}; }
        ::-webkit-scrollbar { width:6px; }
        ::-webkit-scrollbar-track { background:${C.gray100}; }
        ::-webkit-scrollbar-thumb { background:${C.gray300}; border-radius:3px; }
        input:focus, select:focus, textarea:focus { border-color:${C.primary} !important; box-shadow:0 0 0 3px ${C.blue100}; }
      `}</style>

      <div style={{ display: "flex", minHeight: "100vh" }}>
        {/* Sidebar */}
        <div style={{
          width: sidebarCollapsed ? 64 : 240, background: C.sidebarBg, display: "flex", flexDirection: "column",
          transition: "width 0.25s ease", overflow: "hidden", position: "fixed", top: 0, left: 0, bottom: 0, zIndex: 200,
        }}>
          {/* Logo / Role badge */}
          <div style={{ padding: sidebarCollapsed ? "14px 8px" : "14px 16px", borderBottom: "1px solid rgba(255,255,255,0.08)", display: "flex", alignItems: "center", gap: 10 }}>
            {isTeacher && teacherCollege ? (
              /* Teacher: show college logo */
              teacherCollege.logo ? (
                <img src={teacherCollege.logo} alt={teacherCollege.shortName} style={{ width: sidebarCollapsed ? 32 : 38, height: sidebarCollapsed ? 32 : 38, borderRadius: 10, objectFit: "cover", flexShrink: 0, border: "2px solid rgba(255,255,255,0.15)" }} />
              ) : (
                <div style={{ width: sidebarCollapsed ? 32 : 38, height: sidebarCollapsed ? 32 : 38, borderRadius: 10, background: teacherCollege.color, display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: sidebarCollapsed ? 12 : 14, fontWeight: 800, flexShrink: 0, border: "2px solid rgba(255,255,255,0.15)" }}>{teacherCollege.shortName.slice(0, 2)}</div>
              )
            ) : (
              /* Admin: show GR logo */
              <img src={LOGO_BASE64} alt="GR" style={{ height: sidebarCollapsed ? 28 : 36, objectFit: "contain", flexShrink: 0, filter: "brightness(0) invert(1)" }} />
            )}
            {!sidebarCollapsed && (
              <div style={{ overflow: "hidden", minWidth: 0 }}>
                {isTeacher && teacherCollege ? (
                  <>
                    <div style={{ fontSize: 13, fontWeight: 700, color: "#fff", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{teacherCollege.name}</div>
                    <div style={{ fontSize: 10, color: "rgba(255,255,255,0.45)", marginTop: 1, whiteSpace: "nowrap" }}>👨‍🏫 Teacher Portal · {teacherCollege.shortName}</div>
                  </>
                ) : isTeacher ? (
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.4)", marginTop: 1, whiteSpace: "nowrap" }}>👨‍🏫 Teacher Portal</div>
                ) : (
                  <div style={{ fontSize: 10, color: "rgba(255,255,255,0.4)", marginTop: 1, whiteSpace: "nowrap" }}>🛡️ Admin Panel</div>
                )}
              </div>
            )}
          </div>

          {/* Nav Items */}
          <nav style={{ flex: 1, padding: "12px 8px" }}>
            {navItems.map(item => {
              const active = page === item.id;
              return (
                <button key={item.id} onClick={() => setPage(item.id)}
                  style={{
                    display: "flex", alignItems: "center", gap: 12, width: "100%",
                    padding: "10px 14px", borderRadius: 8, marginBottom: 2,
                    border: "none", cursor: "pointer", fontSize: 14, fontWeight: active ? 600 : 400, transition: "all 0.15s",
                    background: active ? C.sidebarActive : "transparent",
                    color: active ? "#fff" : "rgba(255,255,255,0.55)",
                    justifyContent: sidebarCollapsed ? "center" : "flex-start",
                  }}>
                  <span style={{ flexShrink: 0, display: "flex" }}>{item.icon}</span>
                  {!sidebarCollapsed && <span style={{ whiteSpace: "nowrap" }}>{item.label}</span>}
                </button>
              );
            })}
          </nav>

          {/* Logout + Collapse */}
          <div style={{ padding: "8px 8px 12px", borderTop: "1px solid rgba(255,255,255,0.08)" }}>
            {/* User info (expanded only) */}
            {!sidebarCollapsed && (
              <div style={{ padding: "10px 14px", marginBottom: 4 }}>
                <div style={{ fontSize: 12, fontWeight: 600, color: "rgba(255,255,255,0.7)" }}>{currentUser?.name || "User"}</div>
                <div style={{ fontSize: 10, color: "rgba(255,255,255,0.3)", marginTop: 2 }}>{currentUser?.email || ""}</div>
              </div>
            )}
            {/* Logout button */}
            <button onClick={handleLogout}
              style={{ display: "flex", alignItems: "center", gap: 10, width: "100%", padding: "10px 14px", borderRadius: 8,
                border: "none", cursor: "pointer", background: "rgba(239,68,68,0.15)", color: "#f87171", fontSize: 13, fontWeight: 600,
                justifyContent: sidebarCollapsed ? "center" : "flex-start", marginBottom: 4 }}>
              <span style={{ flexShrink: 0, display: "flex" }}>{SideIcons.logout}</span>
              {!sidebarCollapsed && "Logout"}
            </button>
            {/* Collapse toggle */}
            <button onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
              style={{ display: "flex", alignItems: "center", justifyContent: sidebarCollapsed ? "center" : "flex-start", gap: 10,
                width: "100%", padding: "10px 14px", borderRadius: 8, border: "none", cursor: "pointer",
                background: "transparent", color: "rgba(255,255,255,0.4)", fontSize: 13 }}>
              <span style={{ transform: sidebarCollapsed ? "rotate(180deg)" : "none", transition: "transform 0.2s" }}>◀</span>
              {!sidebarCollapsed && "Collapse"}
            </button>
          </div>
        </div>

        {/* Main Content */}
        <div style={{ flex: 1, marginLeft: sidebarCollapsed ? 64 : 240, transition: "margin-left 0.25s ease" }}>
          {/* Top bar */}
          <div style={{ background: C.white, borderBottom: `1px solid ${C.gray200}`, padding: "14px 28px", display: "flex", justifyContent: "space-between", alignItems: "center", position: "sticky", top: 0, zIndex: 100 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ fontSize: 13, color: C.gray400 }}>
                {navItems.find(n => n.id === page)?.label || "Dashboard"}
              </div>
              {isTeacher && teacherCollege && (
                <span style={{ display: "inline-flex", alignItems: "center", gap: 4, padding: "2px 10px", borderRadius: 8, fontSize: 10, fontWeight: 700, background: teacherCollege.color + "12", color: teacherCollege.color, border: `1px solid ${teacherCollege.color}25` }}>
                  {teacherCollege.logo ? <img src={teacherCollege.logo} alt="" style={{ width: 14, height: 14, borderRadius: 3, objectFit: "cover" }} /> : "🏫"} {teacherCollege.shortName}
                </span>
              )}
              {isTeacher && currentUser?.subjects?.length > 0 && (
                <div style={{ display: "flex", gap: 4 }}>
                  {SUBJECTS.filter(s => currentUser.subjects.includes(s.id)).map(s => (
                    <span key={s.id} style={{ padding: "2px 8px", borderRadius: 8, fontSize: 10, fontWeight: 700, background: C.blue50, color: C.primary }}>{s.code}</span>
                  ))}
                </div>
              )}
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <span style={{ padding: "4px 12px", borderRadius: 14, fontSize: 11, fontWeight: 700,
                background: isTeacher ? C.purpleBg : C.blue50, color: isTeacher ? C.purple : C.primary }}>
                {isTeacher ? "👨‍🏫 Teacher" : "🛡️ Admin"}
              </span>
              {isTeacher && (
                <span style={{ padding: "3px 10px", borderRadius: 12, fontSize: 10, fontWeight: 700,
                  background: teacherPerms.length === ALL_TEACHER_PERM_IDS.length ? C.greenBg : teacherPerms.length === 0 ? C.redBg : "#fef3c7",
                  color: teacherPerms.length === ALL_TEACHER_PERM_IDS.length ? C.green : teacherPerms.length === 0 ? C.red : "#d97706" }}>
                  🔐 {teacherPerms.length === ALL_TEACHER_PERM_IDS.length ? "Full Access" : teacherPerms.length === 0 ? "Restricted" : `${teacherPerms.length}/${ALL_TEACHER_PERM_IDS.length} perms`}
                </span>
              )}
              <span style={{ fontSize: 13, fontWeight: 600, color: C.gray600 }}>{currentUser?.name || "User"}</span>
              <div style={{ width: 32, height: 32, borderRadius: "50%",
                background: isTeacher ? `linear-gradient(135deg, ${C.purple}, #6d28d9)` : `linear-gradient(135deg, ${C.primary}, ${C.purple})`,
                display: "flex", alignItems: "center", justifyContent: "center", color: "#fff", fontSize: 13, fontWeight: 700 }}>
                {(currentUser?.name || "U")[0]}
              </div>
            </div>
          </div>

          {/* Page content */}
          <div style={{ padding: "24px 28px", maxWidth: 1200 }}>
            {renderPage()}
          </div>
        </div>
      </div>
    </>
  );
}
